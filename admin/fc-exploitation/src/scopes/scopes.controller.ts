import { ObjectID } from 'mongodb';
import {
  Controller,
  Get,
  Render,
  UseInterceptors,
  Delete,
  Param,
  Req,
  Res,
  Body,
  Post,
  Patch,
} from '@nestjs/common';
import { Roles } from '../authentication/decorator/roles.decorator';
import { UserRole } from '../user/roles.enum';
import { FormErrorsInterceptor } from '../form/interceptor/form-errors.interceptor';

import { IScopes } from './interface';
import { ScopesService } from './scopes.service';
import { ClaimsService, IClaims } from '../claims';

const ACTION_CREATE = 'creation';
const ACTION_UPDATE = 'update';

@Controller('scopes')
export class ScopesController {
  constructor(
    private readonly scopesService: ScopesService,
    private readonly claimsService: ClaimsService,
  ) {}
  /**
   * Show scope label list
   */
  @Get('label')
  @Roles(UserRole.OPERATOR, UserRole.SECURITY)
  @Render('scopes/label/list')
  async list(@Req() req) {
    // Retrieve scopes
    const scopesAndLabelsList = await this.scopesService.getAll();

    const csrfToken = req.csrfToken();

    const result = {
      scopesAndLabelsList,
      csrfToken,
    };

    // Retrieve claims
    const claimsList = await this.claimsService.getAll();
    Object.assign(result, { claimsList });

    return result;
  }

  /**
   * Show scope labels creation form
   * @param req
   */
  @Get('label/create')
  @Roles(UserRole.OPERATOR)
  @Render('scopes/label/creation')
  async showCreateScopeForm(@Req() req) {
    const csrfToken = req.csrfToken();
    const scopesGroupedByFd = await this.scopesService.getScopesGroupedByFd();

    return { csrfToken, scopesGroupedByFd };
  }

  /**
   * Create new label
   * @param scopeAndLabel
   * @param req
   * @param res
   */
  @Post('label/create')
  @Roles(UserRole.OPERATOR)
  @UseInterceptors(new FormErrorsInterceptor(`/scopes/label/create`))
  async createScopeAndLabels(@Body() scope: IScopes, @Req() req, @Res() res) {
    try {
      await this.scopesService.create(scope, req.user.username);
    } catch (error) {
      req.flash('globalError', "Impossible d'enregistrer le label");
      req.flash('values', scope);

      return res.redirect(`${res.locals.APP_ROOT}/scopes/label/create`);
    }
    req.flash(
      'success',
      `Le label ${scope.label} pour le scope ${scope.scope} a été créé avec succès !`,
    );
    return res.redirect(`${res.locals.APP_ROOT}/scopes/label`);
  }

  /**
   * Show Update form
   * @param req
   */
  @Get('label/update/:id')
  @Roles(UserRole.OPERATOR)
  @Render('scopes/label/update')
  async showUpdateScopeForm(@Param('id') id: string, @Req() req) {
    const idMongo: ObjectID = new ObjectID(id);
    const csrfToken = req.csrfToken();
    const { scope, label, fd } = await this.scopesService.getById(idMongo);
    const scopesGroupedByFd = await this.scopesService.getScopesGroupedByFd();

    return { csrfToken, scope, label, fd, id, scopesGroupedByFd };
  }

  /**
   * Update scope label
   * @param scopeAndLabel
   * @param req
   * @param res
   */
  @Patch('label/update/:id')
  @Roles(UserRole.OPERATOR)
  @UseInterceptors(new FormErrorsInterceptor(`/scopes/label/update/:id`))
  async updateScopeAndLabels(
    @Body() scopeAndLabel: IScopes,
    @Param('id') id: string,
    @Req() req,
    @Res() res,
  ) {
    try {
      const idMongo: ObjectID = new ObjectID(id);
      await this.scopesService.update(
        idMongo,
        req.user.username,
        scopeAndLabel,
      );
    } catch (error) {
      req.flash('globalError', 'Impossible de modifier le label');
      req.flash('values', scopeAndLabel);

      return res.redirect(`${res.locals.APP_ROOT}/scopes/label/update/${id}`);
    }
    req.flash(
      'success',
      `Le label ${scopeAndLabel.label} a été modifié avec succès !`,
    );
    return res.redirect(`${res.locals.APP_ROOT}/scopes/label`);
  }

  @Delete('label/delete/:id')
  @Roles(UserRole.OPERATOR)
  @UseInterceptors(new FormErrorsInterceptor('/scopes/label'))
  async deleteScopeAndLabel(
    @Param('id') id: string,
    @Req() req,
    @Res() res,
    @Body() body,
  ) {
    try {
      const idMongo: ObjectID = new ObjectID(id);
      await this.scopesService.remove(idMongo, req.user.username);
    } catch (error) {
      req.flash('globalError', error.message);
      return res.redirect(`${res.locals.APP_ROOT}/scopes/label`);
    }
    req.flash(
      'success',
      `Le scope ${body.scope}:  ${body.label} a été supprimé avec succès !`,
    );
    return res.redirect(`${res.locals.APP_ROOT}/scopes/label`);
  }

  /**
   * Show claim creation form
   * @param req
   */
  @Get('claim/create')
  @Roles(UserRole.OPERATOR)
  @Render('scopes/claim/form')
  async showNewClaimForm(@Req() req) {
    const csrfToken = req.csrfToken();
    return { csrfToken, action: ACTION_CREATE };
  }

  /**
   * Create new claim
   * @param claim
   * @param req
   * @param res
   */
  @Post('claim/create')
  @Roles(UserRole.OPERATOR)
  @UseInterceptors(new FormErrorsInterceptor(`/scopes/claim/create`))
  async addNewClaim(@Body() body: IClaims, @Req() req, @Res() res) {
    try {
      await this.claimsService.create(body);
    } catch (error) {
      req.flash('globalError', "Impossible d'enregistrer le claim");
      req.flash('values', body);

      return res.redirect(`${res.locals.APP_ROOT}/scopes/label/create`, {
        action: ACTION_CREATE,
      });
    }
    req.flash('success', `Le claim ${body.name} a été créé avec succès !`);
    return res.redirect(`${res.locals.APP_ROOT}/scopes/label`);
  }

  /**
   * Show claim update form
   * @param req
   */
  @Get('claim/update/:id')
  @Roles(UserRole.OPERATOR)
  @Render('scopes/claim/form')
  async showUpdateClaimForm(@Param('id') id: string, @Req() req) {
    const idMongo: ObjectID = new ObjectID(id);
    const csrfToken = req.csrfToken();
    const { name } = await this.claimsService.getById(idMongo);

    return { csrfToken, name, id, action: ACTION_UPDATE };
  }

  /**
   * Update a claim
   * @param claim
   * @param req
   * @param res
   */
  @Patch('claim/update/:id')
  @Roles(UserRole.OPERATOR)
  @UseInterceptors(new FormErrorsInterceptor(`/scopes/claim/update/:id`))
  async updateClaim(
    @Body() body: IClaims,
    @Param('id') id: string,
    @Req() req,
    @Res() res,
  ) {
    try {
      const idMongo: ObjectID = new ObjectID(id);
      await this.claimsService.update(idMongo, body);
    } catch (error) {
      req.flash('globalError', 'Impossible de modifier le claim');
      req.flash('values', body);

      return res.redirect(`${res.locals.APP_ROOT}/scopes/claim/form/${id}`, {
        action: ACTION_UPDATE,
      });
    }
    req.flash('success', `Le claim ${body.name} a été modifié avec succès !`);
    return res.redirect(`${res.locals.APP_ROOT}/scopes/label`);
  }

  /**
   * Remove a claim
   * @param id
   * @param req
   * @param res
   * @param body
   * @returns
   */
  @Delete('claim/delete/:id')
  @Roles(UserRole.OPERATOR)
  @UseInterceptors(new FormErrorsInterceptor('/scopes/label'))
  async removeClaim(
    @Param('id') id: string,
    @Req() req,
    @Res() res,
    @Body() body: IClaims,
  ) {
    try {
      const idMongo: ObjectID = new ObjectID(id);
      await this.claimsService.remove(idMongo);
    } catch (error) {
      req.flash('globalError', error.message);
      return res.redirect(`${res.locals.APP_ROOT}/scopes/label`);
    }
    req.flash('success', `Le claim ${body.name} a été supprimé avec succès !`);
    return res.redirect(`${res.locals.APP_ROOT}/scopes/label`);
  }
}
