import {
  USER_OPERATOR,
  USER_PASS,
} from '../../../../shared/cypress/support/constants';

// Must be in sync with fixture data in `federation`
const dp = {
  title: 'Fournisseur de données Mock - 1',
  client_id: '423dcbdc5a15ece61ed00ff5989d72379c26d9ed4c8e4e05a87cffae019586e0',
  client_secret: '36aa214e7a0043c8da60ae991d8908947147d637137c5bf14bc2fc53e1055847',
}

describe('Update a data provider secret', () => {
  before(() => {
    Cypress.session.clearAllSavedSessions();
    cy.resetEnv('mongo');
  });

  beforeEach(() => {
    cy.resetEnv('mongo');
    cy.login(USER_OPERATOR, USER_PASS);
    cy.visit(`/data-provider?search=${encodeURIComponent(dp.title)}`);

    cy.contains(dp.title).should('be.visible');
    cy.get('a.btn-action-generate-client-secret')
      .click();
  });

  it('Should display the client ID and current client secret', () => {
    cy.get(`input[value="${dp.title}"]`).should('be.visible');
    cy.get(`input[value="${dp.client_id}"]`).should('be.visible');
    cy.get(`input[value="${dp.client_secret}"]`).should('be.visible');
  });

  it('Should not be able to update the secret with a wrong totp', () => {
    cy.totp({ totp: false });

    cy.get('button[type="submit"]').click();
    cy.contains('Confirmer').click();

    cy.contains(`Le TOTP saisi n'est pas valide`).should('be.visible');
  });

  it('Should be able to update the secret with a good totp', () => {
    cy.totp({ totp: true });

    cy.get('button[type="submit"]').click();
    cy.contains('Confirmer').click();

    cy.contains(
      `Le nouveau client secret du fournisseur de données ${dp.title} a été généré avec succès !`,
    ).should('be.visible');
    cy.get('.alert-success > .close').click();
  });
});
