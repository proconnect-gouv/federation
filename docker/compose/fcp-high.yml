version: "3.4"

####################
####################
services:
  stack-fcp-high:
    image: alpine
    depends_on:
      - "core-fcp-high"
      - "exploitation-high"
      - "fsp1v2"
      - "fsp2v2"
      - "fsp3v2"
      - "fsp5v2"
      - "fsp6v2"
      - "fip1v2"
      - "fip2v2"
      - "fip6v2"
      - "fip7v2"
      - "rnipp"
      - "csmr-hsm"
      - "exploit-fcp"

  ####################
  # SP Mocks V2
  ####################

  fsp1v2:
    hostname: fsp1v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "redis-pwd"
      - "broker"
      - "squid"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/client_certs:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/sp.env"
    ports:
      - 9238:9238
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9238 mock-service-provider-high"
      - "VIRTUAL_HOST=fsp1v2.docker.dev-franceconnect.fr"
      - 'REDIRECT_URIS=["https://fsp1v2.docker.dev-franceconnect.fr/oidc-callback/envIssuer"]'
      - 'POST_LOGOUT_REDIRECT_URIS=["https://fsp1v2.docker.dev-franceconnect.fr/logout-callback"]'
      - "CLIENT_ID=6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950"
      - "CLIENT_SECRET=+sqGL4XE6aqzIMOp/DKC1jWB8I+8qE1jW6iz2tUv8lt+ZZzxjyoCBQeuAcJTFZxfLywkn6cAICK5JPLxYM0+8pk/q7CGHUfr/gzr3ZYRroWWE+egEEDxqRYDYe0="
      # Set OIDC library debugging mode: https://www.npmjs.com/package/oidc-provider#debugging
      - "DEBUG=oidc-provider:*"
      # Arbitrary DB number, default is 0 and is used by legacy core.
      - "FC_REDIS_DB=4"
      # Logger
      - "EVT_LOG_FILE=/var/log/app/fsp1v2.log"
      - "FQDN=fsp1v2.docker.dev-franceconnect.fr"
      # OidcClient
      - "OidcClient_ACR=eidas2"
      - "OidcClient_SCOPE=openid profile gender birthdate birthcountry birthplace given_name family_name email preferred_username address phone birth identite_pivot"
    networks:
      - public
      - data
    command: "pm2 logs"

  fsp2v2:
    hostname: fsp2v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "redis-pwd"
      - "broker"
      - "squid"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/client_certs:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/sp.env"
    ports:
      - 9239:9239
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9239 mock-service-provider-high"
      - "VIRTUAL_HOST=fsp2v2.docker.dev-franceconnect.fr"
      - 'REDIRECT_URIS=["https://fsp2v2.docker.dev-franceconnect.fr/oidc-callback/envIssuer"]'
      - 'POST_LOGOUT_REDIRECT_URIS=["https://fsp2v2.docker.dev-franceconnect.fr/logout-callback"]'
      - "CLIENT_ID=7a79e45107f9ccc6a3a5971d501220dc4fd9e87bb5e3fc62ce4104c756e22775"
      - "CLIENT_SECRET=+sqGL4XE6aqzIMOp/DKC1jWB8I+8qE1jW6iz2tUv8lt+ZZzxjyoCBQeuAcJTFZxfLywkn6cAICK5JPLxYM0+8pk/q7CGHUfr/gzr3ZYRroWWE+egEEDxqRYDYe0="
      - "FC_REDIS_DB=6"
      # Logger
      - "EVT_LOG_FILE=/var/log/app/fsp2v2.log"
      # OidcProvider
      - "FQDN=fsp2v2.docker.dev-franceconnect.fr"
      # OidcClient
      - "OidcClient_ACR=eidas2"
      - "OidcClient_SCOPE=openid profile gender birthdate birthcountry birthplace given_name family_name email preferred_username address phone birth identite_pivot"
    networks:
      - public
      - data
    command: "pm2 logs"

  fsp3v2:
    hostname: fsp3v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "redis-pwd"
      - "broker"
      - "squid"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/client_certs:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/sp.env"
    ports:
      - 9240:9240
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9240 mock-service-provider-high"
      - "VIRTUAL_HOST=fsp3v2.docker.dev-franceconnect.fr"
      - 'REDIRECT_URIS=["https://fsp3v2.docker.dev-franceconnect.fr/oidc-callback/envIssuer"]'
      - 'POST_LOGOUT_REDIRECT_URIS=["https://fsp3v2.docker.dev-franceconnect.fr/logout-callback"]'
      - "CLIENT_ID=my-service-provider-deactivated"
      - "CLIENT_SECRET=+sqGL4XE6aqzIMOp/DKC1jWB8I+8qE1jW6iz2tUv8lt+ZZzxjyoCBQeuAcJTFZxfLywkn6cAICK5JPLxYM0+8pk/q7CGHUfr/gzr3ZYRroWWE+egEEDxqRYDYe0="
      # Arbitrary DB number, default is 0 and is used by legacy core.
      - "FC_REDIS_DB=8"
      # Logger
      - "EVT_LOG_FILE=/var/log/app/fsp3v2.log"
      # OidcProvider
      - "FQDN=fsp3v2.docker.dev-franceconnect.fr"
      # OidcClient
      - "OidcClient_ACR=eidas2"
      - "OidcClient_SCOPE=openid profile gender birthdate birthcountry birthplace given_name family_name email preferred_username address phone birth identite_pivot"
    networks:
      - public
      - data
    command: "pm2 logs"

  fsp5v2:
    hostname: fsp5v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "redis-pwd"
      - "broker"
      - "squid"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/client_certs:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/sp.env"
    ports:
      - 9249:9249
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9249 mock-service-provider-high"
      - "VIRTUAL_HOST=fsp5v2.docker.dev-franceconnect.fr"
      - 'REDIRECT_URIS=["https://fsp5v2.docker.dev-franceconnect.fr/oidc-callback/envIssuer"]'
      - 'POST_LOGOUT_REDIRECT_URIS=["https://fsp5v2.docker.dev-franceconnect.fr/logout-callback"]'
      - "CLIENT_ID=6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39555"
      - "CLIENT_SECRET=+sqGL4XE6aqzIMOp/DKC1jWB8I+8qE1jW6iz2tUv8lt+ZZzxjyoCBQeuAcJTFZxfLywkn6cAICK5JPLxYM0+8pk/q7CGHUfr/gzr3ZYRroWWE+egEEDxqRYDYe0="
      # Arbitrary DB number, default is 0 and is used by legacy core.
      - "FC_REDIS_DB=8"
      # Logger
      - "EVT_LOG_FILE=/var/log/app/fsp5v2.log"
      # OidcProvider
      - "FQDN=fsp5v2.docker.dev-franceconnect.fr"
      # OidcClient
      - "OidcClient_ACR=eidas2"
      - "OidcClient_SCOPE=openid profile gender birthdate birthcountry birthplace given_name family_name email preferred_username address phone birth identite_pivot"
    networks:
      - public
      - data
    command: "pm2 logs"

  fsp6v2:
    hostname: fsp6v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "redis-pwd"
      - "broker"
      - "squid"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/client_certs:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/sp.env"
    ports:
      - 9250:9250
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9250 mock-service-provider-high"
      - "VIRTUAL_HOST=fsp6v2.docker.dev-franceconnect.fr"
      - 'REDIRECT_URIS=["https://fsp6v2.docker.dev-franceconnect.fr/oidc-callback/envIssuer"]'
      - 'POST_LOGOUT_REDIRECT_URIS=["https://fsp6v2.docker.dev-franceconnect.fr/logout-callback"]'
      - "CLIENT_ID=6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39666"
      - "CLIENT_SECRET=+sqGL4XE6aqzIMOp/DKC1jWB8I+8qE1jW6iz2tUv8lt+ZZzxjyoCBQeuAcJTFZxfLywkn6cAICK5JPLxYM0+8pk/q7CGHUfr/gzr3ZYRroWWE+egEEDxqRYDYe0="
      # Arbitrary DB number, default is 0 and is used by legacy core.
      - "FC_REDIS_DB=8"
      # Logger
      - "EVT_LOG_FILE=/var/log/app/fsp6v2.log"
      # OidcProvider
      - "FQDN=fsp6v2.docker.dev-franceconnect.fr"
      # OidcClient
      - "OidcClient_ACR=eidas2"
      - "OidcClient_SCOPE=openid profile gender birthdate birthcountry birthplace given_name family_name email preferred_username address phone birth identite_pivot"
    networks:
      - public
      - data
    command: "pm2 logs"
    
  ####################
  # Core FCP High
  ####################

  core-fcp-high:
    hostname: core-fcp-high
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "mongo4"
      - "redis-pwd"
      - "broker"
      - "squid"
      - "haproxy"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/client_certs:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
    ports:
      - 9235:9235
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9235"
      - "VIRTUAL_HOST=core-fcp-high.docker.dev-franceconnect.fr"
      - "REQUEST_TIMEOUT=6000"
      # Set OIDC library debugging mode: https://www.npmjs.com/package/oidc-provider#debugging
      - "DEBUG=oidc-provider:*"
      # Session configuration
      - "SESSION_SECRET=fAh8Seik4_ahcH-3ahth/eiG@huéfuuva=opa"
      - "SESSION_NAME=fc_session"
      - "SESSION_TTL=600000" # 10 minutes
      # Proxy Configuration
      - "GLOBAL_AGENT_HTTP_PROXY=http://squid:3128"
      - "GLOBAL_AGENT_HTTPS_PROXY=http://squid:3128"
      - "GLOBAL_AGENT_NO_PROXY=haproxy"
      # Logger
      - "EVT_LOG_FILE=/var/log/app/core-fcp-high.log"
      # OidcProvider
      - "FQDN=core-fcp-high.docker.dev-franceconnect.fr"
      - "PREFIX=/api/v2"
      ## Beware, the "kid" of "CRYPTO_SIG_FAKE_PRIV_KEY" and "CRYPTO_SIG_HSM_PUB_KEY" must be the same !
      - 'CRYPTO_SIG_FAKE_PRIV_KEY={"crv":"P-256","x":"uRxO96Oqn0BEJZYua3rkM9ntzLbt_nDbq4hwSgOUomQ","y":"o9BoK63TMCGmXjOcCZbtOTmw5HdGiy5ZzY4Qo5KG638","d":"sMJDu7_nEjB0SwTKuKR8XiZPHvoUkem3rdgxP39kkfQ","kty":"EC","kid":"pkcs11:hsm","use":"sig"}'
      - 'CRYPTO_SIG_HSM_PUB_KEY={"crv": "P-256","x": "UvVm7hq8ycQGaKle6kpzUom73IQyYINGRdzQC75AXxw","y": "yoigI3h4xjRQPEeX8GfIyR4mfioqvNIGPWp7_7x7oxk","kty": "EC", "kid": "pkcs11:hsm"}'
      - 'CRYPTO_ENC_LOCALE_PRIV_KEY={"e":"AQAB","n":"5OHMkVCg2xG2osiXbClpkW8YVxVeqPeQDrDZH1tiocf3S9kK1ErRP1oI1qwP3-MTZVp3O0NjO7eIkkqdogCl043vVty25KMk-lM-dAXfQFjSKBE5c2Y_mZbsvEyk885ZmEbb--S-lxZuBX1jWs574fOSsqKH5e5Mf_PjKgwZFOW0SFl6pGOp230Em5OfTbCN8AKMkw907b9DXoPocDcr3d3ZEa10f5OCI0aieTxvH5Jaq9ZMOQIj1-tTMpDecFYLO8REiQSsUp-4PLUbIBL2Iq-qwv6opkVetpiLR-wwz7e2Y_dDHCqnVHcCo_oWVFFRgKiL_dhmxFIpSkw4dc1ICQ","d":"vZepC6o9RJo8rkT44XjAYN8ky2YBPnerVe_6OrZJUnfBCowkI0xCXnbnIWPv1mZT973jTCz680mJkJzMTJi6xC4rVsmHmoblp5HzBsqibrvkgZoa-9Nz1XcmbKgUb3y7zJ7NtK97jM3gnx2JgnvONJG-L8jgR3-I0OimgHr6_8nh8Qv66at8fighlefmIp-2UVYPydKp2pi9drQAWFAYW5hgNCcmuMi8814O4hdm3zsJU6w8cwOLf2p_L3No9YonO2GcSO_ZRHqPqdj5lDwtBR2DbYAUpzOYj0FMPoG6MMM6ITK9DgHDtwVuoo6ZxI6aoAMCYZ8zehn9QuACtZZQPQ","p":"8l1JmRGOfMMxlqFaAB9sWFe29P4xIVl5Tez95Hf9qIIlcdNvrm6bep5889sMAfN3LB2NA09rwBdCPdjVT_80XgrxTsxPPOvzmxuHmHaozlkBAAgfNgIASgKaznSf8nbBkp-p6NRIc3JOCJDFopm6C43ZCexBu8or_CK554O8AMM","q":"8cJUELj52DDYoxcGsm6wIyk9QYCIRry3gxJwaHWQt4xTeX65_W27x0WVY4ZXNCIYYMxKQXN5Ud70OsdzExNHk9dn96w2cOT2tKlIixoSyDpbLsYKuQ4KlEz0S2GZJyiAT0C2N_1VlRy_OFAFmauj9SIMm3Wr3UhWa7fWRWThR0M","dp":"Rs_SzRJAG1u8hVInRZnowfb-0Z3jJOdLdeUkWThluHIuFo-8Na7DZpQf1e_OFlPYId-Qb8MorDsfc4qC6Jib6E4yKt-u1xHpXwwwFe-1anS-wg-dbt4uz3DrYh7ZDLJ95CUaM5iygmiHPCFwXQ2lOfL70tZgbkmniEdtIaNvrpk","dq":"vkXv2-l52kk3d8SbpLuxLTs71t3OY74LwME2b0B4Ub3DxQ-UWn2PGNsPJHGLGKDtBuJCXxj_Fwyes9ReIVk_MICMd0W240uRT8ccLT6sIaKsOTftIJCIiwe2Dc4Wt9cMhVOtFovwW5dweGWiwrtwI3JU8dW_Gj3gpo7duWgYVfk","qi":"Cpf7tVogmGoFr-WTWSkctb0KqNtNCY3tU__2b2GI0uW_a9TafQhU8fon4SNBPlicdAYlgO1q23tklyhGpLbw7qYgHkr-zt-v_Vfg5YP8cZYGEqW52Qjl2HeMlCCI0-38RG3wFYwXjGDZk9YW6VAWlc6i1MSLrd7NGRrwH1ZkD7U","kty":"RSA","kid":"oidc-provider:locale","use":"enc"}'
      - 'OIDC_PROVIDER_COOKIES_KEYS=["iet7jaetheezaingahThooSiem3Oothu", "aeChoomaeyi5Jeo7Viezoh8aew8ieH3m", "JaeDahngohc3athooy1Eip2ahtei8Aep", "iu5vu5EeD4goow5eipeizequaetaxo0V"]'
      # RNIPP
      - "RNIPP_PROTOCOL=https"
      - "RNIPP_HOSTNAME=haproxy"
      - "RNIPP_BASEURL=/Brpp2IdentificationComplet/individus"
      # OidcClient
      - "HTTPS_CLIENT_CERT=/etc/ssl/client_certs/certif-client.pem"
      - "HTTPS_CLIENT_KEY=/etc/ssl/client_certs/certif-client.key"
      - "OidcClient_SCOPE=openid profile email address phone preferred_username birthplace birthcountry"
      # Mongo
      - "FC_DB_TYPE=mongodb"
      - "FC_DB_HOSTS=mongo4:27017"
      - "FC_DB_DATABASE=core-fcp-high"
      - "FC_DB_USER=fc"
      - "FC_DB_PASSWORD=pass"
      - "FC_DB_SYNCHRONIZE=false"
      - "FC_DB_CONNECT_OPTIONS="
      - "FC_DB_REPLICASET=rs0"
      - "FC_DB_TLS=true"
      - "FC_DB_TLS_INSECURE=false"
      - "FC_DB_TLS_CA_FILE=/etc/ssl/client_certs/ca.crt"
      - "FC_DB_TLS_ALLOW_INVALID_HOST_NAME=false"
      - "IDENTITY_HASH_SALT=153a3cf1d20b1cbbcc098eaf70a6284051bc7aebd45f5bf0c811010ecf39968a"
      - "CLIENT_SECRET_CIPHER_PASS=JZBlwxfKnbn/RV025aw+dQxk+xoQT+Yr"
      - "USERINFO_CRYPT_KEY=raePh3i+a4eiwieb-H5iePh6o/gheequ"
      - "FC_REDIS_HOST=redis-pwd"
      - "FC_REDIS_PORT=6379"
      - "FC_REDIS_PASSWORD=Ivae1feiThoogahquohDei7iwie0ceeM"
      # Arbitrary DB number, default is 0 and is used by legacy core.
      - "FC_REDIS_DB=2"
      - 'CRYPTO_BROKER_URLS=["amqp://broker:5672"]'
      - "CRYPTO_BROKER_QUEUE=crypto"
      - 'SESSION_COOKIE_SECRETS=["yahvaeJ0eiNua6te", "lidubozieKadee7w", "Eigoh6ev8xaiNoox", "veed7Oow7er5Saim"]'
      - "CRYPTO_SUB_SECRET=9ed64cd3762973c8a5219e0774671940a3550ae1050af86831d613193e825caa"
      # Mailer
      - "MAILER=logs"
      - "MAILER_FROM_EMAIL=ne-pas-repondre@franceconnect.gouv.fr"
      - "MAILER_FROM_NAME=NE PAS RÉPONDRE"
      ## Must exists even if not used
      - "MAILJET_KEY="
      - "MAILJET_SECRET="
      ## Bluebird potential memory leak safe guard
      ## @see https://gitlab.dev-franceconnect.fr/france-connect/fc/-/issues/131
      ## @see http://bluebirdjs.com/docs/api/promise.config.html#promise.config
      - "BLUEBIRD_LONG_STACK_TRACES=0"
      - "BLUEBIRD_DEBUG=0"
    networks:
      - fc
      - data
    command: "pm2 logs"

  mongo4:
    image: mongo:4.2
    hostname: mongo4
    volumes:
      - "${VOLUMES_DIR}/mongo4/scripts:/opt/scripts"
      - "${VOLUMES_DIR}/mongo4/initdb.d:/docker-entrypoint-initdb.d"
      - "${VOLUMES_DIR}/ssl:/etc/ssl:ro"
    environment:
      - "MONGO_INITDB_DATABASE=core-fcp-high"
      - "MONGO_INITDB_ROOT_USERNAME=rootAdmin"
      - "MONGO_INITDB_ROOT_PASSWORD=pass"
    healthcheck:
      test: test $$(echo "rs.initiate().ok || rs.status().ok" | mongo --host mongo4 -u $${MONGO_INITDB_ROOT_USERNAME} -p $${MONGO_INITDB_ROOT_PASSWORD} --authenticationDatabase admin $${MONGO_INITDB_DATABASE} --quiet --tls --tlsCAFile /etc/ssl/ca.crt) -eq 1
      interval: 10s
      start_period: 30s
    command: --replSet rs0 --enableMajorityReadConcern --tlsMode requireTLS --tlsCertificateKeyFile /etc/ssl/mongo4.pem --keyFile /etc/ssl/mongo.keyfile
    networks:
      - data

  exploitation-high:
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    hostname: exploitation-high
    user: ${CURRENT_UID}
    working_dir: /var/www/app/fc-exploitation
    depends_on:
      - "pg-exploitation-high"
      - "mongo4"
      - "squid"
      - "rnipp"
    volumes:
      - "${VOLUMES_DIR}/src/fc-apps:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/client_certs:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/postgres.env"
      - "${COMPOSE_DIR}/fc-mongo.env"
    environment:
      - "PM2_CWD=/var/www/app/fc-exploitation"
      - "PM2_SCRIPT=yarn start"
      - "VIRTUAL_HOST=exploitation-high.docker.dev-franceconnect.fr"
      # Proxy Configuration
      - "HTTPS_PROXY=http://squid:3128"
      - "DB_HOST=pg-exploitation-high"
      - "FC_DB_TYPE=mongodb"
      - "FC_DB_HOSTS=mongo4:27017"
      - "FC_DB_DATABASE=core-fcp-high"
      - "FC_DB_TLS=true"
      - "FC_DB_TLS_INSECURE=false"
      - "FC_DB_TLS_CA_FILE=/etc/ssl/client_certs/ca.crt"
      - "FC_DB_TLS_ALLOW_INVALID_HOST_NAME=false"
      - "CLIENT_SECRET_CIPHER_PASS=JZBlwxfKnbn/RV025aw+dQxk+xoQT+Yr"
      - 'CRYPTO_BROKER_URLS=["amqp://broker:5672"]'
      - "CRYPTO_BROKER_QUEUE=crypto"
      - "REQUEST_TIMEOUT=60"
      # FLAG USE HSM
      - "USE_HSM=true"
      # IDP default values
      - "IDP_CORE_INSTANCE=FCP"
      # IDP default values
      - 'IDP_DEFAULT_FEATURE_HANDLERS={ "coreVerify": "core-fcp-default-verify", "authenticationEmail": "core-fcp-send-email" }'
      - 'IDP_DEFAULT_RESPONSE_TYPES=["code"]'
      - 'IDP_DEFAULT_REVOCATION_ENDPOINT_AUTH_METHOD=client_secret_post'
      - 'IDP_DEFAULT_REDIRECT_URIS=https://core-fcp-high.docker.dev-franceconnect.fr/api/v2/oidc-callback'
      - 'IDP_DEFAULT_POST_LOGOUT_REDIRECT_URIS=["https://core-fcp-high.docker.dev-franceconnect.fr/api/v2/logout/redirect-from-idp"]'
    networks:
      - exploitation
      - data
    command: "tail -f /dev/null"

  pg-exploitation-high:
    image: postgres:11
    environment:
      - "POSTGRES_DB=pg-db"
      - "POSTGRES_USER=pg-user"
      - "POSTGRES_PASSWORD=pg-password"
    networks:
      - data

  ####################
  # IDP Mocks V2
  ####################

  fip1v2:
    hostname: fip1v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fi-mock:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp.env"
    ports:
      - 9236:9236
    tty: true
    environment:
      - "PM2_SCRIPT=bin/www"
      - "SSL_CLIENT_PROTECTED_URIS=/user/token,/api/user"
      - "VIRTUAL_HOST=fip1v2.docker.dev-franceconnect.fr"
      - "ISSUER=https://fip1v2.docker.dev-franceconnect.fr"
      - "REDIRECT_URI=https://core-fcp-high.docker.dev-franceconnect.fr/api/v2/oidc-callback/fip1v2"
      - "CLIENT_ID=09a1a257648c1742c74d6a3d84b31943"
      - "CLIENT_SECRET=7ae4fef2aab63fb78d777fe657b7536f"
      # Set OIDC library debugging mode: https://www.npmjs.com/package/oidc-provider#debugging
      - "DEBUG=oidc-provider:*"
    networks:
      - public
    command: "pm2 logs"

  fip2v2:
    hostname: fip2v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fi-mock:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
    ports:
      - 9237:9237
    tty: true
    environment:
      - "PM2_SCRIPT=bin/www"
      - "SSL_CLIENT_PROTECTED_URIS=/user/token,/api/user"
      - "VIRTUAL_HOST=fip2v2.docker.dev-franceconnect.fr"
      - "ISSUER=https://fip2v2.docker.dev-franceconnect.fr"
      - "REDIRECT_URI=https://core-fcp-high.docker.dev-franceconnect.fr/api/v2/oidc-callback/fip2v2"
      - "CLIENT_ID=myclientidforfip2v2"
      - "CLIENT_SECRET=7ae4fef2aab63fb78d777fe657b7536f"
      - "DATABASE_PATH=/var/www/app/data"
      - "ID_TOKEN_SIGNED_RESPONSE_ALG=HS256"
      - "ID_TOKEN_ENCRYPTED_RESPONSE_ALG="
      - "ID_TOKEN_ENCRYPTED_RESPONSE_ENC="
      - "USERINFO_SIGNED_RESPONSE_ALG=HS256"
      - "USERINFO_ENCRYPTED_RESPONSE_ALG="
      - "USERINFO_ENCRYPTED_RESPONSE_ENC="
    networks:
      - public
    command: "pm2 logs"

  fip6v2:
    hostname: fip6v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fi-mock:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp.env"
    ports:
      - 9241:9241
    tty: true
    environment:
      - "PM2_SCRIPT=bin/www"
      - "SSL_CLIENT_PROTECTED_URIS=/user/token,/api/user"
      - "VIRTUAL_HOST=fip6v2.docker.dev-franceconnect.fr"
      - "ISSUER=https://fip6v2.docker.dev-franceconnect.fr"
      - "REDIRECT_URI=https://core-fcp-high.docker.dev-franceconnect.fr/api/v2/oidc-callback/fip6v2"
      - "CLIENT_ID=69a1a257648c1742c74d6a3d84b31943"
      - "CLIENT_SECRET=7ae4fef2aab63fb78d777fe657b7536f"
      - "DATABASE_PATH=/var/www/app/data"
    networks:
      - public
    command: "pm2 logs"

  fip7v2:
    hostname: fip7v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fi-mock:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
    ports:
      - 9242:9242
    tty: true
    environment:
      - "PM2_SCRIPT=bin/www"
      - "SSL_CLIENT_PROTECTED_URIS=/user/token,/api/user"
      - "VIRTUAL_HOST=fip7v2.docker.dev-franceconnect.fr"
      - "ISSUER=https://fip7v2.docker.dev-franceconnect.fr"
      - "REDIRECT_URI=https://core-fcp-high.docker.dev-franceconnect.fr/api/v2/oidc-callback/fip7v2"
      - "CLIENT_ID=79a1a257648c1742c74d6a3d84b31943"
      - "CLIENT_SECRET=7ae4fef2aab63fb78d777fe657b7536f"
      - "DATABASE_PATH=/var/www/app/data"
      - "ID_TOKEN_SIGNED_RESPONSE_ALG=HS256"
      - "ID_TOKEN_ENCRYPTED_RESPONSE_ALG=none"
      - "ID_TOKEN_ENCRYPTED_RESPONSE_ENC=none"
      - "USERINFO_SIGNED_RESPONSE_ALG=HS256"
      - "USERINFO_ENCRYPTED_RESPONSE_ALG=none"
      - "USERINFO_ENCRYPTED_RESPONSE_ENC=none"
    networks:
      - public
    command: "pm2 logs"

  exploit-fcp:
    hostname: exploit-fcp
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "pg-exploitation-high"
      - "mongo4"
      - "squid"
      - "rnipp"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/log:/var/log/app"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/client_certs:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/postgres.env"
      - "${COMPOSE_DIR}/fc-mongo.env"
    ports:
      - 9247:9247
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9247 exploit-fcp-instance"
      - "VIRTUAL_HOST=exploit-fcp.docker.dev-franceconnect.fr"
      - "FQDN=exploit-fcp.docker.dev-franceconnect.fr"
      # Logger
      - "EVT_LOG_FILE=/var/log/app/exploit-fcp.log"
      # Proxy Configuration
      - "HTTPS_PROXY=http://squid:3128"
      - "DB_HOST=pg-exploitation-high"
      - "FC_DB_TYPE=mongodb"
      - "FC_DB_HOSTS=mongo4:27017"
      - "FC_DB_DATABASE=core-fcp-high"
      - "FC_DB_TLS=true"
      - "FC_DB_TLS_INSECURE=false"
      - "FC_DB_TLS_CA_FILE=/etc/ssl/client_certs/ca.crt"
      - "FC_DB_TLS_ALLOW_INVALID_HOST_NAME=false"
      - "CLIENT_SECRET_CIPHER_PASS=JZBlwxfKnbn/RV025aw+dQxk+xoQT+Yr"
      - 'CRYPTO_BROKER_URLS=["amqp://broker:5672"]'
      - "CRYPTO_BROKER_QUEUE=crypto"
      - "REQUEST_TIMEOUT=60"
      - 'SESSION_COOKIE_SECRETS=["yahvaeJ0eiNua6te", "lidubozieKadee7w", "Eigoh6ev8xaiNoox", "veed7Oow7er5Saim"]'
      - "USERINFO_CRYPT_KEY=raePh3i+a4eiwieb-H5iePh6o/gheequ"
      #FAG USE HSM
      - "USE_HSM=true"
    networks:
      - exploitation
      - data
    command: "tail -f /dev/null"
    