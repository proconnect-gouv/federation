version: "3.4"

####################
####################
services:
  stack-fcp-high:
    image: alpine
    depends_on:
      - "core-fcp-high"
      - "exploitation-high"
      # -- SP
      - "fsp1v2"
      - "fsp2v2"
      - "fsp3v2"
      - "fsp5v2"
      - "fsp6v2"
      # -- IdP
      - "fip1v2"
      - "fip2v2"
      - "fip6v2"
      - "fip7v2"
      - "fip13v2"
      - "fip14v2"
      - "fip15v2"
      - "fip16v2"
      - "fip17v2"
      - "fip18v2"
      - "fip19v2"
      - "fip20v2"
      # --
      - "rnipp"
      - "csmr-hsm"
      - "exploit-fcp"

  stack-fcp-high-light:
    image: alpine
    depends_on:
      - "core-fcp-high"
      - "fsp1v2"
      - "fip1v2"
      - "rnipp"

  ####################
  # SP Mocks V2
  ####################

  fsp1v2:
    hostname: fsp1v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "redis-pwd"
      - "broker"
      - "squid"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/sp.env"
    ports:
      - 9238:9238
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9238 mock-service-provider-high"
      - "VIRTUAL_HOST=fsp1v2.docker.dev-franceconnect.fr"
      - 'IdentityProviderAdapterEnv_REDIRECT_URIS=["https://fsp1v2.docker.dev-franceconnect.fr/oidc-callback/envIssuer"]'
      - 'IdentityProviderAdapterEnv_POST_LOGOUT_REDIRECT_URIS=["https://fsp1v2.docker.dev-franceconnect.fr/logout-callback"]'
      - "IdentityProviderAdapterEnv_CLIENT_ID=6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950"
      - "IdentityProviderAdapterEnv_CLIENT_SECRET=+sqGL4XE6aqzIMOp/DKC1jWB8I+8qE1jW6iz2tUv8lt+ZZzxjyoCBQeuAcJTFZxfLywkn6cAICK5JPLxYM0+8pk/q7CGHUfr/gzr3ZYRroWWE+egEEDxqRYDYe0="
      # Arbitrary DB number, default is 0 and is used by legacy core.
      - "Redis_DB=4"
      # Logger
      - "Logger_FILE=/var/log/app/fsp1v2.log"
      - "FQDN=fsp1v2.docker.dev-franceconnect.fr"
      # OidcClient
      - "OidcClient_ACR=eidas2"
      - "OidcClient_SCOPE=openid profile gender birthdate birthcountry birthplace given_name family_name email preferred_username address phone birth identite_pivot"
    networks:
      - public
      - data
    command: "pm2 logs"

  fsp2v2:
    hostname: fsp2v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "redis-pwd"
      - "broker"
      - "squid"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/sp.env"
    ports:
      - 9239:9239
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9239 mock-service-provider-high"
      - "VIRTUAL_HOST=fsp2v2.docker.dev-franceconnect.fr"
      - 'IdentityProviderAdapterEnv_REDIRECT_URIS=["https://fsp2v2.docker.dev-franceconnect.fr/oidc-callback/envIssuer"]'
      - 'IdentityProviderAdapterEnv_POST_LOGOUT_REDIRECT_URIS=["https://fsp2v2.docker.dev-franceconnect.fr/logout-callback"]'
      - "IdentityProviderAdapterEnv_CLIENT_ID=7a79e45107f9ccc6a3a5971d501220dc4fd9e87bb5e3fc62ce4104c756e22775"
      - "IdentityProviderAdapterEnv_CLIENT_SECRET=+sqGL4XE6aqzIMOp/DKC1jWB8I+8qE1jW6iz2tUv8lt+ZZzxjyoCBQeuAcJTFZxfLywkn6cAICK5JPLxYM0+8pk/q7CGHUfr/gzr3ZYRroWWE+egEEDxqRYDYe0="
      - "Redis_DB=6"
      # Logger
      - "Logger_FILE=/var/log/app/fsp2v2.log"
      # OidcProvider
      - "FQDN=fsp2v2.docker.dev-franceconnect.fr"
      # OidcClient
      - "OidcClient_ACR=eidas2"
      - "OidcClient_SCOPE=openid profile gender birthdate birthcountry birthplace given_name family_name email preferred_username address phone birth identite_pivot"
    networks:
      - public
      - data
    command: "pm2 logs"

  fsp3v2:
    hostname: fsp3v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "redis-pwd"
      - "broker"
      - "squid"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/sp.env"
    ports:
      - 9240:9240
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9240 mock-service-provider-high"
      - "VIRTUAL_HOST=fsp3v2.docker.dev-franceconnect.fr"
      - 'IdentityProviderAdapterEnv_REDIRECT_URIS=["https://fsp3v2.docker.dev-franceconnect.fr/oidc-callback/envIssuer"]'
      - 'IdentityProviderAdapterEnv_POST_LOGOUT_REDIRECT_URIS=["https://fsp3v2.docker.dev-franceconnect.fr/logout-callback"]'
      - "IdentityProviderAdapterEnv_CLIENT_ID=my-service-provider-deactivated"
      - "IdentityProviderAdapterEnv_CLIENT_SECRET=+sqGL4XE6aqzIMOp/DKC1jWB8I+8qE1jW6iz2tUv8lt+ZZzxjyoCBQeuAcJTFZxfLywkn6cAICK5JPLxYM0+8pk/q7CGHUfr/gzr3ZYRroWWE+egEEDxqRYDYe0="
      # Arbitrary DB number, default is 0 and is used by legacy core.
      - "Redis_DB=8"
      # Logger
      - "Logger_FILE=/var/log/app/fsp3v2.log"
      # OidcProvider
      - "FQDN=fsp3v2.docker.dev-franceconnect.fr"
      # OidcClient
      - "OidcClient_ACR=eidas2"
      - "OidcClient_SCOPE=openid profile gender birthdate birthcountry birthplace given_name family_name email preferred_username address phone birth identite_pivot"
    networks:
      - public
      - data
    command: "pm2 logs"

  fsp5v2:
    hostname: fsp5v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "redis-pwd"
      - "broker"
      - "squid"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/sp.env"
    ports:
      - 9249:9249
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9249 mock-service-provider-high"
      - "VIRTUAL_HOST=fsp5v2.docker.dev-franceconnect.fr"
      - 'IdentityProviderAdapterEnv_REDIRECT_URIS=["https://fsp5v2.docker.dev-franceconnect.fr/oidc-callback/envIssuer"]'
      - 'IdentityProviderAdapterEnv_POST_LOGOUT_REDIRECT_URIS=["https://fsp5v2.docker.dev-franceconnect.fr/logout-callback"]'
      - "IdentityProviderAdapterEnv_CLIENT_ID=6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39555"
      - "IdentityProviderAdapterEnv_CLIENT_SECRET=+sqGL4XE6aqzIMOp/DKC1jWB8I+8qE1jW6iz2tUv8lt+ZZzxjyoCBQeuAcJTFZxfLywkn6cAICK5JPLxYM0+8pk/q7CGHUfr/gzr3ZYRroWWE+egEEDxqRYDYe0="
      # Arbitrary DB number, default is 0 and is used by legacy core.
      - "Redis_DB=8"
      # Logger
      - "Logger_FILE=/var/log/app/fsp5v2.log"
      # OidcProvider
      - "FQDN=fsp5v2.docker.dev-franceconnect.fr"
      # OidcClient
      - "OidcClient_ACR=eidas2"
      - "OidcClient_SCOPE=openid profile gender birthdate birthcountry birthplace given_name family_name email preferred_username address phone birth identite_pivot"
    networks:
      - public
      - data
    command: "pm2 logs"

  fsp6v2:
    hostname: fsp6v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "redis-pwd"
      - "broker"
      - "squid"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/sp.env"
    ports:
      - 9250:9250
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9250 mock-service-provider-high"
      - "VIRTUAL_HOST=fsp6v2.docker.dev-franceconnect.fr"
      - 'IdentityProviderAdapterEnv_REDIRECT_URIS=["https://fsp6v2.docker.dev-franceconnect.fr/oidc-callback/envIssuer"]'
      - 'IdentityProviderAdapterEnv_POST_LOGOUT_REDIRECT_URIS=["https://fsp6v2.docker.dev-franceconnect.fr/logout-callback"]'
      - "IdentityProviderAdapterEnv_CLIENT_ID=6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39666"
      - "IdentityProviderAdapterEnv_CLIENT_SECRET=+sqGL4XE6aqzIMOp/DKC1jWB8I+8qE1jW6iz2tUv8lt+ZZzxjyoCBQeuAcJTFZxfLywkn6cAICK5JPLxYM0+8pk/q7CGHUfr/gzr3ZYRroWWE+egEEDxqRYDYe0="
      # Arbitrary DB number, default is 0 and is used by legacy core.
      - "Redis_DB=8"
      # Logger
      - "Logger_FILE=/var/log/app/fsp6v2.log"
      # OidcProvider
      - "FQDN=fsp6v2.docker.dev-franceconnect.fr"
      # OidcClient
      - "OidcClient_ACR=eidas2"
      - "OidcClient_SCOPE=openid profile gender birthdate birthcountry birthplace given_name family_name email preferred_username address phone birth identite_pivot"
    networks:
      - public
      - data
    command: "pm2 logs"

  ####################
  # Core FCP High
  ####################

  core-fcp-high:
    hostname: core-fcp-high
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "csmr-hsm"
      - "mongo4"
      - "redis-pwd"
      - "broker"
      - "squid"
      - "haproxy"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/log:/var/log/app"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
    ports:
      - 9235:9235
    tty: true
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9235"
      - "VIRTUAL_HOST=core-fcp-high.docker.dev-franceconnect.fr"
      - "PM2_OUT_FILE=/var/log/app/core-fcp-high-console-0.log"
      - "REQUEST_TIMEOUT=6000"
      # Session configuration
      - "SESSION_SECRET=fAh8Seik4_ahcH-3ahth/eiG@huéfuuva=opa"
      - "SESSION_NAME=fc_session"
      - "SESSION_TTL=600000" # 10 minutes
      # Proxy Configuration
      - "GLOBAL_AGENT_HTTP_PROXY=http://squid:3128"
      - "GLOBAL_AGENT_HTTPS_PROXY=http://squid:3128"
      - "GLOBAL_AGENT_NO_PROXY=haproxy"
      # Logger
      - "Logger_FILE=/var/log/app/core-fcp-high.log"
      # OidcProvider
      - "FQDN=core-fcp-high.docker.dev-franceconnect.fr"
      - "OidcProvider_PREFIX=/api/v2"
      - "App_PROTOCOL=https"
      - "App_HTTPS_SERVER_CERT=/etc/ssl/docker_host/app.crt"
      - "App_HTTPS_SERVER_KEY=/etc/ssl/docker_host/app.key"
      ## Beware, the "kid" of "CRYPTO_SIG_FAKE_PRIV_KEY" and "CRYPTO_SIG_HSM_PUB_KEY" must be the same !
      - 'OidcProvider_CRYPTO_SIG_FAKE_PRIV_KEY={"crv":"P-256","x":"uRxO96Oqn0BEJZYua3rkM9ntzLbt_nDbq4hwSgOUomQ","y":"o9BoK63TMCGmXjOcCZbtOTmw5HdGiy5ZzY4Qo5KG638","d":"sMJDu7_nEjB0SwTKuKR8XiZPHvoUkem3rdgxP39kkfQ","kty":"EC","kid":"pkcs11:hsm","use":"sig"}'
      - 'OverrideOidcProvider_CRYPTO_SIG_HSM_PUB_KEY={"crv": "P-256","x": "UvVm7hq8ycQGaKle6kpzUom73IQyYINGRdzQC75AXxw","y": "yoigI3h4xjRQPEeX8GfIyR4mfioqvNIGPWp7_7x7oxk","kty": "EC", "kid": "pkcs11:hsm"}'
      - 'OidcProvider_COOKIES_KEYS=["iet7jaetheezaingahThooSiem3Oothu", "aeChoomaeyi5Jeo7Viezoh8aew8ieH3m", "JaeDahngohc3athooy1Eip2ahtei8Aep", "iu5vu5EeD4goow5eipeizequaetaxo0V"]'
      # RNIPP
      - "Rnipp_PROTOCOL=https"
      - "Rnipp_HOSTNAME=haproxy"
      - "Rnipp_BASEURL=/Brpp2IdentificationComplet/individus"
      # OidcClient
      - "OidcClient_HTTPS_CLIENT_CERT=/etc/ssl/docker_host/app.crt"
      - "OidcClient_HTTPS_CLIENT_KEY=/etc/ssl/docker_host/app.key"
      - 'OidcClient_CRYPTO_ENC_LOCALE_PRIV_KEY={"e":"AQAB","n":"5OHMkVCg2xG2osiXbClpkW8YVxVeqPeQDrDZH1tiocf3S9kK1ErRP1oI1qwP3-MTZVp3O0NjO7eIkkqdogCl043vVty25KMk-lM-dAXfQFjSKBE5c2Y_mZbsvEyk885ZmEbb--S-lxZuBX1jWs574fOSsqKH5e5Mf_PjKgwZFOW0SFl6pGOp230Em5OfTbCN8AKMkw907b9DXoPocDcr3d3ZEa10f5OCI0aieTxvH5Jaq9ZMOQIj1-tTMpDecFYLO8REiQSsUp-4PLUbIBL2Iq-qwv6opkVetpiLR-wwz7e2Y_dDHCqnVHcCo_oWVFFRgKiL_dhmxFIpSkw4dc1ICQ","d":"vZepC6o9RJo8rkT44XjAYN8ky2YBPnerVe_6OrZJUnfBCowkI0xCXnbnIWPv1mZT973jTCz680mJkJzMTJi6xC4rVsmHmoblp5HzBsqibrvkgZoa-9Nz1XcmbKgUb3y7zJ7NtK97jM3gnx2JgnvONJG-L8jgR3-I0OimgHr6_8nh8Qv66at8fighlefmIp-2UVYPydKp2pi9drQAWFAYW5hgNCcmuMi8814O4hdm3zsJU6w8cwOLf2p_L3No9YonO2GcSO_ZRHqPqdj5lDwtBR2DbYAUpzOYj0FMPoG6MMM6ITK9DgHDtwVuoo6ZxI6aoAMCYZ8zehn9QuACtZZQPQ","p":"8l1JmRGOfMMxlqFaAB9sWFe29P4xIVl5Tez95Hf9qIIlcdNvrm6bep5889sMAfN3LB2NA09rwBdCPdjVT_80XgrxTsxPPOvzmxuHmHaozlkBAAgfNgIASgKaznSf8nbBkp-p6NRIc3JOCJDFopm6C43ZCexBu8or_CK554O8AMM","q":"8cJUELj52DDYoxcGsm6wIyk9QYCIRry3gxJwaHWQt4xTeX65_W27x0WVY4ZXNCIYYMxKQXN5Ud70OsdzExNHk9dn96w2cOT2tKlIixoSyDpbLsYKuQ4KlEz0S2GZJyiAT0C2N_1VlRy_OFAFmauj9SIMm3Wr3UhWa7fWRWThR0M","dp":"Rs_SzRJAG1u8hVInRZnowfb-0Z3jJOdLdeUkWThluHIuFo-8Na7DZpQf1e_OFlPYId-Qb8MorDsfc4qC6Jib6E4yKt-u1xHpXwwwFe-1anS-wg-dbt4uz3DrYh7ZDLJ95CUaM5iygmiHPCFwXQ2lOfL70tZgbkmniEdtIaNvrpk","dq":"vkXv2-l52kk3d8SbpLuxLTs71t3OY74LwME2b0B4Ub3DxQ-UWn2PGNsPJHGLGKDtBuJCXxj_Fwyes9ReIVk_MICMd0W240uRT8ccLT6sIaKsOTftIJCIiwe2Dc4Wt9cMhVOtFovwW5dweGWiwrtwI3JU8dW_Gj3gpo7duWgYVfk","qi":"Cpf7tVogmGoFr-WTWSkctb0KqNtNCY3tU__2b2GI0uW_a9TafQhU8fon4SNBPlicdAYlgO1q23tklyhGpLbw7qYgHkr-zt-v_Vfg5YP8cZYGEqW52Qjl2HeMlCCI0-38RG3wFYwXjGDZk9YW6VAWlc6i1MSLrd7NGRrwH1ZkD7U","kty":"RSA","kid":"oidc-provider:locale","use":"enc"}'
      - 'OidcClient_JWKS_ENC_ECDH_ES_PRIV_KEY={"crv":"P-256","x":"85iY2dD3NhgK-zyQe00NQSvLuS_GHbU_mcA2Z__QEow","y":"n3zXtgfQGgHHaiI-ApcSkDvlYsE2DOrFFOvpHuECoPg","d":"PlWeN6yarMmop2jzFGkp9F5a6iEnRVwIqnM_huXp7zg","kty":"EC","kid":"EC","use":"enc"}'
      - "OidcClient_SCOPE=openid profile email address phone preferred_username birthplace birthcountry"
      # Mongo
      - "FC_DB_TYPE=mongodb"
      - "Mongoose_HOSTS=mongo4:27017"
      - "Mongoose_DATABASE=core-fcp-high"
      - "Mongoose_USER=fc"
      - "Mongoose_PASSWORD=pass"
      - "Mongoose_TLS=true"
      - "Mongoose_TLS_INSECURE=false"
      - "Mongoose_TLS_CA_FILE=/etc/ssl/docker_host/docker-stack-ca.crt"
      - "Mongoose_TLS_ALLOW_INVALID_HOST_NAME=false"
      - "FC_DB_SYNCHRONIZE=false"
      - "FC_DB_CONNECT_OPTIONS="
      - "FC_DB_REPLICASET=rs0"
      - "IDENTITY_HASH_SALT=153a3cf1d20b1cbbcc098eaf70a6284051bc7aebd45f5bf0c811010ecf39968a"
      - "AdapterMongo_CLIENT_SECRET_CIPHER_PASS=JZBlwxfKnbn/RV025aw+dQxk+xoQT+Yr"
      - "Redis_HOST=redis-pwd"
      - "Redis_PORT=6379"
      - "Redis_PASSWORD=Ivae1feiThoogahquohDei7iwie0ceeM"
      # Arbitrary DB number, default is 0 and is used by legacy core.
      - "Redis_DB=2"
      - 'CryptographyBroker_URLS=["amqp://broker:5672"]'
      - "CryptographyBroker_QUEUE=crypto"
      # Session
      - "Session_USERINFO_CRYPT_KEY=raePh3i+a4eiwieb-H5iePh6o/gheequ"
      - 'Session_COOKIE_SECRETS=["yahvaeJ0eiNua6te", "lidubozieKadee7w", "Eigoh6ev8xaiNoox", "veed7Oow7er5Saim"]'
      - "Cryptography_CRYPTO_SUB_SECRET=9ed64cd3762973c8a5219e0774671940a3550ae1050af86831d613193e825caa"
      # Mailer
      - "Mailer_TRANSPORT=logs"
      - "Mailer_FROM_EMAIL=ne-pas-repondre@franceconnect.gouv.fr"
      - "Mailer_FROM_NAME=NE PAS RÉPONDRE"
      ## Must exists even if not used
      - "Mailer_MAILJET_KEY="
      - "Mailer_MAILJET_SECRET="
      ## Bluebird potential memory leak safe guard
      ## @see https://gitlab.dev-franceconnect.fr/france-connect/fc/-/issues/131
      ## @see http://bluebirdjs.com/docs/api/promise.config.html#promise.config
      - "BLUEBIRD_LONG_STACK_TRACES=0"
      - "BLUEBIRD_DEBUG=0"
      # Mailer
      - 'Mailer_TEMPLATES_PATHS=["/var/www/app/apps/core-fcp/src/mails", "/var/www/app/instances/core-fcp-high/src/mails"]'
    networks:
      - fc
      - data
    command: "pm2 logs"

  mongo4:
    build:
      context: "${WORKING_DIR}"
      dockerfile: "${WORKING_DIR}/builds/mongodb/Dockerfile"
    hostname: mongo4
    volumes:
      - "${VOLUMES_DIR}/mongo4/scripts:/opt/scripts"
      - "${VOLUMES_DIR}/mongo4/initdb.d:/docker-entrypoint-initdb.d"
    env_file:
      - "${COMPOSE_DIR}/fcp-high/.env/mongo.env"
    ports:
      - "127.0.0.1:27017:27017"
    networks:
      - data

  exploitation-high:
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    hostname: exploitation-high
    user: ${CURRENT_UID}
    working_dir: /var/www/app/fc-exploitation
    depends_on:
      - "pg-exploitation-high"
      - "mongo4"
      - "squid"
      - "rnipp"
    volumes:
      - "${VOLUMES_DIR}/src/fc-apps:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/postgres.env"
      - "${COMPOSE_DIR}/fc-mongo.env"
    environment:
      - "PM2_CWD=/var/www/app/fc-exploitation"
      - "PM2_SCRIPT=yarn start"
      - "VIRTUAL_HOST=exploitation-high.docker.dev-franceconnect.fr"
      # Proxy Configuration
      - "HTTPS_PROXY=http://squid:3128"
      - "DB_HOST=pg-exploitation-high"
      - "FC_DB_TYPE=mongodb"
      - "FC_DB_HOSTS=mongo4:27017"
      - "FC_DB_DATABASE=core-fcp-high"
      - "FC_DB_TLS=true"
      - "FC_DB_TLS_INSECURE=false"
      - "FC_DB_TLS_CA_FILE=/etc/ssl/docker_host/docker-stack-ca.crt"
      - "FC_DB_TLS_ALLOW_INVALID_HOST_NAME=false"
      - "CLIENT_SECRET_CIPHER_PASS=JZBlwxfKnbn/RV025aw+dQxk+xoQT+Yr"
      - 'CRYPTO_BROKER_URLS=["amqp://broker:5672"]'
      - "CRYPTO_BROKER_QUEUE=crypto"
      - "REQUEST_TIMEOUT=60"
      # FLAG USE HSM
      - "USE_HSM=true"
      # IDP default values
      - "IDP_CORE_INSTANCE=FCP"
      # IDP default values
      - 'IDP_DEFAULT_FEATURE_HANDLERS={ "coreVerify": "core-fcp-default-verify", "authenticationEmail": "core-fcp-send-email" }'
      - 'IDP_DEFAULT_RESPONSE_TYPES=["code"]'
      - 'IDP_DEFAULT_REVOCATION_ENDPOINT_AUTH_METHOD=client_secret_post'
      - 'IDP_DEFAULT_REDIRECT_URIS=https://core-fcp-high.docker.dev-franceconnect.fr/api/v2/oidc-callback'
      - 'IDP_DEFAULT_POST_LOGOUT_REDIRECT_URIS=["https://core-fcp-high.docker.dev-franceconnect.fr/api/v2/logout/redirect-from-idp"]'
    networks:
      - exploitation
      - data
    command: "tail -f /dev/null"

  pg-exploitation-high:
    image: postgres:11
    environment:
      - "POSTGRES_DB=pg-db"
      - "POSTGRES_USER=pg-user"
      - "POSTGRES_PASSWORD=pg-password"
    networks:
      - data

  ####################
  # IDP Mocks V1 and V2
  # @TODO replace V1 by V2 app instanciation.
  # fip1 > fip12 = V1 >> based on app from another repo `../../..fi-mock`
  # fip13 > fip20 = V2 >> based on app from `../instances/mock-identity-provider-fcp-high`
  ####################

  fip1v2:
    hostname: fip1v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fi-mock:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip1v2.env"
    ports:
      - 9236:9236
    tty: true
    networks:
      - public
    command: "pm2 logs"

  fip2v2:
    hostname: fip2v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fi-mock:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip2v2.env"
    ports:
      - 9237:9237
    tty: true
    networks:
      - public
    command: "pm2 logs"

  fip6v2:
    hostname: fip6v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fi-mock:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip6v2.env"
    ports:
      - 9241:9241
    tty: true
    networks:
      - public
    command: "pm2 logs"

  fip7v2:
    hostname: fip7v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fi-mock:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip7v2.env"
    ports:
      - 9242:9242
    tty: true
    networks:
      - public
    command: "pm2 logs"
  
  fip13v2:
    hostname: fip13v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/fcp-high/mocks/idp/databases:/var/databases"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp-high.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip13v2.env"
    ports:
      - 9244:9244
    tty: true
    networks:
      - public
      - data
    command: "pm2 logs"
  
  fip14v2:
    hostname: fip14v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/fcp-high/mocks/idp/databases:/var/databases"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp-high.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip14v2.env"
    ports:
      - 9252:9252
    tty: true
    networks:
      - public
      - data
    command: "pm2 logs"

  fip15v2:
    hostname: fip15v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/fcp-high/mocks/idp/databases:/var/databases"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp-high.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip15v2.env"
    ports:
      - 9253:9253
    tty: true
    networks:
      - public
      - data
    command: "pm2 logs"

  fip16v2:
    hostname: fip16v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/fcp-high/mocks/idp/databases:/var/databases"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp-high.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip16v2.env"
    ports:
      - 9254:9254
    tty: true
    networks:
      - public
      - data
    command: "pm2 logs"

  fip17v2:
    hostname: fip17v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/fcp-high/mocks/idp/databases:/var/databases"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp-high.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip17v2.env"
    ports:
      - 9255:9255
    tty: true
    networks:
      - public
      - data
    command: "pm2 logs"

  fip18v2:
    hostname: fip18v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/fcp-high/mocks/idp/databases:/var/databases"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp-high.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip18v2.env"
    ports:
      - 9256:9256
    tty: true
    networks:
      - public
      - data
    command: "pm2 logs"
  
  fip19v2:
    hostname: fip19v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/fcp-high/mocks/idp/databases:/var/databases"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp-high.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip19v2.env"
    ports:
      - 9257:9257
    tty: true
    networks:
      - public
      - data
    command: "pm2 logs"

  fip20v2:
    hostname: fip20v2
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/fcp-high/mocks/idp/databases:/var/databases"
      - "${VOLUMES_DIR}/log/:/var/log/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/idp-fcp-high.env"
      - "${COMPOSE_DIR}/fcp-high/.env/fip20v2.env"
    ports:
      - 9258:9258
    tty: true
    networks:
      - public
      - data
    command: "pm2 logs"
  
  exploit-fcp:
    hostname: exploit-fcp
    image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
    user: ${CURRENT_UID}
    working_dir: /var/www/app
    depends_on:
      - "pg-exploitation-high"
      - "mongo4"
      - "squid"
      - "rnipp"
    volumes:
      - "${VOLUMES_DIR}/src/fc/back:/var/www/app"
      - "${VOLUMES_DIR}/app:/opt/scripts"
      - "${VOLUMES_DIR}/.home:/home"
      - "${VOLUMES_DIR}/log:/var/log/app"
      - "${VOLUMES_DIR}/ssl:/etc/ssl/docker_host:ro"
    env_file:
      - "${COMPOSE_DIR}/base-app.env"
      - "${COMPOSE_DIR}/postgres.env"
      - "${COMPOSE_DIR}/fc-mongo.env"
    ports:
      - 9247:9247
    environment:
      - "PM2_SCRIPT=yarn start:dev --debug=0.0.0.0:9247 exploit-fcp-instance"
      - "VIRTUAL_HOST=exploit-fcp.docker.dev-franceconnect.fr"
      - "FQDN=exploit-fcp.docker.dev-franceconnect.fr"
      # Logger
      - "Logger_FILE=/var/log/app/exploit-fcp.log"
      # Proxy Configuration
      - "HTTPS_PROXY=http://squid:3128"
      - "DB_HOST=pg-exploitation-high"
      - "FC_DB_TYPE=mongodb"
      - "FC_DB_HOSTS=mongo4:27017"
      - "FC_DB_DATABASE=core-fcp-high"
      - "FC_DB_TLS=true"
      - "FC_DB_TLS_INSECURE=false"
      - "FC_DB_TLS_CA_FILE=/etc/ssl/docker_host/docker-stack-ca.crt"
      - "FC_DB_TLS_ALLOW_INVALID_HOST_NAME=false"
      - "CLIENT_SECRET_CIPHER_PASS=JZBlwxfKnbn/RV025aw+dQxk+xoQT+Yr"
      - 'CRYPTO_BROKER_URLS=["amqp://broker:5672"]'
      - "CRYPTO_BROKER_QUEUE=crypto"
      - "REQUEST_TIMEOUT=60"
      - 'Session_COOKIE_SECRETS=["yahvaeJ0eiNua6te", "lidubozieKadee7w", "Eigoh6ev8xaiNoox", "veed7Oow7er5Saim"]'
      - "Session_USERINFO_CRYPT_KEY=raePh3i+a4eiwieb-H5iePh6o/gheequ"
      #FAG USE HSM
      - "USE_HSM=true"
    networks:
      - exploitation
      - data
    command: "tail -f /dev/null"
