name: ðŸ³ Build docker images

on:
  pull_request:
    paths:
      - '.github/workflows/build-docker.yml'
  push:
    branches:
      - main
    tags:
      - '*'

jobs:
  build:
    name: "${{ matrix.instance }} ${{ matrix.arch }}"
    if: github.actor != 'dependabot[bot]'
    runs-on: ubuntu-24.04${{ matrix.arch == 'arm64' && '-arm' || '' }}
    permissions:
      packages: write
      contents: read
      attestations: write
      id-token: write
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: Login to Github Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ github.token }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: ghcr.io/${{ github.repository }}/${{ matrix.instance }}
          tags: |
            type=sha,format=long,prefix=
            type=ref,event=branch
            type=ref,event=tag
            type=raw,value=${{ github.ref_name }}
          flavor: |
            latest=${{ github.ref == 'refs/heads/main' }}
        env:
          DOCKER_METADATA_ANNOTATIONS_LEVELS: index

      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Build image and push by digest
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          build-args: |
            SOURCE_COMMIT=${{ github.sha }}
            INSTANCE=${{ matrix.instance }}
          context: ${{ matrix.context }}
          labels: ${{ steps.meta.outputs.labels }}
          annotations: ${{ steps.meta.outputs.annotations }}
          platforms: ${{ matrix.arch }}
          push: true
          outputs: type=image,name=ghcr.io/${{ github.repository }}/${{ matrix.instance }},push-by-digest=true,name-canonical=true,push=true

      - name: Generate artifact attestation
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3
        with:
          subject-name: ghcr.io/${{ github.repository }}/${{ matrix.instance }}
          subject-digest: ${{ steps.build.outputs.digest }}
          push-to-registry: true

      - name: Export digest
        working-directory: ${{ runner.temp }}
        env:
          DIGEST: ${{ steps.build.outputs.digest }}
        run: |
          mkdir -p "digests/${{ matrix.instance }}/digests"
          printenv DIGEST > "digests/${{ matrix.instance }}/${{ matrix.arch }}.digest"
          printenv DOCKER_METADATA_OUTPUT_JSON > "digests/${{ matrix.instance }}/meta.json"

      - name: Upload digest
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: digests-${{ matrix.instance }}-${{ matrix.arch }}
          path: ${{ runner.temp }}/digests
          if-no-files-found: error
          retention-days: 1

    strategy:
      fail-fast: false
      matrix:
        instance:
          - bridge-http-proxy-rie
          - core-fca-low
          - csmr-rie
          - mock-data-provider
          - mock-identity-provider-fca-low
          - mock-service-provider-fca-low
          - api-partner
          - fc-exploitation-v2
        include:
          - instance: bridge-http-proxy-rie
            context: ./back
          - instance: core-fca-low
            context: ./back
          - instance: csmr-rie
            context: ./back
          - instance: mock-data-provider
            context: ./back
          - instance: mock-identity-provider-fca-low
            context: ./back
          - instance: mock-service-provider-fca-low
            context: ./back
          - instance: api-partner
            context: ./pcdbapi
          - instance: fc-exploitation-v2
            context: ./admin
        arch:
          - amd64
          - arm64

  merge:
    runs-on: ubuntu-24.04
    needs:
      - build
    permissions:
      packages: write
    steps:
      - name: Login to Github Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ github.token }}

      - name: Download digests
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-*
          merge-multiple: true

      - name: Create multiarch images
        working-directory: ${{ runner.temp }}
        run: |
          for image in $(ls digests); do
            readarray -t args < <(jq -r '(.annotations[]|"--annotation=\(.)"),(.tags[]|"--tag=\(.)")' < "digests/$image/meta.json")

            docker buildx imagetools create "${args[@]}" $(cat digests/$image/*.digest)

            docker buildx imagetools inspect $(jq -r '.tags[0]' < "digests/$image/meta.json")
          done
