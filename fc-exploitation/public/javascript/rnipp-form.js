import $ from 'jquery';
import moment from 'moment';
import { validateRnippForm } from '@fc/shared/public/javascript/validateForm';

const API = {
  checkUser: '/citizen',
};


function initUI() {
  $('#result').append(`
    <h3>Statut de l'usager</h3>
    <div id="citizen-status"><div class="spinner"><i></i></div> Chargement...</div>
  `);
}

function updateUIError(data) {
  let content = 'Une erreur technique est survenue';

  if (data.status === 404) {
    content = 'Inconnu(e) de France connect';
  }

  $('#citizen-status').html(`<p>${content}</p>`);
}

function updateUISuccess(data) {
  const lastConnection = moment(data.lastConnection).format(
    'DD/MM/YYYY à HH:mm:ss',
  );

  $('#citizen-status').html(`
    <ul>
      <li><b>Actif :</b> ${data.active ? 'oui' : 'non'}</li>
      <li><b>Dernière connexion :</b> le ${lastConnection}</li>
    </ul>
  `);
}


function checkUserStatus() {
  if (typeof __RNIPP_DATA__ === 'undefined') {
    return;
  }

  initUI();

  const csrfToken = $('input[name="_csrf"]').val();

  const httpOptions = {
    method: 'POST',
    data: __RNIPP_DATA__,
    headers: { 'CSRF-Token': csrfToken },
  };

  $.ajax(API.checkUser, httpOptions)
    .done(updateUISuccess)
    .fail(updateUIError);
}

export function rnippForm(element) {
  // Generic RNIPP form managment
  validateRnippForm(element);
  // Exploitation specific code
  checkUserStatus();
}
