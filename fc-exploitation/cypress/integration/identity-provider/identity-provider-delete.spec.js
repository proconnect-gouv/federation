import 'cypress-file-upload';
import {
  USER_OPERATOR,
  USER_PASS,
} from '../../../../shared/cypress/support/constants';
import { createIdentityProvider } from './identity-provider.util';

const basicConfiguration = {
  totp: true,
  _csrf: true,
};

describe('Delete identity provider', () => {
  const fi = {
    name: 'FIaSupprimer',
    title: 'Fi à supprimer',
    issuer: 'https://issuer.fr',
    authorizationUrl: 'https://issuer.fr/auth',
    tokenUrl: 'https://issuer.fr/token',
    userInfoUrl: 'https://issuer.fr/me',
    statusUrl: 'https://issuer.fr/state',
    jwksUrl: 'https://issuer.fr/discovery',
    clientId: '09a1a257648c1742c74d6a3d84b31943',
    clientSecret: '1234567890AZERTYUIOP',
    messageToDisplayWhenInactive: 'SUPER MESSAGE !!!',
    redirectionTargetWhenInactive: 'https://issuer.fr/promo',
    alt: 'MonFI Image',
    image: 'AliceM.svg',
    imageFocus: 'AliceM.svg',
    trustedIdentity: 'false',
    eidas: 2,
    order: 1,
    emails: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
    specificText:
      "Veuillez fournir une capture d'écran de votre page de profil !",
  };

  before(() => {
    cy.resetEnv('mongoFC');
    cy.login(USER_OPERATOR, USER_PASS);
    cy.visit(`/identity-provider`);
    createIdentityProvider(fi, basicConfiguration);
    cy.visit(`/identity-provider`);
    cy.contains(`${fi.name}`).should('be.visible');
  });

  beforeEach(() => {
    cy.login(USER_OPERATOR, USER_PASS);
    cy.visit(`/identity-provider`);
    cy.contains(`${fi.name}`).should('be.visible');
  });

  after(() => {
    cy.contains(`${USER_OPERATOR}`).click();
    cy.contains('Déconnexion').click();
  });

  it('Does not delete if action is cancel', () => {
    cy.get(
      `form[data-element-title="${fi.title}"] button[type="submit"]`,
    ).click();
    cy.contains('Annuler').click();
    cy.visit(`/identity-provider`);
    cy.contains(`${fi.name}`).should('be.visible');
  });

  it('Does not delete if totp is not correct or empty', () => {
    cy.get(
      `form[data-element-title="${fi.title}"] button[type="submit"]`,
    ).click();
    cy.contains('Confirmer').click();
    cy.contains(`Le TOTP n'a pas été saisi`).should('be.visible');
    cy.get('#totpModal').type('000000');
    cy.contains('Confirmer').click();
    cy.contains(`Le TOTP saisi n'est pas valide`).should('be.visible');
    cy.visit(`/identity-provider?page=1&limit=9999`);
    cy.contains(`${fi.name}`).should('be.visible');
  });

  it('Should delete one identity provider', () => {
    cy.get(
      `form[data-element-title="${fi.title}"] button[type="submit"]`,
    ).click();
    cy.get('#totpModal').then(() => cy.totp(basicConfiguration));
    cy.contains('Confirmer').click();
    cy.contains(
      `Le fournisseur d'identité ${fi.name} a été supprimé avec succès !`,
    ).should('be.visible');
    cy.get('.alert-success > .close').click();
    cy.contains(`${fi.name}`).should('not.be.visible');
  });
});
