import { BASE_URL, USER_OPERATOR, USER_PASS } from '../constants.util';
import { createIdentityProvider } from './identity-provider-create.util';
import { login } from '../login.util';

describe('Identity provider creation', () => {
    let basicConfiguration;

  beforeEach(() => {
    basicConfiguration = {
      totp: true,
      _csrf: true,
    };
    login(USER_OPERATOR, USER_PASS);
    cy.visit(`${BASE_URL}/identity-provider`);
  });

  describe('Should succeed', () => {
    it('if all fields are provided', () => {
      const fi = {
        name: 'MonSuperFI',
        title: 'Mon Super FI mais mieux écrit',
        url: 'https://issuer.fr',
        authzURL: 'https://issuer.fr/auth',
        tokenURL: 'https://issuer.fr/token',
        userInfoURL: 'https://issuer.fr/token',
        statusURL: 'https://issuer.fr/state',
        jwksURL: 'https://issuer.fr/discovery',
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        clientSecret: '1234567890AZERTYUIOP',
        hoverMsg: 'SUPER MESSAGE !!!',
        hoverRedirectLink: 'https://issuer.fr/promo',
        alt: 'MonFI Image',
        image: 'AliceM.svg',
        imageFocus: 'AliceM.svg',
        trustedIdentity: 'false',
        eidas: 2,
        order: 1,
        mailto: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
        specificText: 'Veuillez fournir une capture d\'écran de votre page de profil !',
      };
      createIdentityProvider(fi, basicConfiguration, BASE_URL);

      cy.url().should('eq', `${BASE_URL}/identity-provider`);
      cy.contains(`Le fournisseur d'identité MonSuperFI a été créé avec succès !`).should('be.visible');
      cy.get('.alert-success > .close').click();
    });

    it('if only mandatory fields are provided', () => {
      const fi = {
        name: 'MonSuperFI-2',
        title: 'Mon Super FI 2 mais mieux écrit',
        url: 'https://issuer.fr',
        authzURL: 'https://issuer.fr/auth',
        tokenURL: 'https://issuer.fr/token',
        userInfoURL: 'https://issuer.fr/token',
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        clientSecret: '1234567890AZERTYUIOP',
        mailto: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
      };
      createIdentityProvider(fi, basicConfiguration, BASE_URL);

      cy.url().should('eq', `${BASE_URL}/identity-provider`);
      cy.contains(`Le fournisseur d'identité MonSuperFI-2 a été créé avec succès !`).should('be.visible');
      cy.get('.alert-success > .close').click();
    });
  });

  describe('Should fail', () => {
    it('if no field was filled', () => {
      const fi = {};

      createIdentityProvider(fi, basicConfiguration, BASE_URL);
      cy.url().should('eq', `${BASE_URL}/identity-provider/create`);
      cy.contains(`Veuillez mettre un nom valide ( majuscule, minuscule, nombres et trait d'union )`).should('be.visible');
      cy.contains(`Veuillez mettre un titre valide ( majuscule, minuscule, nombres, trait d'union et espaces )`).should('be.visible');
      cy.contains(`Veuillez mettre une issuer URL valide au format https://issuer.fr`).should('be.visible');
      cy.contains(`Veuillez mettre une authorization URL valide au format https://issuer.fr/auth`).should('be.visible');
      cy.contains(`Veuillez mettre une token URL valide au format https://issuer.fr/token`).should('be.visible');
      cy.contains(`Veuillez mettre une userInfo URL valide au format https://issuer.fr/userinfo`).should('be.visible');
      cy.contains(`Veuillez saisir un clientId valide`).should('be.visible');
      cy.contains(`Veuillez saisir un client Secret valide`).should('be.visible');
      cy.contains(`Veuillez saisir au moins un email`).should('be.visible');
    });

    it('if the name is already taken', () => {
      const fi = {
        name: 'MonSuperFI-2',
        title: 'Mon Super FI 2 mais mieux écrit',
        url: 'https://issuer.fr',
        authzURL: 'https://issuer.fr/auth',
        tokenURL: 'https://issuer.fr/token',
        userInfoURL: 'https://issuer.fr/token',
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        clientSecret: '1234567890AZERTYUIOP',
        mailto: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
      };

      createIdentityProvider(fi, basicConfiguration, BASE_URL);
      cy.url().should('eq', `${BASE_URL}/identity-provider/create`);
      cy.contains(`E11000 duplicate key error collection: fc.provider index: name_1 dup key: { : "MonSuperFI-2" }`).should('be.visible');
    });

    it('if the totp is invalid', () => {
      const fi = {
        name: 'MonSuperFI-3',
        title: 'Mon Super FI 3 mais mieux écrit',
        url: 'https://issuer.fr',
        authzURL: 'https://issuer.fr/auth',
        tokenURL: 'https://issuer.fr/token',
        userInfoURL: 'https://issuer.fr/token',
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        clientSecret: '1234567890AZERTYUIOP',
        mailto: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
      };

      basicConfiguration.totp = false;

      createIdentityProvider(fi, basicConfiguration, BASE_URL);
      cy.url().should('eq', `${BASE_URL}/identity-provider/create`);
      cy.contains(`Le TOTP saisi n'est pas valide`).should('be.visible');
    });
  });
});