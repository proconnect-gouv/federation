import {
  USER_OPERATOR,
  USER_PASS,
} from '../../../../shared/cypress/support/constants';
import {
  createIdentityProvider,
  assertFormValues,
} from './identity-provider.util';

const BASE_URL = Cypress.config('baseUrl');

describe('Identity provider creation', () => {
  let basicConfiguration;

  before(() => cy.resetEnv('mongoFC'));
  beforeEach(() => {
    basicConfiguration = {
      totp: true,
      _csrf: true,
      fast: true,
    };
    cy.login(USER_OPERATOR, USER_PASS);
    cy.visit(`/identity-provider`);
  });

  describe('Should succeed', () => {
    it('if all fields are provided', () => {
      const fi = {
        name: 'MonSuperFI',
        title: 'Mon Super FI mais mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/me',
        statusUrl: 'https://issuer.fr/state',
        jwksUrl: 'https://issuer.fr/jwks',
        discovery: 'false',
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: 'SUPER MESSAGE !!!',
        redirectionTargetWhenInactive: 'https://issuer.fr/promo',
        alt: 'MonFI Image',
        image: 'AliceM.svg',
        imageFocus: 'AliceM.svg',
        trustedIdentity: 'false',
        eidas: 2,
        order: 1,
        emails: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
        specificText:
          "Veuillez fournir une capture d'écran de votre page de profil !",
        token_endpoint_auth_method: 'client_secret_post',
      };
      createIdentityProvider(fi, basicConfiguration);

      cy.url().should('eq', `${BASE_URL}/identity-provider`);
      cy.contains(
        `Le fournisseur d'identité MonSuperFI a été créé avec succès !`,
      ).should('exist');
      cy.get('.alert-success > .close').click();
    });

    it('if only mandatory fields are provided', () => {
      const fi = {
        name: 'MonSuperFI-2',
        title: 'Mon Super FI 2 mais mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        discovery: 'false',
        jwksUrl: 'https://issuer.fr/jwks',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/me',
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        trustedIdentity: 'true',
        emails: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
        token_endpoint_auth_method: 'client_secret_post',
      };
      createIdentityProvider(fi, basicConfiguration);

      cy.url().should('eq', `${BASE_URL}/identity-provider`);
      cy.contains(
        `Le fournisseur d'identité MonSuperFI-2 a été créé avec succès !`,
      ).should('exist');
      cy.get('.alert-success > .close').click();
    });

    it('if title contains authorized special chars', () => {
      const fi = {
        name: 'MonSuperFI-3',
        title: "Mon FI à l'extrême: plein de _ & de œ!",
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/me',
        discovery: 'false',
        jwksUrl: 'https://issuer.fr/jwks',
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        trustedIdentity: 'true',
        emails: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
        token_endpoint_auth_method: 'client_secret_post',
      };
      createIdentityProvider(fi, basicConfiguration);

      cy.url().should('eq', `${BASE_URL}/identity-provider`);
      cy.contains(
        `Le fournisseur d'identité MonSuperFI-3 a été créé avec succès !`,
      ).should('exist');
      cy.get('.alert-success > .close').click();
    });

    it('if all fields are provided with algo fields ', () => {
      const fi = {
        name: 'MonFIWithAlgoFields',
        title: 'Mon Super FI mais mieux écrit',
        issuer: 'https://issuer.fr',
        statusUrl: 'https://issuer.fr/state',
        jwksUrl: 'https://issuer.fr/jwks',
        discovery: 'true',
        discoveryUrl: 'http://discoveryUrl.com',
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: 'SUPER MESSAGE !!!',
        redirectionTargetWhenInactive: 'https://issuer.fr/promo',
        alt: 'MonFI Image',
        image: 'AliceM.svg',
        imageFocus: 'AliceM.svg',
        trustedIdentity: 'false',
        eidas: 2,
        order: 1,
        emails: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
        specificText:
          "Veuillez fournir une capture d'écran de votre page de profil !",
        userinfo_encrypted_response_enc: 'A256GCM',
        userinfo_encrypted_response_alg: 'RSA-OAEP',
        userinfo_signed_response_alg: 'ES256',
        id_token_signed_response_alg: 'ES256',
        id_token_encrypted_response_alg: 'RSA-OAEP',
        id_token_encrypted_response_enc: 'A256GCM',
        token_endpoint_auth_method: 'client_secret_post',
      };

      createIdentityProvider(fi, basicConfiguration);

      cy.url().should('eq', `${BASE_URL}/identity-provider`);
      cy.contains(
        `Le fournisseur d'identité MonFIWithAlgoFields a été créé avec succès !`,
      ).should('exist');
      cy.get('.alert-success > .close').click();
    });

    it('if discovery is set to true', () => {
      const fi = {
        name: 'MonSuperFI-Discovery-True',
        title: 'Mon Super FI 2 mais mieux écrit',
        issuer: 'https://issuer.fr',
        discovery: 'true',
        discoveryUrl: 'http://discoveryUrl.com',
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        trustedIdentity: 'true',
        emails: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
        token_endpoint_auth_method: 'client_secret_post',
      };
      createIdentityProvider(fi, basicConfiguration);

      cy.url().should('eq', `${BASE_URL}/identity-provider`);
      cy.contains(
        `Le fournisseur d'identité MonSuperFI-Discovery-True a été créé avec succès !`,
      ).should('exist');
      cy.get('.alert-success > .close').click();
    });
  });

  describe('Should fail', () => {
    it('if no field was filled', () => {
      const fi = {};

      createIdentityProvider(fi, basicConfiguration);
      cy.url().should('eq', `${BASE_URL}/identity-provider/create`);
      cy.contains(
        `Veuillez mettre un titre valide ( majuscule, minuscule, nombres et '.:_/!+- [espace] )`,
      )
        .scrollIntoView()
        .should('exist');
      cy.contains(
        `Veuillez mettre un nom valide ( majuscule, minuscule, nombres et '.:_/!+- [espace] )`,
      )
        .scrollIntoView()
        .should('exist');
      cy.contains(
        `Veuillez mettre une issuer URL valide au format https://issuer.fr`,
      )
        .scrollIntoView()
        .should('exist');
      cy.contains(
        `Veuillez mettre une token URL valide au format https://issuer.fr/token`,
      )
        .scrollIntoView()
        .should('exist');
      cy.contains(`Veuillez saisir un clientId valide`)
        .scrollIntoView()
        .should('exist');
      cy.contains(`Veuillez saisir un client Secret valide`)
        .scrollIntoView()
        .should('exist');
      cy.contains(`Veuillez saisir au moins un email`)
        .scrollIntoView()
        .should('exist');
    });

    it('if the name is already taken', () => {
      const fi = {
        name: 'MonSuperFI-2',
        title: 'Mon Super FI 2 mais mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        discovery: 'false',
        jwksUrl: 'https://issuer.fr/jwks',
        userInfoUrl: 'https://issuer.fr/me',
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        trustedIdentity: 'true',
        emails: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
        token_endpoint_auth_method: 'client_secret_post',
      };

      createIdentityProvider(fi, basicConfiguration);
      cy.url().should('eq', `${BASE_URL}/identity-provider/create`);
      cy.contains(
        `E11000 duplicate key error collection: fc.provider index: name_1 dup key: { name: "MonSuperFI-2" }`,
      ).should('exist');
    });

    it('if the title contains invalid chars', () => {
      const fi = {
        name: 'MonSuperFI-2',
        title: 'Mon Super avec un < dedans',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        discovery: 'false',
        userInfoUrl: 'https://issuer.fr/me',
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        emails: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
        token_endpoint_auth_method: 'client_secret_post',
      };

      createIdentityProvider(fi, basicConfiguration);
      cy.url().should('eq', `${BASE_URL}/identity-provider/create`);
      cy.contains(
        `Veuillez mettre un titre valide ( majuscule, minuscule, nombres et '.:_/!+- [espace] )`,
      ).should('exist');
    });

    it('if the totp is invalid', () => {
      const fi = {
        name: 'MonSuperFI-3',
        title: 'Mon Super FI 3 mais mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        discovery: 'false',
        jwksUrl: 'https://issuer.fr/jwks',
        userInfoUrl: 'https://issuer.fr/me',
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        trustedIdentity: 'true',
        active: 'true',
        display: 'true',
        emails: 'sherman@kaliop.com\nvbonnard@kaliopmail.com',
        token_endpoint_auth_method: 'client_secret_post',
      };

      basicConfiguration.totp = false;

      createIdentityProvider(fi, basicConfiguration);
      cy.url().should('eq', `${BASE_URL}/identity-provider/create`);
      cy.contains(`Le TOTP saisi n'est pas valide`).should('exist');
      assertFormValues(fi);
    });
  });
});
