import { USER_OPERATOR, USER_PASS } from '../../../../shared/cypress/support/constants';
import {
  useMenuToIndisponibilitePage,
  validFilledForm,
  invalidTotpFilledForm,
  invalidFormMessageFilledForm,
  invalidXSSFormMessageFilledForm,
  invalidFormDateDebutFilledForm,
  invalidFormHeureDebutFilledForm,
  emptyForm
} from './indisponibiite-update.util';

const BASE_URL = Cypress.config('baseUrl');

describe(' Modify "indisponibilité" message', () => {
  before(() => cy.resetEnv('mongoFC'));
  beforeEach(() => {
    cy.login(USER_OPERATOR, USER_PASS);
    useMenuToIndisponibilitePage();
  });

  describe('Should be successful', () => {
    it('if when click to configuration/indisponibilite button, page show a form', () => {
      cy.get(`form`).should('be.visible');
    });

    it('if a valid form is submit', () => {
      validFilledForm();
      cy.get('button[type="submit"]').click();

      cy.url().should('eq', `${BASE_URL}/configuration/indisponibilite`);
      cy.contains(`Message d'indisponibilité activé avec succès !`);
    });
  });

  describe('Should fail', () => {
    it('if the form is empty', () => {
      emptyForm();
      cy.url().should('eq', `${BASE_URL}/configuration/indisponibilite`);
    });

    it('if the message field is empty', () => {
      invalidFormMessageFilledForm();
      cy.get('textarea[name="message"]').should('have.class', 'is-invalid');
      cy.url().should('eq', `${BASE_URL}/configuration/indisponibilite`);
    });

    it('should mark message field invalid in case of XSS attack', () => {
      invalidXSSFormMessageFilledForm();
      cy.get('textarea[name="message"]').should('have.class', 'is-invalid');
      cy.url().should('eq', `${BASE_URL}/configuration/indisponibilite`);
    });

    it('if the start date is after the stop date', () => {
      invalidFormDateDebutFilledForm();

      cy.get('input[name="dateDebut"]').should('have.class', 'is-invalid');
      cy.get('input[name="heureDebut"]').should('have.class', 'is-invalid');
      cy.get('button[type="submit"]').should('have.attr', 'disabled');
      cy.url().should('eq', `${BASE_URL}/configuration/indisponibilite`);
    });

    it('if the start hour is after the stop hour', () => {
      invalidFormHeureDebutFilledForm();
      cy.get('input[name="heureDebut"]').should('have.class', 'is-invalid');
      cy.get('input[name="heureFin"]').should('have.class', 'is-invalid');
      cy.get('button[type="submit"]').should('have.attr', 'disabled');
      cy.url().should('eq', `${BASE_URL}/configuration/indisponibilite`);
    });

    it('if the TOTP field is empty', () => {
      invalidTotpFilledForm();

      cy.url().should('eq', `${BASE_URL}/configuration/indisponibilite`);
      cy.contains(`Le TOTP saisi n'est pas valide`);
    });
  });
});
