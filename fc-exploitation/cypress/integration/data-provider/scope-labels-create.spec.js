import { USER_OPERATOR, USER_PASS } from '../../../../shared/cypress/integration/util/constants.util';
import { login } from '../../../../shared/cypress/integration/util/login.util';
import { useMenuToFdPage, createScopeLabels } from './data-provider.utils';
import { resetMongoFC } from '../../../../shared/cypress/integration/util/prepare.util';

describe('Add new scope label', () => {
  before(resetMongoFC);
  let basicConfiguration;
  beforeEach(() => {
    basicConfiguration = {
      totp: true,
      _csrf: true,
    };
    login(USER_OPERATOR, USER_PASS);
    useMenuToFdPage();
  });

  describe('Should be successful', () => {
    it('if when click to "Fournisseur de données" button, page show a list of scope label', () => {
      cy.get(`table`).should('be.visible');
    });

    it('if a valid form is submit', () => {
      const scopeLabel = {
        scope: 'Seldon',
        label: 'Seldon Label',
        fd: 'DGFIP',
      };

      createScopeLabels(scopeLabel, basicConfiguration);
      cy.get('button[type="submit"]').click();   

      cy.url().should('eq', `${Cypress.env('BASE_URL')}/data-provider/label`);
      cy.contains(`Le label ${scopeLabel.label} pour le scope ${scopeLabel.scope} a été créé avec succès !`);
    });
  });

  describe('Should fail', () => {
    it('if a valid form is submit but scope name already exist', () => {
      const scopeLabel = {
        scope: 'Seldon',
        label: 'Seldon Label (dgfip)',
        fd: 'DGFIP',
      };

      createScopeLabels(scopeLabel, basicConfiguration);
      cy.get('button[type="submit"]').click();
      

      cy.url().should('eq', `${Cypress.env('BASE_URL')}/data-provider/label/create`);
      cy.contains(`Impossible d'enregistrer le label`);
    });

    it('if a invalid form is submit with invalid totp', () => {
      const scopeLabel = {
        scope: 'Seldon1',
        label: 'Seldon1 Label',
        fd: 'DGFIP',
      };
      basicConfiguration.totp = false;
      createScopeLabels(scopeLabel, basicConfiguration);
      cy.get('button[type="submit"]').click();

      cy.url().should('eq', `${Cypress.env('BASE_URL')}/data-provider/label/create`);
      cy.contains(`Le TOTP saisi n'est pas valide`);
    });

    it('if scope field is empty', () => {
      const scopeLabel = {
        label: 'Seldon2 Label (dgfip)',
        fd: 'DGFIP',
      };

      createScopeLabels(scopeLabel, basicConfiguration);
      cy.get('button[type="submit"]').click();
      

      cy.url().should('eq', `${Cypress.env('BASE_URL')}/data-provider/label/create`);
      cy.get('input[name="scope"]').should('have.class', 'is-invalid');
    });

    it('if label field is empty', () => {
      const scopeLabel = {
        scope: 'Seldon2',
        fd: 'DGFIP',
      };

      createScopeLabels(scopeLabel, basicConfiguration);
      cy.get('button[type="submit"]').click();
      

      cy.url().should('eq', `${Cypress.env('BASE_URL')}/data-provider/label/create`);
      cy.get('input[name="label"]').should('have.class', 'is-invalid');
    });
  });
});
