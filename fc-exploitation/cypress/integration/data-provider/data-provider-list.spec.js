import {
  USER_OPERATOR,
  USER_SECURITY,
  USER_PASS,
} from '../../../../shared/cypress/support/constants';

const BASE_URL = Cypress.config('baseUrl');

describe('Data provider listing', () => {
  before(() => {
    cy.resetEnv('mongo');
    cy.login(USER_OPERATOR, USER_PASS);
  });

  describe('List data providers as Operator', () => {
    beforeEach(() => {
      cy.login(USER_OPERATOR, USER_PASS);
    });

    it('I can view the list of registered data providers', () => {
      cy.get('li .nav-link')
        .contains('Fournisseurs de données')
        .click();

      cy.contains('2 fournisseurs provisionnés et actifs').should('be.visible');
      cy.contains('Fournisseur de données Mock - 1').should('be.visible');
      cy.contains('Fournisseur de données Mock - 2').should('be.visible');

      // client ID of the first data provider
      cy.contains('423dcbdc5a15ece61ed00ff5989d72379c26d9ed4c8e4e05a87cffae019586e0').should('be.visible');
    });

    it('I can click on the name of the FD to go to the update page', () => {
      cy.visit(`/data-provider?sort=active&action=desc`);

      cy.get('[id^="provider-"]:first').click();

      cy.url().should(
        'match',
        new RegExp(`${BASE_URL}\/data-provider\/[0-9a-f]{24}`),
      );
    });

    it('I can click on the client ID of the FD to go to the update secret page', () => {
      cy.visit(`/data-provider`);

      cy.get('[id^="client_id-"]:first').click({ force: true });

      cy.url().should(
        'match',
        new RegExp(
          `${BASE_URL}\/data-provider\/update\/[0-9a-f]{24}\/secret`,
        ),
      );
    });
  });

  describe('List data providers as Security', () => {
    beforeEach(() => {
      cy.login(USER_SECURITY, USER_PASS);
    });

    it("I can't click on the name of the FD to go to the update page", () => {
      cy.visit(`/data-provider?sort=active&action=desc`);

      cy.get('#list-table > tbody > tr:first > th').then($el => {
        expect($el).to.not.have.descendants('a');
      });
    });

    it("I can't click on the client ID of the FD to go to the update secret page", () => {
      cy.visit(`/data-provider?sort=active&action=desc`);

      cy.get('#list-table > tbody > tr:first > td').then($el => {
        expect($el).to.not.have.descendants('a');
      });
    });
  });
});
