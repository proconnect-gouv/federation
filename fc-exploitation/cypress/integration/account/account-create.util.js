import { USER_ADMIN } from '../constants.util';
import { login, logout } from '../login.util';
import * as otplib from 'otplib';

export function createUserAccount (userInfo, basicConfiguration) {
	cy.contains('Comptes utilisateurs').click();
	cy.contains('Créer un utilisateur').click();
	
	cy.get('#username').type(`${userInfo.username}`);
	cy.get('#email').type(`${userInfo.email}`);

	if (basicConfiguration.adminRole) {
		cy.get('form').find('[id="role-admin"]').check();
	}

	if (basicConfiguration.operatorRole) {
		cy.get('form').find('[id="role-operator"]').check();
	}

	// change csrf token
	if (!basicConfiguration._csrf) {
		cy.get('input[name="_csrf"]').then((csrf) => {
			csrf[0].value = 'obviouslyBadCSRF';
		});
	}

	cy.contains('Créer l\'utilisateur').click();
}

export function createUserAndLogWith (userInfo, basicConfiguration) {
	cy.contains('Comptes utilisateurs').click();
	cy.contains('Créer un utilisateur').click();

	cy.get('#username').type(`${userInfo.username}`);
	cy.get('#email').type(`${userInfo.email}`);
	cy.get('form').find('[id="role-admin"]').check();
	cy.get('form').find('[id="role-operator"]').check();
	
	cy.get('#tmpPassword').then(tmpPassword => {
		cy.contains('Créer l\'utilisateur').click();
		logout(USER_ADMIN);
		// login with new user created
		login(userInfo.username, tmpPassword[0].textContent);
	});

	// retrieve secret hash
	cy.get('#secret > td').then(secret => {
		cy.get('#password').type(`${userInfo.password}`);
		cy.get('#confirm-password').type(`${userInfo.password}`);
		if (basicConfiguration.totp) {
			cy.get('input[name="_totp"]').then(totp => {
				const token = otplib.authenticator.generate(secret[0].textContent);
				cy.get('input[name="_totp"]').type(token);
			});
		} else {
			cy.get('input[name="_totp"]').type('000000');
		}
		cy.get('button[type="submit"]').click();
	});
}