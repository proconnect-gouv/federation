import {
  USER_OPERATOR,
  USER_ONLY_ADMIN,
  USER_SECURITY,
  USER_PASS,
  BASE_URL,
  LIMIT_PAGE,
} from '../constants.util';
import { login, logout } from '../login.util';

describe('Account', () => {
	it('should redirect the not connected user to https://exploitation.docker.dev-franceconnect.fr/login', () => {
		cy.visit(`${BASE_URL}/account`);
		cy.url().should('eq', `${BASE_URL}/login`);
  });
  
  describe('User has the OPERATOR role', () => {
    beforeEach(() => {
      login(USER_OPERATOR, USER_PASS)
      cy.contains('Comptes utilisateurs').click();
    });

    it('checking account page is well displayed', () => {
      cy.visit(`${BASE_URL}/account?page=1&limit=${LIMIT_PAGE}`);
      cy.get('tbody th').then(userRows => {
        expect(userRows.length).to.be.greaterThan(0)
      });

      cy.get('#users-count').then(users => {
        const sentence = users[0].innerText.split(" ");
        const number = parseInt(sentence[0]);

        expect(number).to.be.a('number');
      });
      logout(USER_OPERATOR);
    });

    it('should\'nt give access to deletion buttons inside account list', () => {
      cy.get('form[name="deleteForm"]').should('not.exist');
      logout(USER_OPERATOR);
    });
  });

  describe('User has the ADMIN role', () => {
    it('should redirect the user who has just the admin role to the account list page when he connects himself', () => {
      login(USER_ONLY_ADMIN, USER_PASS)

      cy.url().should('eq', `${BASE_URL}/account`);
      cy.contains('Gestion des utilisateurs');
      cy.contains('Fournisseurs de service').should('not.exist');
      cy.contains('Fournisseurs d\'identité').should('not.exist');
      cy.get('form[name="deleteForm"]').should('exist');

      logout(USER_ONLY_ADMIN);
    });
  });

  describe('User has the SECURITY role', () => {
    beforeEach(() => {
      login(USER_SECURITY, USER_PASS)
    });

    it('checking account / service provider / identity provider page is well displayed', () => {
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains('Fournisseurs de service').should('be.visible');
      cy.get('tbody tr').then(userRows => {
        expect(userRows.length).to.be.greaterThan(0)
      });
      
      cy.contains('Fournisseurs d\'identité').should('be.visible');
      cy.contains('Fournisseurs d\'identité').click();
      cy.get('tbody tr').then(userRows => {
        expect(userRows.length).to.be.greaterThan(0)
      });

      cy.contains('Comptes utilisateurs').should('be.visible');
      cy.contains('Comptes utilisateurs').click();
      cy.get('tbody tr').then(userRows => {
        expect(userRows.length).to.be.greaterThan(0)
      });
      cy.get('#users-count').then(users => {
        const sentence = users[0].innerText.split(" ");
        const number = parseInt(sentence[0]);

        expect(number).to.be.a('number');
      });

      logout(USER_SECURITY);
    });

    it('should\'nt give access to deletion buttons inside account / service provider / identity provider list', () => {
      cy.contains('Fournisseurs de service').click();
      cy.get('form[name="deleteForm"]').should('not.exist');

      cy.contains('Fournisseurs d\'identité').click();
      cy.get('form[name="deleteForm"]').should('not.exist');

      cy.contains('Comptes utilisateurs').click();
      cy.get('form[name="deleteForm"]').should('not.exist');
      
      logout(USER_SECURITY);
    });
  });
});