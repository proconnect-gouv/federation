import 'cypress-file-upload';
import {
  USER_OPERATOR,
  USER_PASS,
} from '../../../../shared/cypress/support/constants';

const BASE_URL = Cypress.config('baseUrl');

describe('Manage ministries', () => {
  let basicConfiguration;

  const ministry = {
    acronym: 'TM',
    name: 'Test Ministry',
    identityProviders: true,
  };

  before(() => {
    cy.resetEnv('mongoFC');

    basicConfiguration = {
      totp: true,
      _csrf: true,
      fast: true,
    };

    cy.login(USER_OPERATOR, USER_PASS);
    cy.visit(`${BASE_URL}/ministry`);

    cy.get('a[href="/ministry/create"').click();
    cy.url().should('eq', `${BASE_URL}/ministry/create`);

    cy.formFill(ministry, basicConfiguration);

    cy.get('button[type="submit"]')
      .contains('Ajouter un nouveau ministère')
      .click();

    cy.url().should('eq', `${BASE_URL}/ministry`);
    cy.get('.alert.alert-success').contains(
      `Le ministère "${ministry.name}" a bien été créé !`,
    );
  });
  beforeEach(() => {
    basicConfiguration = {
      totp: true,
      _csrf: true,
      fast: true,
    };

    cy.login(USER_OPERATOR, USER_PASS);
    cy.visit(`${BASE_URL}/ministry`);
  });

  it.skip('should not delete a ministry if action is cancel', () => {
    cy.get(`#delete-${ministry.acronym}`).click({ force: true });

    cy.contains('Annuler').click();

    cy.url().should('eq', `${BASE_URL}/ministry`);
    cy.contains(`${ministry.name}`).should('be.visible');
  });

  it.skip('should not delete a ministry if totp is not correct or empty', () => {
    cy.get(`#delete-${ministry.acronym}`).click({ force: true });

    cy.contains('Confirmer').click();
    cy.contains(`Le TOTP n'a pas été saisi`).should('be.visible');
    cy.get('#totpModal').type('000000');
    cy.contains('Confirmer').click();
    cy.contains(`Le TOTP saisi n'est pas valide`).should('be.visible');

    cy.url().should('eq', `${BASE_URL}/ministry`);
    cy.contains(`${ministry.name}`).should('be.visible');
  });

  it.skip('should delete an existing ministry', () => {
    cy.get(`#delete-${ministry.acronym}`).click({ force: true });

    cy.get('#totpModal').then(() => cy.totp(basicConfiguration));
    cy.contains('Confirmer').click();

    cy.url().should('eq', `${BASE_URL}/ministry`);
    cy.get('.alert.alert-success').contains(
      `Le ministère "${ministry.name}" a été supprimé avec succès !`,
    );
  });
});
