import {
  USER_OPERATOR,
  USER_PASS,
} from '../../../../shared/cypress/support/constants';

const BASE_URL = Cypress.config('baseUrl');

describe('Manage ministries', () => {
  let basicConfiguration;

  const ministryWithIdP = {
    acronym: 'TM',
    name: 'Test Ministry',
    identityProviders: true,
  };

  const ministryWithIdPModified = {
    acronym: 'TMM',
    name: 'Test Ministry Modified',
    identityProviders: [],
  };

  const ministryWithoutIdP = {
    acronym: 'TMNIDP',
    name: 'Test Ministry with no idp',
  };

  before(() => cy.resetEnv('mongoFC'));
  beforeEach(() => {
    basicConfiguration = {
      totp: true,
      _csrf: true,
      fast: true,
    };

    cy.login(USER_OPERATOR, USER_PASS);
    cy.visit(`${BASE_URL}/ministry`);
  });

  it.skip('display ministries list', () => {
    cy.get('p.h2').contains('Gestion des ministères');
  });

  it.skip('display ministry creation form', () => {
    cy.get('a[href="/ministry/create"').click();
    cy.url().should('eq', `${BASE_URL}/ministry/create`);
    cy.get('p.h2').contains('Ajouter un nouveau ministère');
  });

  it.skip('create a new minitry with all identity providers', () => {
    cy.get('a[href="/ministry/create"').click();
    cy.url().should('eq', `${BASE_URL}/ministry/create`);

    cy.formFill(ministryWithIdP, basicConfiguration);

    cy.get('button[type="submit"]')
      .contains('Ajouter un nouveau ministère')
      .click();

    cy.url().should('eq', `${BASE_URL}/ministry`);
    cy.get('.alert.alert-success').contains(
      'Le ministère "Test Ministry" a bien été créé !',
    );
  });

  it.skip('create a new minitry with no identity providers', () => {
    cy.get('a[href="/ministry/create"').click();
    cy.url().should('eq', `${BASE_URL}/ministry/create`);

    cy.formFill(ministryWithoutIdP, basicConfiguration);

    cy.get('button[type="submit"]')
      .contains('Ajouter un nouveau ministère')
      .click();

    cy.url().should('eq', `${BASE_URL}/ministry`);
    cy.get('.alert.alert-success').contains(
      'Le ministère "Test Ministry with no idp" a bien été créé !',
    );
  });

  it.skip('should not validate creation form', () => {
    cy.get('a[href="/ministry/create"').click();
    cy.url().should('eq', `${BASE_URL}/ministry/create`);

    cy.formFill({}, basicConfiguration);

    cy.get('button[type="submit"]')
      .contains('Ajouter un nouveau ministère')
      .click();

    cy.url().should('eq', `${BASE_URL}/ministry/create`);
    cy.get('input[name="acronym"]').should('have.class', 'is-invalid');
  });

  it.skip('should not validate creation form with an empty or wrong totp', () => {
    cy.get('a[href="/ministry/create"').click();
    cy.url().should('eq', `${BASE_URL}/ministry/create`);

    cy.formFill(ministryWithoutIdP, {});

    cy.get('button[type="submit"]')
      .contains('Ajouter un nouveau ministère')
      .click();
    cy.get('input[name="_totp"]').should('have.class', 'is-invalid');

    cy.get('input[name="_totp"]').type('000000');
    cy.get('button[type="submit"]')
      .contains('Ajouter un nouveau ministère')
      .click();

    cy.url().should('eq', `${BASE_URL}/ministry/create`);
    cy.get('.alert.alert-danger').contains(`Le TOTP saisi n'est pas valide`);
  });

  it.skip('modify an existing ministry and remove all identity providers', () => {
    cy.get(`#update-${ministryWithIdP.acronym}`).click({ force: true });

    cy.formFill(ministryWithIdPModified, basicConfiguration);

    cy.get('button[type="submit"]')
      .contains('Modifier un ministère')
      .click();

    cy.url().should('eq', `${BASE_URL}/ministry`);
    cy.get('.alert.alert-success').contains(
      'Le ministère "Test Ministry Modified" a bien été mis à jour !',
    );
  });

  it.skip('should not validate modification form with an empty or wrong totp', () => {
    cy.get(`#update-${ministryWithIdPModified.acronym}`).click({ force: true });

    cy.formFill({}, {});

    cy.get('button[type="submit"]')
      .contains('Modifier un ministère')
      .click();

    cy.get('input[name="_totp"]').should('have.class', 'is-invalid');

    cy.get('input[name="_totp"]').type('000000');

    cy.get('button[type="submit"]')
      .contains('Modifier un ministère')
      .click();

    cy.url().should('include', `${BASE_URL}/ministry/`);
    cy.get('.alert.alert-danger').contains(`Le TOTP saisi n'est pas valide`);
  });
});
