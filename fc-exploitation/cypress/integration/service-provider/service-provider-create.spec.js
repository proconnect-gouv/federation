import {
  USER_OPERATOR,
  USER_PASS,
} from '../../../../shared/cypress/support/constants';
import {
  createServiceProvider,
  uploadCSV,
} from './service-provider-create.utils';

const BASE_URL = Cypress.config('baseUrl');

const defaultConfig = {
  value: true,
  writable: false,
  enumerable: true,
  configurable: false,
};

const basicConfiguration = {
  fast: defaultConfig,
  typeEvent: {
    ...defaultConfig,
    value: false,
  },
  totp: defaultConfig,
};

describe('Service provider creation', () => {
  const spData = {
    name: 'MyFirstSP',
    redirectUri: 'https://url.com/login',
    redirectUriLogout: 'https://url.com/logout',
    site: 'https://url.com',
    emails: 'titlen@gmail.com',
    type: 'public',
    ipAddresses: '',
  };

  before(() => {
    Cypress.session.clearAllSavedSessions();
    cy.resetEnv('mongo');
  });
  beforeEach(() => {
    cy.clearBusinessLog();
    cy.login(USER_OPERATOR, USER_PASS);
  });

  describe('Should succeed', () => {
    it('if eidas level 1 is choosen', () => {
      // Action
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains('Créer un fournisseur de service').click();

      cy.formFill(spData, basicConfiguration);

      cy.totp({ totp: true });
      cy.get('form[name="fs-form"] button[type="submit"]').click();

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstSP a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();

      cy.hasBusinessLog({
        entity: 'service-provider',
        action: 'create',
        user: USER_OPERATOR,
      });
    });

    it('if we add a sp even with localhost as redirectUri (integration) ', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'MyFirstSP localhost',
          redirectUri: 'https://localhost:9000',
        },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstSP localhost a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a service provider even with localhost as redirectUriLogout ( integration ) ', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'MyFirstSP localhost logout',
          redirectUriLogout: 'https://localhost:9000/logout',
        },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstSP localhost logout a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a service provider with two logout redirections', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: '2 logout uris',
          redirectUriLogout: 'https://url.com/logout\rhttps://url.com/logout',
        },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service 2 logout uris a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a service provider with two redirect uris', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: '2 redirect uris',
          redirectUri: 'https://url.com\rhttps://url2.com/',
        },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service 2 redirect uris a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a service provider even with a mobile URI scheme as redirectUri ( integration ) ', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'MyFirstSP mobile URI scheme',
          redirectUri:
            'fc+app01://openid_redirect_url\rfranceconnect://openid_redirect_url\rFC-app.02://openid_redirect_url',
        },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstSP mobile URI scheme a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a service provider even with a mobile URI scheme as redirectUriLogout ( integration ) ', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'MyFirstSP mobile URI scheme logout',
          redirectUriLogout:
            'fc+app01://openid_redirect_url\rfranceconnect://openid_redirect_url\rFC-app.02://openid_redirect_url',
        },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstSP mobile URI scheme logout a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a service provider with two emails', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: '2 emails',
          emails: 'titlen@gmail.com\rsecondemail@gmail.com',
        },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service 2 emails a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a service provider with two ipAddresses', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: '2 ipAddresses',
          ipAddresses: '192.0.0.0\r1.1.1.1',
        },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service 2 ipAddresses a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a service provider with two websites', () => {
      // Arrange
      const fs = {
        ...spData,
        name: '2 websites',
        site: 'https://url.com\rhttps://secondsite.com',
      };

      // Action
      createServiceProvider(fs, basicConfiguration);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service 2 websites a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a service provider with no email', () => {
      // Action
      createServiceProvider(
        { ...spData, name: 'no email', emails: '' },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service no email a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('should have client secret in hexadecimal form', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'check hexa',
        },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service check hexa a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
      cy.contains('check hexa');
      cy.get('#list-table > tbody > tr > td')
        .eq(0)
        .click();
      cy.get('#client_secret')
        .invoke('val')
        .then(val => {
          const hexaConstraints = /[0-9A-Fa-f]{64}/g;
          const secretIsValid = hexaConstraints.test(val);
          expect(secretIsValid).to.be.true;
        });
    });

    describe('Create by CSV file', () => {
      it('if contains a "importer a csv" button', () => {
        // Arrange
        cy.url().should('eq', `${BASE_URL}/service-provider`);

        // Action
        cy.contains('Créer un fournisseur de service').click();

        // Assert
        cy.contains('Importer un CSV');
      });

      it('if display CSV name after import', () => {
        // Arrange
        const filename = 'valid_fs_comma';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`);
      });

      it('if fill form with CSVdata with comma', () => {
        // Arrange
        const filename = 'valid_fs_comma';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`, {
          timeout: 3000,
        });
        cy.get('#fs-form').within(() => {
          cy.get('input[id=name]').should('have.value', 'hello world');
          cy.get('textarea[id=site]').should(
            'have.value',
            'https://www.hello.com\nhttps://www.world.com',
          );
        });
      });

      it('if fill form with CSVdata with semicolon', () => {
        const filename = 'valid_fs_semicolon';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`);
        cy.get('#fs-form').within(() => {
          cy.get('input[id=name]').should('have.value', 'hello semicolon');
          cy.get('textarea[id=redirect_uris]').should(
            'have.value',
            'https://www.hello.com/callback\nhttps://www.world.com/callback',
          );
          cy.get('textarea[id=post_logout_redirect_uris]').should(
            'have.value',
            'https://www.hello.com/logout\nhttps://www.world.com/logout',
          );
          cy.get('textarea[id=site]').should(
            'have.value',
            'https://www.hello.com\nhttps://www.world.com',
          );
          cy.get('textarea[id=emails]').should('have.value', 'test@me.com');
          cy.get('textarea[id=IPServerAddressesAndRanges]').should(
            'have.value',
            '87.252.12.28\n195.25.216.208/28\n2001:0db8:0000:85a3:0000:0000:ac1f:8001',
          );

          cy.get('input[id=scope-openid]').should('have.attr', 'checked');
        });
      });

      it('if fill form without email field', () => {
        // Arrange
        const filename = 'valid_fs_comma';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#fs-form').within(() => {
          cy.get('input[id=name]').should('have.value', 'hello world');
          cy.get('textarea[id=site]').should(
            'have.value',
            'https://www.hello.com\nhttps://www.world.com',
          );
          cy.get('textarea[id=emails]').should('have.value', '');
        });
      });

      it('if fill form with CSVdata is submited', () => {
        // Arrange
        const filename = 'valid_fs_comma';

        // Action
        uploadCSV(filename);

        cy.get('textarea[id=emails]').type('w@hello.com\nw@world.com');
        cy.get('input[id=public]').check({
          force: true,
        });

        cy.totp(basicConfiguration);
        cy.get('button[type=submit]').click();

        // Assert
        cy.contains(
          `Le fournisseur de service hello world a été créé avec succès !`,
        );
      });

      it('unless an error of parsing appears', () => {
        // Arrange
        const filename = 'failed_fs';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`);
        cy.get('#alert_error').contains('Problème de parsing');
      });

      it('if fill form with CSVdata with empty value', () => {
        // Arrange
        const filename = 'valid_fs_with_empty_values_semicolon';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`);
        cy.get('#fs-form').within(() => {
          cy.get('input[id=name]').should('have.value', 'hello semicolon');
          cy.get('textarea[id=redirect_uris]').should(
            'have.value',
            'https://www.hello.com/callback\nhttps://www.world.com/callback',
          );
          cy.get('textarea[id=post_logout_redirect_uris]').should(
            'have.value',
            'https://www.hello.com/logout\nhttps://www.world.com/logout',
          );
          cy.get('textarea[id=site]').should(
            'have.value',
            'https://www.hello.com\nhttps://www.world.com',
          );
          cy.get('textarea[id=emails]').should('have.value', 'test@me.com');
          cy.get('textarea[id=IPServerAddressesAndRanges]').should(
            'have.value',
            '87.252.12.28\n195.25.216.208/28\n2001:0db8:0000:85a3:0000:0000:ac1f:8001',
          );

          cy.get('input[id=scope-openid]').should('have.attr', 'checked');
        });
      });

      it('if fill form with CSVdata with wrong key values added', () => {
        // Arrange
        const filename = 'valid_fs_with_extra_columns_semicolon';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`);
        cy.get('#fs-form').within(() => {
          cy.get('input[id=name]').should('have.value', 'hello semicolon');
          cy.get('textarea[id=redirect_uris]').should(
            'have.value',
            'https://www.hello.com/callback\nhttps://www.world.com/callback',
          );
          cy.get('textarea[id=post_logout_redirect_uris]').should(
            'have.value',
            'https://www.hello.com/logout\nhttps://www.world.com/logout',
          );
          cy.get('textarea[id=site]').should(
            'have.value',
            'https://www.hello.com\nhttps://www.world.com',
          );
          cy.get('textarea[id=emails]').should('have.value', 'test@me.com');
          cy.get('textarea[id=IPServerAddressesAndRanges]').should(
            'have.value',
            '87.252.12.28\n195.25.216.208/28\n2001:0db8:0000:85a3:0000:0000:ac1f:8001',
          );

          cy.get('input[id=scope-openid]').should('have.attr', 'checked');
        });
      });
    });

    it('if we add a URIScheme in redirectUri field', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'MyFirstSP URIScheme',
          redirectUri:
            'franceconnect://url.com\rhttps://secondsite.com\rlocalhost',
        },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstSP URIScheme a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a URIScheme in redirectUriLogout field', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'MyFirstSP URIScheme',
          redirectUriLogout:
            'franceconnect://url.com/logout\rhttps://secondsite.com/logout\rlocalhost:3000/logout',
        },
        basicConfiguration,
      );

      cy.contains(
        `Le fournisseur de service MyFirstSP URIScheme a été créé avec succès !`,
      );
    });

    it('if we add a sp with no redirectUri, redirectUriLogout, site and ip', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'champs optionnels',
          redirectUri: '',
          redirectUriLogout: '',
          site: '',
          ipAddresses: '',
        },
        basicConfiguration,
      );

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);

      cy.contains(
        `Le fournisseur de service champs optionnels a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a name containing all kind of authorized chars', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'My_FS with 42 : ÉçïœâùÆ/ÙÈ.com+2 & ee',
          redirectUri:
            'franceconnect://url.com\rhttps://secondsite.com\rlocalhost',
          redirectUriLogout:
            'franceconnect://url.com/logout\rhttps://secondsite.com/logout\rlocalhost:3000/logout',
        },
        basicConfiguration,
      );

      cy.contains(
        `Le fournisseur de service My_FS with 42 : ÉçïœâùÆ/ÙÈ.com+2 & ee a été créé avec succès !`,
      );
    });

    it('if we add a fs with an entityId', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'My_FS with an entityId',
          entityId:
            '0a0cd64372db6ecf39c317c0c74ce90f02d8ad7d510ce054883b759d666a996bc',
        },
        basicConfiguration,
      );

      cy.contains(
        `Le fournisseur de service My_FS with an entityId a été créé avec succès !`,
      );
    });
  });

  describe('Should fail', () => {
    it('if the validation form failed, it should re-gererate the csrf', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'MyFirstSP',
          ipAddresses: 'Obviously not an IP',
        },
        basicConfiguration,
      );

      // Assert
      cy.get('input[name="_csrf"]').should('not.have.value', '');
    });

    it('if an error occured in the form, we display errors (empty fields) ', () => {
      // Action
      createServiceProvider(
        {
          name: '',
          redirectUri: '',
          redirectUriLogout: '',
          site: '',
          emails: '',
          ipAddresses: '',
        },
        basicConfiguration,
      );

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre un nom valide ( majuscule, minuscule, nombres et '.:_/!+- [espace] )`,
      )
        .scrollIntoView()
        .should('be.visible');
      cy.get('[name="redirectUri"]').should('be.empty');
      cy.get('[name="redirectUriLogout"]').should('be.empty');
      cy.contains(
        `Veuillez mettre des emails valides ( Ex: email@email.com )`,
      ).should('not.be.visible');
      cy.get('[name="ipAddresses"]').should('be.empty');
    });

    it('if an error occured in the form, we display an error (name)', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: '',
        },
        basicConfiguration,
      );

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre un nom valide ( majuscule, minuscule, nombres et '.:_/!+- [espace] )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (name with html)', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'test avec <script>',
        },
        basicConfiguration,
      );

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre un nom valide ( majuscule, minuscule, nombres et '.:_/!+- [espace] )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (redirectUris)', () => {
      createServiceProvider(
        {
          ...spData,
          name: 'Good Name',
          redirectUri: '****',
        },
        basicConfiguration,
      );
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre une URL valide ( Ex: https://urlvalide.com/ )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (redirectUriLogout)', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'Good Name',
          redirectUriLogout: '***',
        },
        basicConfiguration,
      );

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre une URL valide ( Ex: https://urlvalide.com/logout )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (site)', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'Good name',
          site: '***',
        },
        basicConfiguration,
      );

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre une URL valide ( Ex: https://site.com/ )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (emails)', () => {
      // Arrange
      const errorFs = {
        ...spData,
        name: 'Good name',
        emails: '****',
      };

      // Action
      createServiceProvider(errorFs, basicConfiguration);

      // Assert
      cy.contains(`Veuillez mettre des emails valides ( Ex: email@email.com )`)
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (ips addresses)', () => {
      // Action
      createServiceProvider(
        {
          ...spData,
          name: 'Good name',
          ipAddresses: '****',
        },
        basicConfiguration,
      );

      // Assert
      cy.contains(`Veuillez mettre des ips valides ( Ex: 1.1.1.1 )`)
        .scrollIntoView()
        .should('be.visible');
    });
  });
});
