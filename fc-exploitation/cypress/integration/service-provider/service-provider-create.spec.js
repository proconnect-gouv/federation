import {
  USER_OPERATOR,
  USER_PASS,
} from '../../../../shared/cypress/support/constants';
import {
  createServiceProvider,
  uploadCSV,
} from './service-provider-create.utils';

const BASE_URL = Cypress.config('baseUrl');

const config = {
  value: false,
  writable: false,
  enumerable: true,
  configurable: false,
};
const basicConfiguration = {};
Object.defineProperty(basicConfiguration, 'fast', {
  ...config,
  value: true,
});
Object.defineProperty(basicConfiguration, 'typeEvent', {
  ...config,
});
Object.defineProperty(basicConfiguration, 'totp', {
  ...config,
  value: true,
});

describe('Service provider creation', () => {
  before(() => {
    Cypress.session.clearAllSavedSessions();
    cy.resetEnv('mongoFC')
  });
  beforeEach(() => {
    cy.clearBusinessLog();

    cy.login(USER_OPERATOR, USER_PASS);
  });

  describe('Should succeed', () => {
    it('if eidas level 2 is choosen', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fsLow = {
        name: 'MyFirstFS low',
        signupId: '123456',
        redirectUri: 'https://localhost:9000',
        redirectUriLogout: 'https://url.com/logout',
        site: 'https://url.com',
        jwksUri: 'https://url.com/jwks',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        trustedIdentity: 'false',
        type: 'public',
        eidas: '1',
        platform: 'CORE_FCP',
      };
      // Action
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains('Créer un fournisseur de service').click();

      cy.formFill(fsLow, mockConfig);

      cy.get('#algo-field').should('not.exist');

      const fsHigh = {
        name: 'MyFirstFS high',
        signupId: '123456',
        redirectUri: 'https://localhost:9000',
        redirectUriLogout: 'https://url.com/logout',
        site: 'https://url.com',
        jwksUri: 'https://url.com/jwks',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        type: 'public',
        trustedIdentity: 'false',
        eidas: '2',
      };
      // Action
      cy.formFill(fsHigh, mockConfig);

      cy.get('#algo-field').within(() => {
        cy.get('[name=userinfo_encrypted_response_enc]');
        cy.get('[name=userinfo_encrypted_response_alg]');
        cy.get('[name=userinfo_signed_response_alg]');
        cy.get('[name=id_token_signed_response_alg]');
        cy.get('[name=id_token_encrypted_response_alg]');
        cy.get('[name=id_token_encrypted_response_enc]');
      });

      cy.totp({ totp: true });
      cy.get('form[name="fs-form"] button[type="submit"]').click();

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstFS high a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();

      cy.hasBusinessLog({
        entity: 'service-provider',
        action: 'create',
        user: USER_OPERATOR,
      });
    });

    it('if we add a fs even with localhost as redirectUri ( integration ) ', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'MyFirstFS localhost no logout',
        signupId: '123456',
        redirectUri: 'https://localhost:9000',
        redirectUriLogout: 'https://url.com/logout',
        site: 'https://url.com',
        jwksUri: 'https://url.com/jwks',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };
      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstFS localhost no logout a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a fs even with locahost as redirectUriLogout ( integration ) ', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };
      const fs = {
        name: 'MyFirstFS localhost logout',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://localhost:9000/logout',
        site: 'https://url.com',
        jwksUri: 'https://url.com/jwks',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstFS localhost logout a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a fs with two redirection logout', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: '2 logout uris',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout\rhttps://url.com/logout',
        site: 'https://url.com',
        jwksUri: 'https://url.com/jwks',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service 2 logout uris a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a fs with two redirection uris', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: '2 redirect uris',
        signupId: '123456',
        redirectUri: 'https://url.com\rhttps://url2.com/',
        redirectUriLogout: 'https://url.com/logout',
        site: 'https://url.com',
        jwksUri: 'https://url.com/jwks',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service 2 redirect uris a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a fs even with a mobile URI scheme as redirectUri ( integration ) ', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'MyFirstFS mobile URI scheme',
        signupId: '123456',
        redirectUri:
          'fc+app01://openid_redirect_url\rfranceconnect://openid_redirect_url\rFC-app.02://openid_redirect_url',
        redirectUriLogout: 'https://url.com/logout',
        site: 'https://url.com',
        jwksUri: 'https://url.com/jwks',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };
      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstFS mobile URI scheme a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a fs even with a mobile URI scheme as redirectUriLogout ( integration ) ', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };
      const fs = {
        name: 'MyFirstFS mobile URI scheme logout',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout:
          'fc+app01://openid_redirect_url\rfranceconnect://openid_redirect_url\rFC-app.02://openid_redirect_url',
        site: 'https://url.com',
        jwksUri: 'https://url.com/jwks',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstFS mobile URI scheme logout a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a fs with two emails', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: '2 emails',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        site: 'https://url.com',
        emails: 'titlen@gmail.com\rsecondemail@gmail.com',
        jwksUri: 'https://url.com/jwks',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service 2 emails a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a fs with two ipAddresses', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: '2 ipAddresses',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0\r1.1.1.1',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service 2 ipAddresses a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a fs with two site', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: '2 site',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        site: 'https://url.com\rhttps://secondsite.com',
        jwksUri: 'https://url.com/jwks',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(`Le fournisseur de service 2 site a été créé avec succès !`);
      cy.get('.alert-success > .close').click();
    });

    it('if we add a fs with no emails', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'no emails',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: '',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service no emails a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a fs with no signupId', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'no signupId',
        signupId: '',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'titlen@gmail.com\rsecondemail@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service no signupId a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('should have client secret in hexadecimal form', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'check hexa',
        signupId: '1234',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'titlen@gmail.com\rsecondemail@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service check hexa a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
      cy.contains('check hexa');
      cy.get('#list-table > tbody > tr > td')
        .eq(0)
        .click();
      cy.get('#client_secret')
        .invoke('val')
        .then(val => {
          const hexaConstraints = /[0-9A-Fa-f]{64}/g;
          const secretIsValid = hexaConstraints.test(val);
          expect(secretIsValid).to.be.true;
        });
    });

    describe('Create by CSV file', () => {
      it('if contains a "importer a csv" button', () => {
        // Arrange
        cy.url().should('eq', `${BASE_URL}/service-provider`);

        // Action
        cy.contains('Créer un fournisseur de service').click();

        // Assert
        cy.contains('Importer un CSV');
      });

      it('if display CSV name after import', () => {
        // Arrange
        const filename = 'valid_fs_comma';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`);
      });

      it('if fill form with CSVdata with comma', () => {
        // Arrange
        const filename = 'valid_fs_comma';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`, {
          timeout: 3000,
        });
        cy.get('#fs-form').within(() => {
          cy.get('input[id=name]').should('have.value', 'hello world');
          cy.get('textarea[id=site]').should(
            'have.value',
            'https://www.hello.com\nhttps://www.world.com',
          );
        });
      });

      it('if fill form with CSVdata with semicolon', () => {
        const filename = 'valid_fs_semicolon';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`);
        cy.get('#fs-form').within(() => {
          cy.get('input[id=name]').should('have.value', 'hello semicolon');
          cy.get('input[id=signup_id]').should('have.value', '1234567890');
          cy.get('textarea[id=redirect_uris]').should(
            'have.value',
            'https://www.hello.com/callback\nhttps://www.world.com/callback',
          );
          cy.get('textarea[id=post_logout_redirect_uris]').should(
            'have.value',
            'https://www.hello.com/logout\nhttps://www.world.com/logout',
          );
          cy.get('textarea[id=site]').should(
            'have.value',
            'https://www.hello.com\nhttps://www.world.com',
          );
          cy.get('textarea[id=emails]').should('have.value', 'test@me.com');
          cy.get('textarea[id=IPServerAddressesAndRanges]').should(
            'have.value',
            '87.252.12.28\n195.25.216.208/28\n2001:0db8:0000:85a3:0000:0000:ac1f:8001',
          );

          cy.get('input[id=scope-openid]').should('have.attr', 'checked');
        });
      });

      it('if fill form without email field', () => {
        // Arrange
        const filename = 'valid_fs_comma';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#fs-form').within(() => {
          cy.get('input[id=name]').should('have.value', 'hello world');
          cy.get('textarea[id=site]').should(
            'have.value',
            'https://www.hello.com\nhttps://www.world.com',
          );
          cy.get('textarea[id=emails]').should('have.value', '');
        });
      });

      it('if fill form with CSVdata is submited', () => {
        // Arrange
        const filename = 'valid_fs_comma';

        // Action
        uploadCSV(filename);

        cy.get('textarea[id=emails]').type('w@hello.com\nw@world.com');
        cy.get('input[id=public]').check({
          force: true,
        });

        cy.totp(basicConfiguration);
        cy.get('button[type=submit]').click();

        // Assert
        cy.contains(
          `Le fournisseur de service hello world a été créé avec succès !`,
        );
      });

      it('unless an error of parsing appears', () => {
        // Arrange
        const filename = 'failed_fs';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`);
        cy.get('#alert_error').contains('Problème de parsing');
      });

      it('if fill form with CSVdata with empty value', () => {
        // Arrange
        const filename = 'valid_fs_with_empty_values_semicolon';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`);
        cy.get('#fs-form').within(() => {
          cy.get('input[id=name]').should('have.value', 'hello semicolon');
          cy.get('input[id=signup_id]').should('have.value', '1234567890');
          cy.get('textarea[id=redirect_uris]').should(
            'have.value',
            'https://www.hello.com/callback\nhttps://www.world.com/callback',
          );
          cy.get('textarea[id=post_logout_redirect_uris]').should(
            'have.value',
            'https://www.hello.com/logout\nhttps://www.world.com/logout',
          );
          cy.get('textarea[id=site]').should(
            'have.value',
            'https://www.hello.com\nhttps://www.world.com',
          );
          cy.get('textarea[id=emails]').should('have.value', 'test@me.com');
          cy.get('textarea[id=IPServerAddressesAndRanges]').should(
            'have.value',
            '87.252.12.28\n195.25.216.208/28\n2001:0db8:0000:85a3:0000:0000:ac1f:8001',
          );

          cy.get('input[id=scope-openid]').should('have.attr', 'checked');
        });
      });

      it('if fill form with CSVdata with wrong key values added', () => {
        // Arrange
        const filename = 'valid_fs_with_extra_columns_semicolon';

        // Action
        uploadCSV(filename);

        // Assert
        cy.get('#file-name').contains(`${filename}.csv`);
        cy.get('#fs-form').within(() => {
          cy.get('input[id=name]').should('have.value', 'hello semicolon');
          cy.get('input[id=signup_id]').should('have.value', '1234567890');
          cy.get('textarea[id=redirect_uris]').should(
            'have.value',
            'https://www.hello.com/callback\nhttps://www.world.com/callback',
          );
          cy.get('textarea[id=post_logout_redirect_uris]').should(
            'have.value',
            'https://www.hello.com/logout\nhttps://www.world.com/logout',
          );
          cy.get('textarea[id=site]').should(
            'have.value',
            'https://www.hello.com\nhttps://www.world.com',
          );
          cy.get('textarea[id=emails]').should('have.value', 'test@me.com');
          cy.get('textarea[id=IPServerAddressesAndRanges]').should(
            'have.value',
            '87.252.12.28\n195.25.216.208/28\n2001:0db8:0000:85a3:0000:0000:ac1f:8001',
          );

          cy.get('input[id=scope-openid]').should('have.attr', 'checked');
        });
      });
    });

    it('if we add a URIScheme in redirectUri field', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'MyFirstFS URIScheme',
        signupId: '123456',
        redirectUri:
          'franceconnect://url.com\rhttps://secondsite.com\rlocalhost',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };
      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);
      cy.contains(
        `Le fournisseur de service MyFirstFS URIScheme a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a URIScheme in redirectUriLogout field', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'MyFirstFS URIScheme',
        signupId: '123456',
        redirectUri:
          'franceconnect://url.com\rhttps://secondsite.com\rlocalhost',
        redirectUriLogout:
          'franceconnect://url.com/logout\rhttps://secondsite.com/logout\rlocalhost:3000/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: '1',
        platform: 'CORE_FCP',
      };
      // Action
      createServiceProvider(fs, mockConfig);

      cy.contains(
        `Le fournisseur de service MyFirstFS URIScheme a été créé avec succès !`,
      );
    });

    it('if we add a fs with no redirectUri, redirectUriLogout, site ip, and jwksUri', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'champs optionnels',
        signupId: '123456',
        redirectUri: '',
        redirectUriLogout: '',
        site: '',
        jwksUri: '',
        emails: 'titlen@gmail.com',
        ipAddresses: '',
        eidas: 1,
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.url().should('eq', `${BASE_URL}/service-provider`);

      cy.contains(
        `Le fournisseur de service champs optionnels a été créé avec succès !`,
      );
      cy.get('.alert-success > .close').click();
    });

    it('if we add a name containing all kind of authorized chars', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'My_FS with 42 : ÉçïœâùÆ/ÙÈ.com+2 & ee',
        signupId: '123456',
        redirectUri:
          'franceconnect://url.com\rhttps://secondsite.com\rlocalhost',
        redirectUriLogout:
          'franceconnect://url.com/logout\rhttps://secondsite.com/logout\rlocalhost:3000/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: 1,
        platform: 'CORE_FCP',
      };
      // Action
      createServiceProvider(fs, mockConfig);

      cy.contains(
        `Le fournisseur de service My_FS with 42 : ÉçïœâùÆ/ÙÈ.com+2 & ee a été créé avec succès !`,
      );
    });

    it('if we add a fs with an entityId', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'My_FS with an entityId',
        signupId: '123456',
        redirectUri:
          'franceconnect://url.com\rhttps://secondsite.com\rlocalhost',
        redirectUriLogout:
          'franceconnect://url.com/logout\rhttps://secondsite.com/logout\rlocalhost:3000/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: 1,
        entityId:
          'a0cd64372db6ecf39c317c0c74ce90f02d8ad7d510ce054883b759d666a996bc',
        platform: 'CORE_FCP',
      };
      // Action
      createServiceProvider(fs, mockConfig);

      cy.contains(
        `Le fournisseur de service My_FS with an entityId a été créé avec succès !`,
      );
    });

    it('if we check cnam_paiements_ij as scope', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'My_FS with cnam_paiements_ij within his scopes',
        signupId: '123456',
        redirectUri:
          'franceconnect://url.com\rhttps://secondsite.com\rlocalhost',
        redirectUriLogout:
          'franceconnect://url.com/logout\rhttps://secondsite.com/logout\rlocalhost:3000/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'titlen@gmail.com',
        ipAddresses: '192.0.0.0',
        eidas: 1,
        scopes: ['cnam_paiements_ij'],
        platform: 'CORE_FCP',
      };
      // Action
      createServiceProvider(fs, mockConfig);

      cy.contains(
        `Le fournisseur de service My_FS with cnam_paiements_ij within his scopes a été créé avec succès !`,
      );
    });
  });

  describe('Should fail', () => {

    it('if the validation form failed, it should re-gererate the csrf', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const fs = {
        name: 'MyFirstFS',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'valenttin@gmail.com',
        ipAddresses: 'Obviously not an IP',
        eidas: 1,
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(fs, mockConfig);

      // Assert
      cy.get('input[name="_csrf"]').should('not.have.value', '');
    });

    it('if an error occured in the form, we display errors (empty fields) ', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const errorFs = {
        name: '',
        signupId: '',
        redirectUri: '',
        redirectUriLogout: '',
        jwksUri: '',
        site: '',
        emails: '',
        ipAddresses: '',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(errorFs, mockConfig);

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre un nom valide ( majuscule, minuscule, nombres et '.:_/!+- [espace] )`,
      )
        .scrollIntoView()
        .should('be.visible');
      cy.contains(
        `Veuillez mettre un identifiant signUP valide ( chiffres seulement )`,
      ).should('not.be.visible');
      cy.get('[name="redirectUri"]').should('be.empty');
      cy.get('[name="redirectUriLogout"]').should('be.empty');
      cy.contains(
        `Veuillez mettre des emails valides ( Ex: email@email.com )`,
      ).should('not.be.visible');
      cy.get('[name="ipAddresses"]').should('be.empty');
    });

    it('if an error occured in the form, we display an error (name)', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };
      const errorFs = {
        name: '',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'test@test.com',
        ipAddresses: '1.1.1.1',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(errorFs, mockConfig);

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre un nom valide ( majuscule, minuscule, nombres et '.:_/!+- [espace] )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (name with html)', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };
      const errorFs = {
        name: 'test avec <script>',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'test@test.com',
        ipAddresses: '1.1.1.1',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(errorFs, mockConfig);

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre un nom valide ( majuscule, minuscule, nombres et '.:_/!+- [espace] )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (redirectUris)', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const errorFs = {
        name: 'Good Name',
        signupId: '123456',
        redirectUri: '****',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'test@test.com',
        ipAddresses: '1.1.1.1',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      createServiceProvider(errorFs, mockConfig);
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre une URL valide ( Ex: https://urlvalide.com/ )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (redirectUriLogout)', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const errorFs = {
        name: 'Good Name',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: '***',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'test@test.com',
        ipAddresses: '1.1.1.1',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(errorFs, mockConfig);

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre une URL valide ( Ex: https://urlvalide.com/logout )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (site)', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const errorFs = {
        name: 'Good name',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: '***',
        emails: 'test@test.com',
        ipAddresses: '1.1.1.1',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(errorFs, mockConfig);

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre une URL valide ( Ex: https://site.com/ )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (emails)', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const errorFs = {
        name: 'Good name',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: '****',
        ipAddresses: '1.1.1.1',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(errorFs, mockConfig);

      // Assert
      cy.contains(`Veuillez mettre des emails valides ( Ex: email@email.com )`)
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (ips addresses)', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const errorFs = {
        name: 'Good name',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'test@test.com',
        ipAddresses: '****',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(errorFs, mockConfig);

      // Assert
      cy.contains(`Veuillez mettre des ips valides ( Ex: 1.1.1.1 )`).should(
        'be.visible',
      );
    });

    it('if an error occured in the form, we display an error (jwksUri)', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const errorFs = {
        name: 'Good name',
        signupId: '123456',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: '***',
        site: 'https://url.com',
        emails: 'test@test.com',
        ipAddresses: '1.1.1.1',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(errorFs, mockConfig);

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre une client keys url valide au format ( Ex: https://urlvalide.fr/jwks )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (signUP ID)', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const errorFs = {
        name: 'Good name',
        signupId: '****',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'test@test.com',
        ipAddresses: '1.1.1.1',
        eidas: '1',
        platform: 'CORE_FCP',
      };

      // Action
      createServiceProvider(errorFs, mockConfig);

      // Assert
      cy.contains(
        '.invalid-feedback',
        `Veuillez mettre un identifiant signUP valide ( chiffres seulement )`,
      )
        .scrollIntoView()
        .should('be.visible');
    });

    it('if an error occured in the form, we display an error (Entity Id too short)', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const errorFs = {
        name: 'Good name',
        signupId: '123',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'test@test.com',
        ipAddresses: '1.1.1.1',
        eidas: '1',
        entityId: 'a0cd64372db6ecf39c317c0c74ce90f',
        platform: 'CORE_FCP',
      };
      // Action
      createServiceProvider(errorFs, mockConfig);

      cy.contains(
        `Veuillez mettre un id d'entité valide (lettres, chiffres, tirets et 32 caractères minimum)`,
      ).should('be.visible');
    });

    it('if an error occured in the form, we display an error (Entity Id not alphanumeric and dash)', () => {
      // Arrange
      const mockConfig = {
        ...basicConfiguration,
      };

      const errorFs = {
        name: 'Good name',
        signupId: '123',
        redirectUri: 'https://url.com',
        redirectUriLogout: 'https://url.com/logout',
        jwksUri: 'https://url.com/jwks',
        site: 'https://url.com',
        emails: 'test@test.com',
        ipAddresses: '1.1.1.1',
        eidas: '1',
        entityId: 'a0cd64372db6ec@f39c?317c!0c74ce_90fa0cd64-372',
        platform: 'CORE_FCP',
      };
      // Action
      createServiceProvider(errorFs, mockConfig);

      cy.contains(
        `Veuillez mettre un id d'entité valide (lettres, chiffres, tirets et 32 caractères minimum)`,
      ).should('be.visible');
    });
  });

  describe('consent field', () => {
    const mockConfig = {
      ...basicConfiguration,
    };
    const fsConsentFalse = {
      name: 'MyFSConsentFalse',
      signupId: '123456',
      redirectUri: 'https://url.com',
      redirectUriLogout: 'https://url.com/logout',
      jwksUri: 'https://url.com/jwks',
      site: 'https://url.com',
      emails: 'titlen@gmail.com',
      ipAddresses: '192.0.0.0',
      eidas: 1,
      platform: 'CORE_FCP',
    };
    const fsConsentTrue = {
      name: 'MyFSConsentTrue',
      signupId: '123456',
      redirectUri: 'https://url.com',
      redirectUriLogout: 'https://url.com/logout',
      jwksUri: 'https://url.com/jwks',
      site: 'https://url.com',
      emails: 'titlen@gmail.com',
      ipAddresses: '192.0.0.0',
      identityConsent: true,
      eidas: 1,
      platform: 'CORE_FCP',
    };

    describe('create', () => {
      it('should create a service provider requiring a consent', () => {
        createServiceProvider(fsConsentTrue, mockConfig);
        cy.url().should('eq', `${BASE_URL}/service-provider`);
        cy.contains(
          `Le fournisseur de service MyFSConsentTrue a été créé avec succès !`,
        );
        cy.get('.alert-success > .close').click();
        cy.contains(`${fsConsentTrue.name}`).click();
        cy.get('#consent-required').should('be.checked');
      });

      it('should create a service provider not requiring a consent', () => {
        createServiceProvider(fsConsentFalse, mockConfig);
        cy.url().should('eq', `${BASE_URL}/service-provider`);
        cy.contains(
          `Le fournisseur de service MyFSConsentFalse a été créé avec succès !`,
        );
        cy.get('.alert-success > .close').click();
        cy.contains(`${fsConsentFalse.name}`).click();
        cy.get('#consent-not-required').should('be.checked');
      });
    });
  });
});
