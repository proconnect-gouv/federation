<!DOCTYPE html>
<html lang="fr">
  <head>
    <% include partials/head.ejs %>
  </head>
  <body>
    <% include partials/header.ejs %>
    <div class="container-fluid">
      <div class="row">
        <div class="col-12">
          <p class="h2">Modifier le fournisseur d'identité: <%= messages.values[0].title %></p>
        </div>
        <div class="card col-12">
          <% include partials/global-errors-handler.ejs %>
          <div class="card-body">
            <form method="POST" action="<%= APP_ROOT %>/identity-provider/<%= id%>?_method=PATCH" data-init="validIdentityProviderCreation" id="fi-form" name="fi-form" novalidate>
              <input type="hidden" name="_csrf" value="<%= locals.csrfToken  %>">
              <div class="form-group row">
                <label class="col-2 col-form-label" for="name">Nom du FI * : </label>
                <div class="col-10">
                  <input id="name" type="text" required readonly
                  class="form-control <%= locals.messages.errors && messages.errors[0].name && 'is-invalid' %>"
                  name="name" value="<%= locals.messages.values && messages.values[0].name %>" pattern="^[A-Za-z0-9-àâéêèëîïôùç]+$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].name) { %>
                    <p>
                      <% messages.errors[0].name.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre un nom valide ( majuscule, minuscule, nombres et trait d'union )
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="title">Titre (tel qu'il apparaîtra aux utilisateurs FC) * : </label>
                <div class="col-10">
                  <input id="title" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].title && 'is-invalid' %>"
                  name="title" value="<%= locals.messages.values && messages.values[0].title %>" pattern="^[A-Za-z0-9-'\sàâéêèëîïôùç]+$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].title) { %>
                    <p>
                      <% messages.errors[0].title.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre un titre valide ( majuscule, minuscule, nombres, trait d'union et espaces )
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="url"> Issuer URL * : </label>
                <div class="col-10">
                  <input id="url" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].url && 'is-invalid' %>"
                  name="url" value="<%= locals.messages.values && messages.values[0].url %>"
                  pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].url) { %>
                    <p>
                      <% messages.errors[0].url.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre une issuer URL valide au format https://issuer.fr
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="authorizationUrl">Authorization URL * : </label>
                <div class="col-10">
                  <input id="authorizationUrl" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].authorizationUrl && 'is-invalid' %>"
                  name="authorizationUrl" value="<%= locals.messages.values && messages.values[0].authorizationUrl %>"
                  pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].authorizationUrl) { %>
                    <p>
                      <% messages.errors[0].authorizationUrl.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre une authorization URL valide au format https://issuer.fr/auth
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="tokenUrl">Token URL * :</label>
                <div class="col-10">
                  <input id="tokenUrl" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].tokenUrl && 'is-invalid' %>"
                  name="tokenUrl" value="<%= locals.messages.values && messages.values[0].tokenUrl %>"
                  pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].tokenUrl) { %>
                    <p>
                      <% messages.errors[0].tokenUrl.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre une token URL valide au format https://issuer.fr/token
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="userInfoUrl">UserInfo URL * :</label>
                <div class="col-10">
                  <input id="userInfoUrl" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].userInfoUrl && 'is-invalid' %>"
                  name="userInfoUrl" value="<%= locals.messages.values && messages.values[0].userInfoUrl %>"
                  pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].userInfoUrl) { %>
                    <p>
                      <% messages.errors[0].userInfoUrl.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre une userInfo URL valide au format https://issuer.fr/userinfo
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="logoutUrl">Logout URL :</label>
                <div class="col-10">
                  <input id="logoutUrl" type="text"
                    class="form-control <%= locals.messages.errors && messages.errors[0].logoutUrl && 'is-invalid' %>"
                    name="logoutUrl" value="<%= locals.messages.values && messages.values[0].logoutUrl %>"
                    pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].logoutUrl) { %>
                    <p>
                      <% messages.errors[0].logoutUrl.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre une logout URL valide au format https://issuer.fr/logout
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="statusUrl">Status URL :</label>
                <div class="col-10">
                  <input id="statusUrl" type="text"
                  class="form-control <%= locals.messages.errors && messages.errors[0].statusUrl && 'is-invalid' %>"
                  name="statusUrl" value="<%= locals.messages.values && messages.values[0].statusUrl %>"
                  pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].statusUrl) { %>
                    <p>
                      <% messages.errors[0].statusUrl.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre une status URL valide au format https://issuer.fr/state
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="jwksUrl">Discovery URL :</label>
                <div class="col-10">
                  <input id="jwksUrl" type="text"
                  class="form-control <%= locals.messages.errors && messages.errors[0].jwksUrl && 'is-invalid' %>"
                  name="jwksUrl" value="<%= locals.messages.values && messages.values[0].jwksUrl %>"
                  pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].jwksUrl) { %>
                    <p>
                      <% messages.errors[0].jwksUrl.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre une discovery URL valide au format https://issuer.fr/.well-known/openid-configuration
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="clientId">Client ID * :</label>
                <div class="col-10">
                  <input id="clientId" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].clientId && 'is-invalid' %>"
                  name="clientId" value="<%= locals.messages.values && messages.values[0].clientId %>">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].clientId) { %>
                    <p>
                      <% messages.errors[0].clientId.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez saisir un clientId valide
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="clientSecret">Client Secret * :</label>
                <div class="col-10">
                  <input id="clientSecret" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].clientSecret && 'is-invalid' %>"
                  name="clientSecret" value="<%= locals.messages.values && messages.values[0].clientSecret %>">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].clientSecret) { %>
                    <p>
                      <% messages.errors[0].clientSecret.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez saisir un client Secret valide
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label">Sélectionnable dans la mire : </label>
                <div class="form-group col-4 d-flex align-items-end">
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="activated"
                    name="active"
                    value="true"
                    <%= locals.messages.values && messages.values[0].active === true ? 'checked' : '' %>
                    required>
                    <label class="custom-control-label" for="activated">oui</label>
                  </div>
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="unactivated"
                    name="active"
                    value="false"
                    <%= locals.messages.values && messages.values[0].active === false ? 'checked' : '' %>
                    required>
                    <label class="custom-control-label" for="unactivated">non</label>
                  </div>
                </div>
                <label class="col-2 col-form-label">Visible dans la mire : </label>
                <div class="form-group col-4 d-flex align-items-end">
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="displayed"
                    name="display"
                    value="true"
                    <%= locals.messages.values && messages.values[0].display === true ? 'checked' : '' %>
                    required>
                    <label class="custom-control-label" for="displayed">oui</label>
                  </div>
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="notdisplayed"
                    name="display"
                    value="false"
                    <%= locals.messages.values && messages.values[0].display === false ? 'checked' : '' %>
                    required>
                    <label class="custom-control-label" for="notdisplayed">non</label>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-12 col-form-label" for="messageToDisplayWhenInactive">Message à afficher lorsque le FI est désactivé (Disponible prochainement par défaut si aucune saisie) :</label>
                <div class="col-12">
                  <input id="messageToDisplayWhenInactive" type="text" class="form-control"
                  name="messageToDisplayWhenInactive" placeholder="Disponible prochainement" value="<%= locals.messages.values && messages.values[0].messageToDisplayWhenInactive %>">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].messageToDisplayWhenInactive) { %>
                    <p>
                      <% messages.errors[0].messageToDisplayWhenInactive.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez saisir un message à afficher si le fournisseur d'identité est désactivé
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="image">Lien vers lequel rediriger si le FI est désactivé :</label>
                <div class="col-10">
                  <input id="redirectionTargetWhenInactive" type="text"
                  class="form-control <%= locals.messages.errors && messages.errors[0].redirectionTargetWhenInactive && 'is-invalid' %>"
                  name="redirectionTargetWhenInactive" value="<%= locals.messages.values && messages.values[0].redirectionTargetWhenInactive %>">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].redirectionTargetWhenInactive) { %>
                    <p>
                      <% messages.errors[0].redirectionTargetWhenInactive.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez saisir un lien vers lequel rediriger si le fournisseur d'identité est désactivé
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="alt">Valeur de l'attribut HTML "alt" de l'image :</label>
                <div class="col-10">
                  <input id="alt" type="text"
                  class="form-control <%= locals.messages.errors && messages.errors[0].alt && 'is-invalid' %>"
                  name="alt" value="<%= locals.messages.values && messages.values[0].alt %>">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].alt) { %>
                    <p>
                      <% messages.errors[0].alt.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez saisir un nom valide
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="image">Nom de l'image :</label>
                <div class="col-10">
                  <input id="image" type="text"
                  class="form-control <%= locals.messages.errors && messages.errors[0].image && 'is-invalid' %>"
                  name="image" value="<%= locals.messages.values && messages.values[0].image %>">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].image) { %>
                    <p>
                      <% messages.errors[0].image.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez saisir un nom d'image valide finissant par .svg, .jpg, .gif, .png
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="imageFocus">Nom de l'image utilisée au survol/focus :</label>
                <div class="col-10">
                  <input id="imageFocus" type="text"
                  class="form-control <%= locals.messages.errors && messages.errors[0].imageFocus && 'is-invalid' %>"
                  name="imageFocus" value="<%= locals.messages.values && messages.values[0].imageFocus %>">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].imageFocus) { %>
                    <p>
                      <% messages.errors[0].imageFocus.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez saisir un nom d'image valide finissant par .svg, .jpg, .gif, .png
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label">Ignorer le niveau eidas : </label>
                <div class="form-group col-4 d-flex align-items-end">
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="trustedIdentity"
                    name="trustedIdentity"
                    value="true"
                    <%= locals.messages.values && messages.values[0].trustedIdentity === true ? 'checked' : '' %>
                    required>
                    <label class="custom-control-label" for="trustedIdentity">oui</label>
                  </div>
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="untrustedIdentity"
                    name="trustedIdentity"
                    value="false"
                    <%= locals.messages.values && messages.values[0].trustedIdentity === false ? 'checked' : '' %>
                    required>
                    <label class="custom-control-label" for="untrustedIdentity" >non</label>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label">Niveau eidas : </label>
                <div class="col-10">
                  <select name="eidas" class="custom-select">
                    <option value="1"
                      <%= messages.values && messages.values[0].eidas == 1 ? 'selected' : '' %>
                      >eIDAS 1 - Faible
                    </option>
                    <option value="2"
                      <%= messages.values && messages.values[0].eidas == 2 ? 'selected' : '' %>
                      >eIDAS 2 - Substanciel
                    </option>
                    <option value="3"
                      <%= messages.values && messages.values[0].eidas == 3 ? 'selected' : '' %>
                      >eIDAS 3 - Fort
                    </option>
                  </select>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="order">Ordre d'affichage dans la mire :</label>
                <div class="col-10">
                  <input id="order" type="number"
                  class="form-control <%= locals.messages.errors && messages.errors[0].order && 'is-invalid' %>"
                  name="order" value="<%= locals.messages.values && messages.values[0].order %>" placeholder="<%= locals.nbrProviders %> FI actuellement enregistrés">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].order) { %>
                    <p>
                      <% messages.errors[0].order.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez saisir un ordre
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-2 col-form-label" for="emails">Email pour l'envoi des statistiques (une adresse mail par ligne) *:</label>
                <div class="col-10">
                  <textarea id="emails" rows="3" name="emails"
                  class="form-control <%= locals.messages.errors && messages.errors[0].emails && 'is-invalid' %>"
                  pattern="^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$"><%= locals.messages.values && messages.values[0].emails instanceof Array ? messages.values[0].emails.join('\n') : '' %></textarea>
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].emails) { %>
                    <p>
                      <% messages.errors[0].emails.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez saisir au moins un email
                    <% } %>
                  </div>
                </div>
              </div>
              <div class="form-group row">
                <label class="col-12 col-form-label" for="specificText">Texte pour les erreur E010004, E010006, E010008, E010009, E010015. :</label>
                <div class="col-12">
                  <input id="specificText" type="text"
                  class="form-control <%= locals.messages.errors && messages.errors[0].specificText && 'is-invalid' %>"
                  name="specificText" value="<%= locals.messages.values && messages.values[0].specificText %>">
                </div>
              </div>
              <div class="form-group row">
                <label class="col-lg-2 col-lg-form-label" for="_totp">Code TOTP</label>
                <div class="col-lg-10">
                  <input id="_totp" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0]._totp && 'is-invalid' %>"
                  name="_totp">
                  <% if (locals.messages.errors && messages.errors[0]._totp) { %>
                  <div class="invalid-feedback">
                    <% messages.errors[0]._totp.forEach((error) => { %>
                    <p><%= error %></p>
                    <% }) %>
                  </div>
                  <% } %>
                </div>
              </div>
              <button type="submit" class="btn btn-primary">Mettre à jour le fournisseur d'identité</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>