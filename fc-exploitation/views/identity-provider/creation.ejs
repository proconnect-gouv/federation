<!DOCTYPE html>
<html lang="fr">
  <head>
    <% include partials/head.ejs %>
  </head>
  <body>
    <% include partials/header.ejs %>
    <div class="container">
      <div class="row">
        <div class="col-12">
          <p class="h2">Ajouter un nouveau fournisseur d'identité</p>
        </div>
        <div class="card col-12">
          <% include partials/global-errors-handler.ejs %>
          <div class="card-body">

            <form method="POST" data-init="validIdentityProviderCreation" id="fi-form" name="fi-form" action="?_csrf=<%= csrfToken %>" novalidate>
              <input type="hidden" name="_csrf" value="<%= locals.csrfToken  %>">
              <div class="form-group row">
                <label class="col-2 col-form-label" for="name">Nom du FI * : </label>
                <div class="col-10">
                  <input id="name" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].name && 'is-invalid' %>"
                  name="name" value="<%= locals.messages.values && messages.values[0].name %>" pattern="^[A-Za-z0-9-àâéêèëîïôùç]+$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].name) { %>
                    <p>
                      <% messages.errors[0].name.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre un nom valide ( majuscule, minuscule, nombres et trait d'union )
                    <% } %>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="title">Titre (tel qu'il apparaîtra aux utilisateurs FC) * : </label>
                <div class="col-10">
                <input id="title" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].title && 'is-invalid' %>"
                  name="title" value="<%= locals.messages.values && messages.values[0].title %>" pattern="^[A-Za-z0-9-'\sàâéêèëîïôùç]+$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].title) { %>
                    <p>
                      <% messages.errors[0].title.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre un titre valide ( majuscule, minuscule, nombres, trait d'union et espaces )
                    <% } %>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="url"> Issuer URL * : </label>
                <div class="col-10">
                <input id="url" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].url && 'is-invalid' %>"
                  name="url" value="<%= locals.messages.values && messages.values[0].url %>"
                  pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                  <div class="invalid-feedback">
                    <% if (locals.messages.errors && messages.errors[0].url) { %>
                    <p>
                      <% messages.errors[0].url.forEach((error) => { %>
                      <%= error %>
                      <br>
                      <% }) %>
                    </p>
                    <% } else { %>
                    Veuillez mettre une issuer URL valide au format https://issuer.fr
                    <% } %>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="authzURL">Authorization URL * : </label>
                <div class="col-10">
                <input id="authzURL" type="text" required
                class="form-control <%= locals.messages.errors && messages.errors[0].authzURL && 'is-invalid' %>"
                name="authzURL" value="<%= locals.messages.values && messages.values[0].authzURL %>"
                pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].authzURL) { %>
                  <p>
                    <% messages.errors[0].authzURL.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une authorization URL valide au format https://issuer.fr/auth
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="tokenURL">Token URL * :</label>
                <div class="col-10">
                <input id="tokenURL" type="text" required
                class="form-control <%= locals.messages.errors && messages.errors[0].tokenURL && 'is-invalid' %>"
                name="tokenURL" value="<%= locals.messages.values && messages.values[0].tokenURL %>"
                pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].tokenURL) { %>
                  <p>
                    <% messages.errors[0].tokenURL.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une token URL valide au format https://issuer.fr/token
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="userInfoURL">UserInfo URL * :</label>
                <div class="col-10">
                <input id="userInfoURL" type="text" required
                class="form-control <%= locals.messages.errors && messages.errors[0].userInfoURL && 'is-invalid' %>"
                name="userInfoURL" value="<%= locals.messages.values && messages.values[0].userInfoURL %>"
                pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].userInfoURL) { %>
                  <p>
                    <% messages.errors[0].userInfoURL.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une userInfo URL valide au format https://issuer.fr/userinfo
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="statusURL">Status URL :</label>
                <div class="col-10">
                <input id="statusURL" type="text"
                class="form-control <%= locals.messages.errors && messages.errors[0].statusURL && 'is-invalid' %>"
                name="statusURL" value="<%= locals.messages.values && messages.values[0].statusURL %>"
                pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].statusURL) { %>
                  <p>
                    <% messages.errors[0].statusURL.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une status URL valide au format https://issuer.fr/state
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="jwksURL">Discovery URL :</label>
                <div class="col-10">
                <input id="jwksURL" type="text"
                class="form-control <%= locals.messages.errors && messages.errors[0].jwksURL && 'is-invalid' %>"
                name="jwksURL" value="<%= locals.messages.values && messages.values[0].jwksURL %>"
                pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].jwksURL) { %>
                  <p>
                    <% messages.errors[0].jwksURL.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une discovery URL valide au format https://issuer.fr/.well-known/openid-configuration
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="clientID">ClientID * :</label>
                <div class="col-10">
                <input id="clientID" type="text" required
                class="form-control <%= locals.messages.errors && messages.errors[0].clientID && 'is-invalid' %>"
                name="clientID" value="<%= locals.messages.values && messages.values[0].clientID %>">
                 <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].clientID) { %>
                  <p>
                    <% messages.errors[0].clientID.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez saisir un clientId valide
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="clientSecret">Client Secret * :</label>
                <div class="col-10">
                <input id="clientSecret" type="text" required
                class="form-control <%= locals.messages.errors && messages.errors[0].clientSecret && 'is-invalid' %>"
                name="clientSecret" value="<%= locals.messages.values && messages.values[0].clientSecretHash %>">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].clientSecret) { %>
                  <p>
                    <% messages.errors[0].clientSecret.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez saisir un client Secret valide
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label">Sélectionnable dans la mire : </label>
                <div class="form-group col-4 d-flex align-items-end">
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="activated"
                    name="active"
                    disabled
                    value="true"
                    required>
                    <label class="custom-control-label" for="activated">oui</label>
                  </div>
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="unactivated"
                    name="active"
                    checked
                    value="false"
                    required>
                    <label class="custom-control-label" for="unactivated">non</label>
                  </div>
                </div>
                <label class="col-2 col-form-label">Visible dans la mire : </label>
                <div class="form-group col-4 d-flex align-items-end">
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="displayed"
                    name="display"
                    disabled
                    value="true"
                    required>
                    <label class="custom-control-label" for="displayed">oui</label>
                  </div>
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="notdisplayed"
                    name="display"
                    checked
                    value="false"
                    required>
                    <label class="custom-control-label" for="notdisplayed">non</label>
                  </div>
                </div>
               </div>

              <div class="form-group row">
                <label class="col-12 col-form-label" for="hoverMsg">Message à afficher lorsque le FI est désactivé * (Disponible prochainement par défaut si aucune saisie) :</label>
                <div class="col-12">
                <input id="hoverMsg" type="text" class="form-control"
                name="hoverMsg" placeholder="Disponible prochainement">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].hoverMsg) { %>
                  <p>
                    <% messages.errors[0].hoverMsg.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez saisir un nom d'image valide finissant par .svg, .jpg, .gif, .png
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="image">Lien vers lequel rediriger si le FI est désactivé :</label>
                <div class="col-10">
                <input id="hoverRedirectLink" type="text"
                class="form-control <%= locals.messages.errors && messages.errors[0].hoverRedirectLink && 'is-invalid' %>"
                name="hoverRedirectLink" value="<%= locals.messages.values && messages.values[0].hoverRedirectLink %>">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].hoverRedirectLink) { %>
                  <p>
                    <% messages.errors[0].hoverRedirectLink.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez saisir un nom d'image valide finissant par .svg, .jpg, .gif, .png
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="alt">Valeur de l'attribut HTML "alt" de l'image :</label>
                <div class="col-10">
                <input id="alt" type="text"
                class="form-control <%= locals.messages.errors && messages.errors[0].alt && 'is-invalid' %>"
                name="alt" value="<%= locals.messages.values && messages.values[0].alt %>">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].alt) { %>
                  <p>
                    <% messages.errors[0].alt.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez saisir un nom valide
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="image">Nom de l'image :</label>
                <div class="col-10">
                <input id="image" type="text"
                class="form-control <%= locals.messages.errors && messages.errors[0].image && 'is-invalid' %>"
                name="image" value="<%= locals.messages.values && messages.values[0].image %>">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].image) { %>
                  <p>
                    <% messages.errors[0].image.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez saisir un nom d'image valide finissant par .svg, .jpg, .gif, .png
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="imageFocus">Nom de l'image utilisée au survol/focus :</label>
                <div class="col-10">
                <input id="imageFocus" type="text"
                class="form-control <%= locals.messages.errors && messages.errors[0].imageFocus && 'is-invalid' %>"
                name="imageFocus" value="<%= locals.messages.values && messages.values[0].imageFocus %>">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].imageFocus) { %>
                  <p>
                    <% messages.errors[0].imageFocus.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez saisir un nom d'image valide finissant par .svg, .jpg, .gif, .png
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label">Ignorer le niveau eidas : </label>
                <div class="form-group col-4 d-flex align-items-end">
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="trustedIdentity"
                    name="trustedIdentity"
                    value="true"
                    required>
                    <label class="custom-control-label" for="trustedIdentity">oui</label>
                  </div>
                  <div class="custom-control custom-radio custom-control-inline">
                    <input
                    type="radio"
                    class="custom-control-input is-valid"
                    id="untrustedIdentity"
                    name="trustedIdentity"
                    value="false"
                    checked
                    required>
                    <label class="custom-control-label" for="untrustedIdentity" >non</label>
                  </div>
                </div>
               </div>

              <div class="form-group row">
                <label class="col-2 col-form-label">Niveau eidas : </label>
                <div class="col-10">
                <select name="eidas" class="custom-select">
                  <option value="1"
                    selected
                    >eIDAS 1 - Faible
                  </option>
                  <option value="2"
                  >eIDAS 2 - Substanciel
                  </option>
                  <option value="3"
                  >eIDAS 3 - Fort
                  </option>
                </select>
                </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="order">Ordre d'affichage dans la mire :</label>
                <div class="col-10">
                <input id="order" type="number"
                class="form-control <%= locals.messages.errors && messages.errors[0].order && 'is-invalid' %>"
                name="order" value="<%= locals.messages.values && messages.values[0].order %>" placeholder="<%= locals.nbrProviders %> FI actuellement enregistrés">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].order) { %>
                  <p>
                    <% messages.errors[0].order.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez saisir un ordre
                  <% } %>
                </div>
               </div>
              </div>

              <div class="form-group row">
                <label class="col-2 col-form-label" for="mailto">Email pour l'envoi des statistiques (une adresse mail par ligne) *:</label>
                <div class="col-10">
                <textarea id="mailto" rows="3" name="mailto"
                class="form-control <%= locals.messages.errors && messages.errors[0].mailto && 'is-invalid' %>"
                pattern="^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$"<%= locals.messages.values && messages.values[0].emails %>></textarea>
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].mailto) { %>
                  <p>
                    <% messages.errors[0].mailto.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez saisir au moins un email
                  <% } %>
                </div>
                </div>
              </div>

              <div class="form-group row">
                <label class="col-12 col-form-label" for="specificText">Texte pour les erreur E010004, E010006, E010008, E010009, E010015. :</label>
                <div class="col-12">
                <input id="specificText" type="text"
                class="form-control <%= locals.messages.errors && messages.errors[0].specificText && 'is-invalid' %>"
                name="specificText" value="<%= locals.messages.values && messages.values[0].specificText %>">
                </div>
              </div>

              <div class="form-group row">
                <label class="col-lg-2 col-lg-form-label" for="_totp">Code TOTP</label>
                <div class="col-lg-10">
                  <input id="_totp" type="text" required
                    class="form-control <%= locals.messages.errors && messages.errors[0]._totp && 'is-invalid' %>"
                    name="_totp">
                  <% if (locals.messages.errors && messages.errors[0]._totp) { %>
                  <div class="invalid-feedback">
                    <% messages.errors[0]._totp.forEach((error) => { %>
                    <p><%= error %></p>
                    <% }) %>
                  </div>
                  <% } %>
                </div>
              </div>

               <button type="submit" class="btn btn-primary">Créer le fournisseur d'identité</button>
            </form>

          </div>
        </div>
      </div>
    </div>

  </body>
</html>
