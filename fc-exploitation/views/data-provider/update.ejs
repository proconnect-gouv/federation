<!DOCTYPE html>
<html lang="fr">

<head>
  <%- include('partials/head.ejs') -%>
</head>

<body>
  <%- include('partials/header.ejs') -%>
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <p class="h2">Modifier le fournisseur de données : <%= messages.values[0].title %> </p>
      </div>
      <div class="card col-12" style="margin-bottom:4em;" id="form-card">
        <%- include('partials/global-errors-handler.ejs') -%>
        <div class="card-body">
          <form method="POST" action="<%= APP_ROOT %>/data-provider/<%= id%>?_method=PATCH" data-init="validForm" id="fd-form" name="fd-form" data-select="form" novalidate>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="title">Nom du fournisseur de données :</label>
              <div class="col-10">
                <input id="title" type="text" required class="form-control <%= locals.messages.errors && messages.errors[0].title && 'is-invalid' %>" placeholder="Nom du fournisseur de données" name="title" value="<%= locals.messages.values && messages.values[0].title %>" pattern="<%= VALID_INPUT_STRING_REGEX %>">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].title) { %>
                  <p>
                    <% messages.errors[0].title.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre un nom valide ( majuscule, minuscule, nombres et '.:_/!+- [espace] )
                  <% } %>
                </div>
              </div>
            </section>

            <section class="form-group row">
              <label class="col-2 col-form-label mt-2">Scopes : </label>
              <div class="form-group m-3 col-md-9">
                <% for (const [groupId, scopes] of Object.entries(locals.scopesGroupedByFd)) { %>
                <div data-init="selectScopesGroup" id="<%= groupId; %>">
                  <b><%= groupId; %></b> &nbsp;&nbsp; | &nbsp;&nbsp; TOUS <input id="group-<%= groupId; %>" type="checkbox" />
                  <p>
                    <% scopes.forEach(({fd, scope}) => { %>
                    <div class="form-check form-check-inline">
                      <input
                        data-fd="<%= fd; %>"
                        type="checkbox"
                        class="form-check-input"
                        id="scope-<%= scope %>"
                        name="scopes"
                        value="<%= scope %>"
                        <%= locals.messages.values && locals.messages.values[0].scopes && locals.messages.values[0].scopes.includes(scope) ? 'checked' : '' %>
                      >
                      <label class="form-check-label" for="scope-<%= scope %>"><%= scope %></label>
                    </div>
                    <% }); %>
                  </p>
                </div>
                <% } %>
              </div>
            </section>

            <section class="form-group row">
              <label class="col-2 col-form-label">Activé : </label>
              <div class="form-group col-4 d-flex align-items-end">
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio" class="custom-control-input <%= locals.messages.errors && messages.errors[0].active && 'is-invalid' %>"
                    id="activated" name="active" value="true" <% if(!(locals.messages.values && `${messages.values[0].active}` === 'false')){ %> checked <% } %> required>
                  <label class="custom-control-label" for="activated">oui</label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio" class="custom-control-input <%= locals.messages.errors && messages.errors[0].active && 'is-invalid' %>"
                    id="unactivated" name="active" value="false" <% if(locals.messages.values && `${messages.values[0].active}` === 'false'){ %> checked <% } %> required>
                  <label class="custom-control-label" for="unactivated">non</label>
                </div>
              </div>
            </section>

            <section class="form-group row">
              <label class="col-2 col-form-label" for="jwks_uri">URL JWKS : </label>
              <div class="col-10">
                <input id="jwks_uri" type="text" class="form-control <%= locals.messages.errors && messages.errors[0].jwks_uri && 'is-invalid' %>" name="jwks_uri" value="<%= locals.messages.values && messages.values[0].jwks_uri %>" pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$"
                  placeholder="https://client-keys-url/jwks">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].jwks_uri) { %>
                  <p>
                    <% messages.errors[0].jwks_uri.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une URL JWKS valide au format ( Ex: https://urlvalide.fr/jwks )
                  <% } %>
                </div>
              </div>
            </section>

            <div class="form-group row">
              <label class="col-2 col-form-label" for="checktoken_signed_response_alg">checktoken_signed_response_alg * : </label>
              <div class="col-10">
                <select class="custom-select" name="checktoken_signed_response_alg">
                  <option value="" <%= !messages.values || messages.values[0].checktoken_signed_response_alg === "" ? 'selected' : '' %>></option>
                  <option value="HS256" <%= messages.values && messages.values[0].checktoken_signed_response_alg === "HS256" ? 'selected' : '' %>>HS256</option>
                  <option value="ES256" <%= messages.values && messages.values[0].checktoken_signed_response_alg === "ES256" ? 'selected' : '' %>>ES256</option>
                  <option value="RS256" <%= messages.values && messages.values[0].checktoken_signed_response_alg === "RS256" ? 'selected' : '' %>>RS256</option>
                </select>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-2 col-form-label" for="checktoken_encrypted_response_alg">checktoken_encrypted_response_alg : </label>
              <div class="col-10">
                <select class="custom-select" name="checktoken_encrypted_response_alg">
                  <option value="" <%= !messages.values || messages.values[0].checktoken_encrypted_response_alg === "" ? 'selected' : '' %>></option>
                  <option value="ECDH-ES" <%= messages.values && messages.values[0].checktoken_encrypted_response_alg === "ECDH-ES" ? 'selected' : '' %>>ECDH-ES</option>
                  <option value="RSA-OAEP" <%= messages.values && messages.values[0].checktoken_encrypted_response_alg === "RSA-OAEP" ? 'selected' : '' %>>RSA-OAEP</option>
                  <option value="RSA-OAEP-256" <%= messages.values && messages.values[0].checktoken_encrypted_response_alg === "RSA-OAEP-256" ? 'selected' : '' %>>RSA-OAEP-256</option>
                </select>
              </div>
            </div>

            <div class="form-group row">
              <label class="col-2 col-form-label" for="checktoken_encrypted_response_enc">checktoken_encrypted_response_enc : </label>
              <div class="col-10">
                <select class="custom-select" name="checktoken_encrypted_response_enc">
                  <option value="" <%= !messages.values || messages.values[0].checktoken_encrypted_response_enc === "" ? 'selected' : '' %>></option>
                  <option value="A256GCM" <%= messages.values && messages.values[0].checktoken_encrypted_response_enc === "A256GCM" ? 'selected' : '' %>>A256GCM</option>
                </select>
              </div>
            </div>

            <section class="form-group row">
              <label class="col-2 col-form-label" for="confirm-2FAuthentication">Code TOTP</label>
              <div class="col-10">
                <input id="_totp" type="text" required placeholder="123456"
                  class="form-control <%= locals.messages.errors && messages.errors[0]._totp && 'is-invalid' %>" name="_totp">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0]._totp) { %>
                  <p>
                    <% messages.errors[0]._totp.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre un code TOTP valide.
                  <% } %>
                </div>
              </div>
            </section>

            <section class="row" style="margin: 2em 0em 1em 0.5em;">
              <input id="_csrf" type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
              <button type="submit" class="btn btn-primary">Enregistrer les informations</button>
            </section>

          </form>
        </div>
      </div>
    </div>
  </div>

</body>

</html>
