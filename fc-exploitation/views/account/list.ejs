<!DOCTYPE html>
<html lang="fr">
<head>
  <% include partials/head.ejs %>
</head>
<body>
<% include partials/header.ejs %>
<div class="container">
  <div class="row">
    <div class="col-12">
      <div>
        <div class="flex-grow-1">
          <p class="h2">Gestion des utilisateurs</p>
          <p id="users-count"><i><%= totalUsers %> utilisateurs</i></p>
          <% if (locals.messages.globalError) { %>
          <div class="alert alert-danger mt-3">
          <%= messages.globalError[0].code && ERROR_CODE_TRANSLATIONS[messages.globalError[0].code] ? ERROR_CODE_TRANSLATIONS[messages.globalError[0].code] : messages.globalError[0] %>
          </div>
          <% } %>
          <% if (CURRENT_USER.roles.includes('admin')) { %>
            <a class="btn btn-primary mb-3" href="<%= APP_ROOT %>/account/create">Créer un utilisateur</a>
          <% } %>
          <table class="table table-hover table-light shadow-sm">
            <thead class="thead-light">
            <tr>
              <th scope="col" class="w-30">Login</th>
              <th scope="col" class="w-50">Email</th>
              <th scope="col" class="w-20">Rôles</th>
              <th scope="col" class="w-10">Actions</th>
            </tr>
            </thead>
            <tbody>
            <% users.forEach(function(user){ %>
              <tr id="<%= user.username%>">
                <th scope="row"><%= user.username %></th>
                <td><%= user.email %></td>
                <td id="roles">
                  <% user.roles.forEach(function (role) { %>
                    <span
                      class="badge badge-secondary p-1"><%= USER_ROLES_OPTIONS.find(({value}) => value === role).label %></span>
                  <% }) %>
                </td>
                <% if(CURRENT_USER.roles.find((role) => role === 'admin' && user.id !== CURRENT_USER.id)) { %>
                  <td>
                    <form
                      name="deleteForm"
                      method="POST"
                      id="delete-<%= user.id %>"
                      action="<%= APP_ROOT %>/account/<%= user.id%>?_method=DELETE"
                      class="d-flex align-items-center"
                      data-init="removeItem"
                      data-element-title="<%= user.username %>"
                      data-element-id="<%= user.id %>"
                      data-element-type="le compte"
                      novalidate>
                        <input type="hidden" name="_csrf" value="<%= locals.csrfToken  %>">
                        <input type="hidden" name="username" value="<%= user.username %>">
                        <button type="submit" class="btn-action-delete">
                          <i class="fa fa-trash" aria-hidden="true" title="Supprimer"></i>
                        </button>
                    </form>
                  </td>
                  <% } %>
              </tr>
            <% }) %>
            </tbody>
          </table>
          <div class="container">
            <% if(pages > 1) { %>
            <nav aria-label="Page navigation example">
              <ul id="pagination-demo" class="pagination justify-content-center flex-wrap">
                <li class="page-item <% if (previous === ''){ %> disabled <% } %>">
                  <a class="page-link previous" href="<%= previous %>" tabindex="-1" aria-disabled="true">Précédente</a>
                </li>
                <% for(var i = 0; i < pages; i++) { %>
                  <li class="page-item"><a class="page-link" href="<%= APP_ROOT %>/account?page=<%= i +1 %>&limit=10"><%= i + 1 %></a></li>
                <% } %>
                <!-- TODO disabled when no more page -->
                <li class="page-item">
                  <a class="page-link <% if (next === ''){ %> disabled <% } %> next" href="<%= next %>">Suivante</a>
                </li>
              </ul>
            </nav>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
