<!DOCTYPE html>
<html lang="fr">

<head>
  <% include partials/head.ejs %>
</head>
<body>
  <% include partials/header.ejs %>
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <p class="h2">Modifier le fournisseur de service : <%= messages.values[0].title%> </p>
      </div>
      <div class="card col-12">
        <% include partials/global-errors-handler.ejs %>
        <div class="card-body">
          <form method="POST" action="<%= APP_ROOT %>/service-provider/<%= id%>?_method=PATCH" data-init="validForm"
            id="fs-form" name="fs-form" novalidate>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="name">Nom du fournisseur de service (mire) : </label>
              <div class="col-10">
                <input id="name" type="'text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].name && 'is-invalid' %>"
                  placeholder="<%= locals.messages.values && messages.values[0].name %>" name="name"
                  value="<%= locals.messages.values && messages.values[0].name %>"
                  pattern="^[A-Za-z0-9-'\sàâéêèëîïôùç]+$">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].name) { %>
                  <p>
                    <% messages.errors[0].name.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre un nom valide ( majuscule, minuscule, nombres et trait d'union )
                  <% } %>
                </div>
              </div>
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="signupId">Signup ID : </label>
              <div class="col-10">
                <input id="signupId" name="signupId" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].signupId && 'is-invalid' %>"
                  value="<%= locals.messages.values && messages.values[0].signupId %>" pattern="^[1-9]{1}[0-9]*$">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].signupId) { %>
                  <p>
                    <% messages.errors[0].signupId.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre un identifiant signUP valide ( chiffres seulement )
                  <% } %>
                </div>
              </div>
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="redirectUri">URL de redirection de connexion : </label>
              <div class="col-10">
                <textarea id="redirectUri" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].redirectUri && 'is-invalid' %>"
                  placeholder="https://url-de-redirection.com" name="redirectUri"
                  pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$"><%= locals.messages.values && messages.values[0].redirectUri %></textarea>
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].redirectUri) { %>
                  <p>
                    <% messages.errors[0].redirectUri.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une URL valide ( Ex: https://urlvalide.com/ )
                  <% } %>
                </div>
              </div>
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="redirectUriLogout">URL de redirection de déconnexion : </label>
              <div class="col-10">
                <textarea id="redirectUriLogout" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].redirectUriLogout && 'is-invalid' %>"
                  name="redirectUriLogout" placeholder="https://url-de-redirection/deconnexion.com"
                  pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$"><%= locals.messages.values && ( messages.values[0].postLogoutUri || messages.values[0].redirectUriLogout ) %></textarea>
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].redirectUriLogout) { %>
                  <p>
                    <% messages.errors[0].redirectUriLogout.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une URL valide ( Ex: https://urlvalide.com/ )
                  <% } %>
                </div>
              </div>
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="site">Site : </label>
              <div class="col-10">
                <textarea id="site" required
                  class="form-control <%= locals.messages.errors && messages.errors[0].site && 'is-invalid' %>"
                  placeholder="https://monsite.com" name="site"
                  pattern="^((https?:\/\/)?((([^\s\/$.?#]{1,})(\.[^\s\/$?#]{2,})*\.[a-z]{2,})|(([0-9]{1,3}\.){3}[0-9]{1,3})|localhost)(:[0-9]{2,5})?(\/[^\s\/$]+)*\/?)$"><%= locals.messages.values && messages.values[0].site %></textarea>
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].site) { %>
                  <p>
                    <% messages.errors[0].site.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre une URL valide ( Ex: https://site.com/ )
                  <% } %>
                </div>
              </div>
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="emails">Email(s) de contact (un par ligne)</label>
              <div class="col-10">
                <textarea required id="emails"
                  class="form-control  <%= locals.messages.errors && messages.errors[0].emails && 'is-invalid' %>"
                  placeholder="email@email.com" name="emails"
                  pattern="^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$"><%= locals.messages.values && messages.values[0].emails %></textarea>
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].emails) { %>
                  <p>
                    <% messages.errors[0].emails.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre des emails valides ( Ex: email@email.com )
                  <% } %>
                </div>
              </div>
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="ipAddresses">Plages d'adresses IP (une par ligne)</label>
              <div class="col-10">
                <textarea required id="ipAddresses"
                  class="form-control  <%= locals.messages.errors && messages.errors[0].ipAddresses && 'is-invalid' %>"
                  placeholder="1.1.1.1" name="ipAddresses"
                  pattern="^((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])(?::\d{0,5})?$"><%= locals.messages.values && ( messages.values[0].ipAddresses || messages.values[0].ipsRanges ) %></textarea>
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0].ipAddresses) { %>
                  <p>
                    <% messages.errors[0].ipAddresses.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre des ips valides ( Ex: 1.1.1.1 )
                  <% } %>
                </div>
              </div>
            </section>
            <% include partials/scopes.ejs %>
            <section class="form-group row">
              <label class="col-2 col-form-label">Activé : </label>
                <div class="form-group col-4 d-flex align-items-end">
                  <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio" class="custom-control-input is-valid" id="activated" name="active" value=true
                      <% if(locals.messages.values && `${messages.values[0].active}` === 'true'){ %> checked <% } %>
                      required>
                    <label class="custom-control-label" for="activated">oui</label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio" class="custom-control-input is-valid" id="unactivated" name="active" value=false
                    <% if(locals.messages.values && `${messages.values[0].active}` === 'false'){ %> checked <% } %>
                    required>
                  <label class="custom-control-label" for="unactivated">non</label>
                </div>
              </div>
                
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label">Statut du fournisseur de service : </label>
                <div class="form-group col-4 d-flex align-items-end">
                  <div class="custom-control custom-radio custom-control-inline">
                    <input type="radio"
                    class=" custom-control-input <%= locals.messages.errors && messages.errors[0].type && 'is-invalid' %>" id="public"
                    name="type" value="public"
                    <% if(locals.messages.values && messages.values[0].type === 'public'){ %> checked <% } %> required>
                  <label class="custom-control-label" for="public">public</label>
                </div>
                <div class="custom-control custom-radio custom-control-inline">
                  <input type="radio"
                    class="custom-control-input <%= locals.messages.errors && messages.errors[0].type && 'is-invalid' %>"
                    id="private" name="type" value="private"
                    <% if(locals.messages.values && messages.values[0].type === 'private'){ %> checked <% } %> required>
                  <label class="custom-control-label" for="private">privé</label>
                </div>
            </section>
            <section class="form-group row">
              <label class="col-2 col-form-label" for="confirm-2FAuthentication">Code TOTP</label>
              <div class="col-10">
                <input id="_totp" type="text" required
                  class="form-control <%= locals.messages.errors && messages.errors[0]._totp && 'is-invalid' %>"
                  name="_totp">
                <div class="invalid-feedback">
                  <% if (locals.messages.errors && messages.errors[0]._totp) { %>
                  <p>
                    <% messages.errors[0]._totp.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } else { %>
                  Veuillez mettre un code TOTP valide.
                  <% } %>
                </div>
              </div>
            </section>

            <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
            <button type="submit" class="btn btn-primary">Enregistrer les informations</button>
          </form>
        </div>
      </div>
      <div class="card col-12 my-5">
        <div class="card-body">
          <section class="form-group row pb-4">
            <label class="col-2 col-form-label" for="logo">Logo du fournisseur de service: </label>

            <form method="POST" action="<%= APP_ROOT %>/service-provider/<%= id%>/logo?_method=PUT %>"
              data-init="validForm,updateItem" class="col-10" id="update-logo-form" name="update-logo-form" 
              data-element-type="le logo de" data-element-id="logo-form"
              data-element-title="<%= locals.messages.values && messages.values[0].name %>" 
              novalidate>

              <section class="col-9 <%= locals.messages.errors && messages.errors[0].logo && 'is-invalid' %>"
                id="box-upload" data-init="uploadHandler" data-error=".invalid-upload" data-output=".logo-handler"
                data-size="1000000" data-type="image\/(?:png|jpe?g|gif|svg\+xml)"
                data-source="<%= locals.messages.values ? messages.values[0].currentLogo : '' %>">
                <div class="box-input">
                  <svg class="box-icon" xmlns="http://www.w3.org/2000/svg" width="50" height="43" viewBox="0 0 50 43">
                    <path
                      d="M48.4 26.5c-.9 0-1.7.7-1.7 1.7v11.6h-43.3v-11.6c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v13.2c0 .9.7 1.7 1.7 1.7h46.7c.9 0 1.7-.7 1.7-1.7v-13.2c0-1-.7-1.7-1.7-1.7zm-24.5 6.1c.3.3.8.5 1.2.5.4 0 .9-.2 1.2-.5l10-11.6c.7-.7.7-1.7 0-2.4s-1.7-.7-2.4 0l-7.1 8.3v-25.3c0-.9-.7-1.7-1.7-1.7s-1.7.7-1.7 1.7v25.3l-7.1-8.3c-.7-.7-1.7-.7-2.4 0s-.7 1.7 0 2.4l10 11.6z">
                    </path>
                  </svg>
                  <input class="box-file" type="file" />
                  <label for="file">
                    <strong>Choisissez un fichier</strong>
                    <span class="box-dragndrop"> ou en déposer un ici</span>
                    <br />
                    <span class="help small">Taille optimale H380xL200 px (png, jpg, gif) Poids inférieur à 1mo.</span>
                  </label>
                </div>
                <figure class="logo-handler">
                  <img width="380" height="220" id="logo-result" />
                  <input type="hidden" id="logo-data" name="logo" />
                </figure>
                <div class="invalid-feedback <%= locals.messages.errors && messages.errors[0].logo && 'force-display' %>">
                  <% if (locals.messages.errors && messages.errors[0].logo) { %>
                  <p>
                    <% messages.errors[0].logo.forEach((error) => { %>
                    <%= error %>
                    <br>
                    <% }) %>
                  </p>
                  <% } %>
                </div>
                <div class="invalid-upload"></div>
              </section>

              <input type="text" name="filename" hidden value="<%= messages.values[0].logo %>" />
              <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
              <input type="hidden" name="_totp">
              <input type="submit" id="btn-logo-update" class="btn btn-outline-primary mt-3 mr-3" disabled
                value="Mettre à jour le logo" />
            </form>
          </section>

          <section class="form-group row">
            <label class="col-2 col-form-label" for="logo">Suppression du logo:</label>
            <form method="POST" action="<%= APP_ROOT %>/service-provider/<%= id%>/logo?_method=DELETE"
              id="delete-logo-form" name="delete-logo-form" data-init="removeItem" data-element-type="le logo de"
              data-element-title="<%= locals.messages.values && messages.values[0].name %>" data-element-id="logo-form"
              novalidate>

              <% if (locals.messages.values && messages.values[0].currentLogo) { %>
                <button type="submit" id="btn-logo-delete" class="btn btn-danger mx-2">Supprimer le logo</button>                
              <% } else { %>
                <button type="submit" id="btn-logo-delete" class="btn btn-outline-danger mx-2" disabled>Supprimer le logo</button>
              <% } %>
              
              <input type="text" name="filename" hidden value="<%= messages.values[0].logo %>" />
              <input type="hidden" name="_csrf" value="<%= locals.csrfToken %>">
              <input type="hidden" name="_totp">
            </form>
          </section>
          <script type="text/javascript">
            const updateBtn = document.querySelector('#btn-logo-update');
            const section = document.querySelector('#box-upload');
            section.addEventListener('logo-updated', (e) => {
              console.log('logo updated');
              updateBtn.disabled = false;
              updateBtn.classList.add('btn-primary');
              updateBtn.classList.remove('btn-outline-primary');
            }, false);
            section.addEventListener('logo-reset', (e) => {
              console.log('logo reset');
              updateBtn.disabled = true;
              updateBtn.classList.remove('btn-primary');
              updateBtn.classList.add('btn-outline-primary');
            }, false);
          </script>
        </div>
      </div>
    </div>
  </div>
</body>

</html>