import { Test } from '@nestjs/testing';
import { Repository } from 'typeorm';
import { ObjectID } from 'mongodb';
import { getRepositoryToken } from '@nestjs/typeorm';
import { IdentityProvider } from './identity-provider.mongodb.entity';
import { IdentityProviderController } from './identity-provider.controller';
import { IdentityProviderService } from './identity-provider.service';

describe('IdentityProviderController', () => {
  let identityProviderController;
  let service: IdentityProviderService;
  const mockedIdentityProviderRepository = {
    findAndCount: jest.fn(),
  };

  const serviceMock = {
    paginate: jest.fn(),
    countProviders: jest.fn(),
    create: jest.fn(),
    update: jest.fn(),
    deleteIdentityProvider: jest.fn(),
    findById: jest.fn(),
  };

  const identityProviderDTO = {
    name: 'trotro',
    url: 'www.landingPage.com',
    messageToDisplayWhenInactive: '',
    redirectionTargetWhenInactive: '',
    active: false,
    display: false,
    title: 'title',
    image: '',
    alt: '',
    imageFocus: '',
    eidas: 3,
    emails: ['trotro@trotro.com'],
    statusURL: 'www.status-url.com',
    aythorizationUrl: 'www.auth-url.com',
    tokenUrl: 'www.token-url.com',
    userInfoUrl: 'www.user-info-url.com',
    logoutUrl: 'https://issuer.fr/logout',
    clientId: 'hkjhkjhkhkjhjk',
    clientSecret: 'jhkjhkjhkh',
    order: 2,
    jwksUrl: 'www.jwks-url.com',
    trustedIdentity: false,
    specificText: '',
  };

  const params = {
    id: '648c1742c74d6a3d84b31943',
  };

  const req = {
    flash: jest.fn(),
    csrfToken: function csrfToken() {
      return 'mygreatcsrftoken';
    },
    session: {
      flash: {},
    },
    user: {
      username: 'jean_moust',
    },
    body: identityProviderDTO,
  };

  const res = {
    redirect: jest.fn(),
    status: jest.fn(),
    locals: {
      APP_ROOT: '/foo/bar',
    },
  };

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      controllers: [IdentityProviderController],
      providers: [
        IdentityProviderService,
        {
          provide: getRepositoryToken(IdentityProviderService),
          useClass: Repository,
        },
      ],
    })
      .overrideProvider(getRepositoryToken(IdentityProvider, 'fc-mongo'))
      .useValue(mockedIdentityProviderRepository)
      .overrideProvider(IdentityProviderService)
      .useValue(serviceMock)
      .compile();

    identityProviderController = module.get<IdentityProviderController>(
      IdentityProviderController,
    );
    service = await module.get<IdentityProviderService>(
      IdentityProviderService,
    );
    jest.resetAllMocks();
  });

  describe('list', () => {
    it('returns the list of the available identity providers', async () => {
      // Setup
      const page = 0;
      const limit = 10;

      const now = new Date();

      // //Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');
      //
      // //Mocking Items
      const itemTest1: IdentityProvider = {
        id: itemId,
        name: 'fip1',
        active: true,
        order: 2,
        hoverMsg: 'Message to display',
        hoverRedirectLink: 'Message to display',
        blacklistByIdentityProviderActivated: true,
        WhitelistByServiceProviderActivated: true,
        display: true,
        title: 'Identity Provider Example',
        image: '',
        imageFocus: '',
        alt: 'impots',
        eidas: 2,
        mailto: '',
        specificText: 'specific text fip1',
        url: 'https://fip1.docker.dev-franceconnect.fr/',
        statusURL: 'https://fip1.docker.dev-franceconnect.fr/',
        authzURL: 'https://fip1.docker.dev-franceconnect.fr/user/authorize',
        tokenURL: 'https://fip1.docker.dev-franceconnect.fr/user/token',
        userInfoURL: 'https://fip1.docker.dev-franceconnect.fr/api/user',
        endSessionURL: 'https://issuer.fr/logout',
        discoveryUrl: 'https://issuer/.well-known/openid-configuration',
        discovery: true,
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        clientSecretHash:
          'bbe8f1b2a1415d6942b653689a51ba16f22b41e57a4e44b40799d',
        jwksURL: 'toto',
        jwtAlgorithm: [],
        trustedIdentity: false,
        createdAt: now,
        updatedAt: now,
        updatedBy: 'admin',
      };

      const itemTest2 = { ...itemTest1 };
      const itemTest3 = { ...itemTest1 };

      // Mocking return value of serviceProviderController.list(page, limit)
      const identityProviders = {
        items: [itemTest1, itemTest2, itemTest3],
        totalProvider: 3,
        total: 3,
        itemCount: 3,
        pageCount: 1,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function
      const result = Promise.resolve(identityProviders);

      // Mocking the return of service paginte function
      const spy = jest
        .spyOn(service, 'paginate')
        .mockImplementation(() => Promise.resolve(result));

      // Calling the list function
      const resultat = await identityProviderController.list(req, page, limit);

      // Expected
      expect(spy).toHaveBeenCalled();
      expect(resultat.totalItems).toEqual(3);
      expect(resultat.identityProviders.length).toEqual(3);
    });
  });

  describe('get create', () => {
    it('should get identity provider creation form', async () => {
      // setup
      const spy = jest
        .spyOn(serviceMock, 'countProviders')
        .mockImplementation(() => Promise.resolve('3'));
      // action
      const resultat = await identityProviderController.showCreationForm(req);
      // expectation
      expect(spy).toHaveBeenCalled();
      expect(serviceMock.countProviders).toHaveBeenCalledTimes(1);
    });
  });

  describe('post create', () => {
    it('should call successfully the service provider create function', async () => {
      // action
      await identityProviderController.createIdentityProvider(
        identityProviderDTO,
        req,
        res,
      );
      // expectation
      expect(serviceMock.create).toHaveBeenCalledTimes(1);
      expect(serviceMock.create).toHaveBeenCalledWith(
        identityProviderDTO,
        req.user.username,
      );
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith(
        'success',
        "Le fournisseur d'identité trotro a été créé avec succès !",
      );
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/identity-provider`,
      );
    });

    it('should fall back in the catch if identityProviderService.create could not handle the request', async () => {
      // setup
      serviceMock.create.mockImplementationOnce(() => {
        throw new Error('Try again buddy');
      });
      // action
      await identityProviderController.createIdentityProvider(
        identityProviderDTO,
        req,
        res,
      );
      // expectation
      expect(serviceMock.create).toHaveBeenCalledTimes(1);
      expect(serviceMock.create).toHaveBeenCalledWith(
        identityProviderDTO,
        req.user.username,
      );
      expect(req.flash).toHaveBeenCalledTimes(2);
      expect(req.flash).toHaveBeenCalledWith('globalError', 'Try again buddy');
      expect(req.flash).toHaveBeenCalledWith('values', req.body);
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/identity-provider/create`,
      );
    });
  });

  describe('get update', () => {
    it('should get the identity provider from its id and render the update form', async () => {
      // action
      const resultat = await identityProviderController.findOne(
        params.id,
        req,
        res,
      );
      // expectation
      expect(serviceMock.findById).toHaveBeenCalledTimes(1);
      expect(serviceMock.findById).toHaveBeenCalledWith(params.id);
      expect(req.flash).toHaveBeenCalledTimes(1);
    });
  });

  describe('post update', () => {
    it('should call the update function from the identity provider service', async () => {
      // action
      await identityProviderController.identityProviderUpdate(
        identityProviderDTO,
        params.id,
        req,
        res,
      );
      // expectation
      expect(serviceMock.update).toHaveBeenCalledTimes(1);
      expect(serviceMock.update).toHaveBeenCalledWith(
        params.id,
        identityProviderDTO,
        req.user.username,
      );
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith(
        'success',
        `Le fournisseur d'identité ${identityProviderDTO.title} a été modifié avec succès !`,
      );
    });

    it('should call req.flash if the service throw an error', async () => {
      // setup
      const error = new Error('something');
      serviceMock.update.mockRejectedValueOnce(error);

      // action
      await identityProviderController.identityProviderUpdate(
        identityProviderDTO,
        params.id,
        req,
        res,
      );
      // expectation
      expect(serviceMock.update).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith('globalError', error.message);
    });
  });

  describe('Delete identity provider', () => {
    it('Should redirect to the identity providers list if it succeed', async () => {
      // set up
      const id = 'id';
      const body = { name: 'name' };

      // action
      serviceMock.deleteIdentityProvider.mockImplementationOnce(() => {
        return {};
      });
      await identityProviderController.deleteIdentityProvider(
        id,
        req,
        res,
        body,
      );

      // expect
      expect(service.deleteIdentityProvider).toHaveBeenCalledWith(id);
      expect(service.deleteIdentityProvider).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/identity-provider`,
      );
    });

    it('Should not redirect the user but set the res status to 500 for the error handler', async () => {
      // set up
      const id = 'id';
      const body = { name: 'name' };

      // action
      serviceMock.deleteIdentityProvider.mockImplementationOnce(() => {
        throw new Error('Try again buddy');
      });
      await identityProviderController.deleteIdentityProvider(
        id,
        req,
        res,
        body,
      );
      // expect
      expect(service.deleteIdentityProvider).toHaveBeenCalledWith(id);
      expect(service.deleteIdentityProvider).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith('globalError', 'Try again buddy');
      expect(res.status).toHaveBeenCalledWith(500);
      expect(res.redirect).toHaveBeenCalledTimes(0);
    });
  });

  describe('GET: paginate[mongodb] identityProvider (list) ', () => {
    it('should return a list of identity providers even with sort/action as undefined values', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const sort = undefined;
      const action = undefined;

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      const now = new Date('2019-11-08T09:52:29.984Z');

      // //Mocking Items
      const itemTest1: IdentityProvider = {
        id: itemId,
        name: 'Batman',
        active: true,
        order: 2,
        hoverMsg: 'Message to display',
        hoverRedirectLink: 'Message to display',
        blacklistByIdentityProviderActivated: true,
        WhitelistByServiceProviderActivated: true,
        display: true,
        title: 'Identity Provider Example',
        image: '',
        imageFocus: '',
        alt: 'impots',
        eidas: 2,
        mailto: '',
        specificText: 'specific text fip1',
        url: 'https://fip1.docker.dev-franceconnect.fr/',
        statusURL: 'https://fip1.docker.dev-franceconnect.fr/',
        authzURL: 'https://fip1.docker.dev-franceconnect.fr/user/authorize',
        tokenURL: 'https://fip1.docker.dev-franceconnect.fr/user/token',
        userInfoURL: 'https://fip1.docker.dev-franceconnect.fr/api/user',
        endSessionURL: 'https://issuer.fr/logout',
        discoveryUrl: 'https://issuer/.well-known/openid-configuration',
        discovery: true,
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        clientSecretHash:
          'bbe8f1b2a1415d6942b653689a51ba16f22b41e57a4e44b40799d',
        jwksURL: 'toto',
        jwtAlgorithm: [],
        trustedIdentity: false,
        createdAt: now,
        updatedAt: now,
        updatedBy: 'admin',
      };

      const itemTest2 = { ...itemTest1, name: 'joker' };

      const identityProvidersResult = {
        items: [itemTest1, itemTest2],
        itemCount: 2,
        totalItems: 2,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function
      serviceMock.paginate.mockResolvedValueOnce(
        Promise.resolve(identityProvidersResult),
      );

      // Calling the list function
      const resultat = await identityProviderController.list(
        req,
        sort,
        action,
        page,
        limit,
      );

      // Expected
      expect(resultat.identityProviders.length).toEqual(2);
      expect(resultat.identityProviders).toEqual([itemTest1, itemTest2]);
    });

    it('should return return a list sort alphabetically of identity providers if sort="name" and action="asc"', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const sort = 'name';
      const action = 'asc';

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      const now = new Date('2019-11-08T09:52:29.984Z');

      // //Mocking Items
      const itemTest1: IdentityProvider = {
        id: itemId,
        name: 'Batman',
        active: true,
        order: 2,
        hoverMsg: 'Message to display',
        hoverRedirectLink: 'Message to display',
        blacklistByIdentityProviderActivated: true,
        WhitelistByServiceProviderActivated: true,
        display: true,
        title: 'Identity Provider Example',
        image: '',
        imageFocus: '',
        alt: 'impots',
        eidas: 2,
        mailto: '',
        specificText: 'specific text fip1',
        url: 'https://fip1.docker.dev-franceconnect.fr/',
        statusURL: 'https://fip1.docker.dev-franceconnect.fr/',
        authzURL: 'https://fip1.docker.dev-franceconnect.fr/user/authorize',
        tokenURL: 'https://fip1.docker.dev-franceconnect.fr/user/token',
        userInfoURL: 'https://fip1.docker.dev-franceconnect.fr/api/user',
        endSessionURL: 'https://issuer.fr/logout',
        discoveryUrl: 'https://issuer/.well-known/openid-configuration',
        discovery: true,
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        clientSecretHash:
          'bbe8f1b2a1415d6942b653689a51ba16f22b41e57a4e44b40799d',
        jwksURL: 'toto',
        jwtAlgorithm: [],
        trustedIdentity: false,
        createdAt: now,
        updatedAt: now,
        updatedBy: 'admin',
      };

      const itemTest2 = { ...itemTest1, name: 'joker' };

      const identityProvidersResult = {
        items: [itemTest1, itemTest2],
        itemCount: 2,
        totalItems: 2,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function
      serviceMock.paginate.mockResolvedValueOnce(identityProvidersResult);

      // Calling the list function
      const resultat = await identityProviderController.list(
        req,
        sort,
        action,
        page,
        limit,
      );

      // Expected
      expect(resultat.identityProviders.length).toEqual(2);
      expect(resultat.identityProviders).toEqual([itemTest1, itemTest2]);
    });

    it('should return return a list sort alphabetically of identity providers if sort="name" and action="desc"', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const sort = 'name';
      const action = 'desc';

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      const now = new Date('2019-11-08T09:52:29.984Z');

      // //Mocking Items
      const itemTest1: IdentityProvider = {
        id: itemId,
        name: 'joker',
        active: true,
        order: 2,
        hoverMsg: 'Message to display',
        hoverRedirectLink: 'Message to display',
        blacklistByIdentityProviderActivated: true,
        WhitelistByServiceProviderActivated: true,
        display: true,
        title: 'Identity Provider Example',
        image: '',
        imageFocus: '',
        alt: 'impots',
        eidas: 2,
        mailto: '',
        specificText: 'specific text fip1',
        url: 'https://fip1.docker.dev-franceconnect.fr/',
        statusURL: 'https://fip1.docker.dev-franceconnect.fr/',
        authzURL: 'https://fip1.docker.dev-franceconnect.fr/user/authorize',
        tokenURL: 'https://fip1.docker.dev-franceconnect.fr/user/token',
        userInfoURL: 'https://fip1.docker.dev-franceconnect.fr/api/user',
        endSessionURL: 'https://issuer.fr/logout',
        discoveryUrl: 'https://issuer/.well-known/openid-configuration',
        discovery: true,
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        clientSecretHash:
          'bbe8f1b2a1415d6942b653689a51ba16f22b41e57a4e44b40799d',
        jwksURL: 'toto',
        jwtAlgorithm: [],
        trustedIdentity: false,
        createdAt: now,
        updatedAt: now,
        updatedBy: 'admin',
      };
      const itemTest2 = { ...itemTest1, name: 'Batman' };

      const identityProvidersResult = {
        items: [itemTest1, itemTest2],
        itemCount: 2,
        totalItems: 2,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function
      serviceMock.paginate.mockResolvedValueOnce(identityProvidersResult);

      // Calling the list function
      const {
        pageCount,
        identityProviders,
      } = await identityProviderController.list(req, sort, action, page, limit);

      // Expected
      expect(identityProviders.length).toEqual(2);
      expect(identityProviders).toEqual([itemTest1, itemTest2]);
    });

    it('should return return a list sort (active value) of identity providers if sort="active" and action="desc"', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const sort = 'name';
      const action = 'desc';

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      const now = new Date('2019-11-08T09:52:29.984Z');

      // //Mocking Items
      const itemTest1: IdentityProvider = {
        id: itemId,
        name: 'joker',
        active: false,
        order: 2,
        hoverMsg: 'Message to display',
        hoverRedirectLink: 'Message to display',
        blacklistByIdentityProviderActivated: true,
        WhitelistByServiceProviderActivated: true,
        display: true,
        title: 'Identity Provider Example',
        image: '',
        imageFocus: '',
        alt: 'impots',
        eidas: 2,
        mailto: '',
        specificText: 'specific text fip1',
        url: 'https://fip1.docker.dev-franceconnect.fr/',
        statusURL: 'https://fip1.docker.dev-franceconnect.fr/',
        authzURL: 'https://fip1.docker.dev-franceconnect.fr/user/authorize',
        tokenURL: 'https://fip1.docker.dev-franceconnect.fr/user/token',
        userInfoURL: 'https://fip1.docker.dev-franceconnect.fr/api/user',
        endSessionURL: 'https://issuer.fr/logout',
        discoveryUrl: 'https://issuer/.well-known/openid-configuration',
        discovery: true,
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        clientSecretHash:
          'bbe8f1b2a1415d6942b653689a51ba16f22b41e57a4e44b40799d',
        jwksURL: 'toto',
        jwtAlgorithm: [],
        trustedIdentity: false,
        createdAt: now,
        updatedAt: now,
        updatedBy: 'admin',
      };
      const itemTest2 = { ...itemTest1, name: 'Batman', active: true };

      const identityProvidersResult = {
        items: [itemTest1, itemTest2],
        itemCount: 2,
        totalItems: 2,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function
      serviceMock.paginate.mockResolvedValueOnce(identityProvidersResult);

      // Calling the list function
      const {
        pageCount,
        identityProviders,
      } = await identityProviderController.list(req, sort, action, page, limit);

      // Expected
      expect(identityProviders.length).toEqual(2);
      expect(identityProviders).toEqual([itemTest1, itemTest2]);
    });

    it('should return return a list sort (active value) of identity providers if sort="active" and action="asc"', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const sort = 'name';
      const action = 'desc';

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      const now = new Date('2019-11-08T09:52:29.984Z');

      // //Mocking Items
      const itemTest1: IdentityProvider = {
        id: itemId,
        name: 'joker',
        active: true,
        order: 2,
        hoverMsg: 'Message to display',
        hoverRedirectLink: 'Message to display',
        blacklistByIdentityProviderActivated: true,
        WhitelistByServiceProviderActivated: true,
        display: true,
        title: 'Identity Provider Example',
        image: '',
        imageFocus: '',
        alt: 'impots',
        eidas: 2,
        mailto: '',
        specificText: 'specific text fip1',
        url: 'https://fip1.docker.dev-franceconnect.fr/',
        statusURL: 'https://fip1.docker.dev-franceconnect.fr/',
        authzURL: 'https://fip1.docker.dev-franceconnect.fr/user/authorize',
        tokenURL: 'https://fip1.docker.dev-franceconnect.fr/user/token',
        userInfoURL: 'https://fip1.docker.dev-franceconnect.fr/api/user',
        endSessionURL: 'https://issuer.fr/logout',
        discoveryUrl: 'https://issuer/.well-known/openid-configuration',
        discovery: true,
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        clientSecretHash:
          'bbe8f1b2a1415d6942b653689a51ba16f22b41e57a4e44b40799d',
        jwksURL: 'toto',
        jwtAlgorithm: [],
        trustedIdentity: false,
        createdAt: now,
        updatedAt: now,
        updatedBy: 'admin',
      };

      const itemTest2 = { ...itemTest1, name: 'Batman', active: false };

      const identityProvidersResult = {
        items: [itemTest1, itemTest2],
        itemCount: 2,
        totalItems: 2,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function
      serviceMock.paginate.mockResolvedValueOnce(identityProvidersResult);
      // Calling the list function
      const resultat = await identityProviderController.list(
        req,
        sort,
        action,
        page,
        limit,
      );

      // Expected
      expect(resultat.identityProviders.length).toEqual(2);
      expect(resultat.identityProviders).toEqual([itemTest1, itemTest2]);
    });
  });
});
