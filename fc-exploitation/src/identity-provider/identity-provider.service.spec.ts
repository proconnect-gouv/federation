import { Repository } from 'typeorm';
import { ConfigService } from 'nestjs-config';
import { Test, TestingModule } from '@nestjs/testing';
import { getRepositoryToken, TypeOrmModule } from '@nestjs/typeorm';
import { ObjectID } from 'mongodb';
import { LoggerService } from '@fc/shared/logger/logger.service';
import { IdentityProviderDTO } from './dto/identity-provider.dto';
import { IIdentityProviderLegacy } from './interface/identity-provider-legacy.interface';
import { IdentityProviderService } from './identity-provider.service';
import { IdentityProvider } from './identity-provider.mongodb.entity';
import { SecretManagerService } from '../utils/secret-manager.service';
import * as MockDate from 'mockdate';
import { getModelToken } from '@nestjs/mongoose';
import { ProviderSchema } from './schema/provider.schema';
import { ICrudTrack } from '../interfaces';

describe('IdentityProviderService', () => {
  let module: TestingModule;
  let identityProviderService: IdentityProviderService;

  const identityProviderRepository = {
    findOneAndUpdate: jest.fn(),
    insertOne: jest.fn(),
    find: jest.fn(),
    findAndCount: jest.fn(),
    findOne: jest.fn(),
    delete: jest.fn(),
  };

  const insertResultMock = {
    insertedId: 'insertedIdValueMock',
  };

  const secretManagerMocked = {
    encrypt: jest.fn(),
    generateSHA256: jest.fn(),
  };

  const encryptedSecret = '**********';
  const objectId = '648c1742c74d6a3d84b31943';

  const additionalFields = {
    featureHandlers: {},
    response_types: ['code'],
    redirect_uris: ['https://sp.fr/oidc-callback'],
    post_logout_redirect_uris: ['https://sp.fr/oidc-callback'],
    revocation_endpoint_auth_method: ['https://sp.fr/oidc-callback'],
  };

  const configIdentityProviderMock = {
    defaultValues: {},
    instanceFor: 'FCP',
  };

  const configMock = {
    get: jest.fn(),
  };

  const modifierMock = {
    $set: {},
    $unset: {},
  };

  const loggerMock = {
    businessEvent: jest.fn(),
  };

  beforeEach(async () => {
    module = await Test.createTestingModule({
      imports: [TypeOrmModule.forFeature([IdentityProvider], 'fc-mongo')],
      providers: [
        IdentityProviderService,
        {
          provide: getModelToken('Provider'),
          useValue: ProviderSchema,
        },
        Repository,
        SecretManagerService,
        ConfigService,
        LoggerService,
      ],
    })
      .overrideProvider(getRepositoryToken(IdentityProvider, 'fc-mongo'))
      .useValue(identityProviderRepository)
      .overrideProvider(SecretManagerService)
      .useValue(secretManagerMocked)
      .overrideProvider(ConfigService)
      .useValue(configMock)
      .overrideProvider(LoggerService)
      .useValue(loggerMock)
      .compile();

    identityProviderService = await module.get<IdentityProviderService>(
      IdentityProviderService,
    );

    jest.resetAllMocks();

    MockDate.set('1970-01-01');
    secretManagerMocked.encrypt.mockResolvedValueOnce(encryptedSecret);
    configMock.get.mockResolvedValue(configIdentityProviderMock);
    identityProviderRepository.insertOne.mockResolvedValue(insertResultMock);
  });

  afterAll(async () => {
    MockDate.reset();
    module.close();
  });

  describe('create', () => {
    it('creates the identity provider with all informations filled', async () => {
      const IIdentityProvider: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: 'https://issuer.fr/logout',
        statusUrl: 'https://issuer.fr/state',
        jwksUrl: 'https://issuer.fr/discovery',
        discoveryUrl:
          'https://my-discovery-url/.well-known/openid-configuration',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: 'SUPER MESSAGE !!!',
        redirectionTargetWhenInactive: 'https://issuer.fr/promo',
        active: false,
        display: false,
        isBeta: false,
        alt: 'MonFI Image',
        image: 'AliceM.svg',
        imageFocus: 'AliceM.svg',
        trustedIdentity: false,
        eidas: 2,
        order: 1,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText:
          "Veuillez fournir une capture d'écran de votre page de profil !",
        ...additionalFields,
      };
      await identityProviderService.create(IIdentityProvider, 'user');

      expect(identityProviderRepository.insertOne).toHaveBeenCalledTimes(1);
    });

    it('calls the tracking method of the service', async () => {
      // Given
      const IIdentityProvider: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: 'https://issuer.fr/logout',
        statusUrl: 'https://issuer.fr/state',
        jwksUrl: 'https://issuer.fr/discovery',
        discoveryUrl:
          'https://my-discovery-url/.well-known/openid-configuration',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: 'SUPER MESSAGE !!!',
        redirectionTargetWhenInactive: 'https://issuer.fr/promo',
        active: false,
        display: false,
        isBeta: false,
        alt: 'MonFI Image',
        image: 'AliceM.svg',
        imageFocus: 'AliceM.svg',
        trustedIdentity: false,
        eidas: 2,
        order: 1,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText:
          "Veuillez fournir une capture d'écran de votre page de profil !",
        ...additionalFields,
      };

      const userMock = 'userMockValue';
      // tslint:disable-next-line:no-string-literal
      identityProviderService['track'] = jest.fn();

      // When
      await identityProviderService.create(IIdentityProvider, userMock);

      // Then
      // tslint:disable-next-line:no-string-literal
      expect(identityProviderService['track']).toHaveBeenCalledTimes(1);
      // tslint:disable-next-line:no-string-literal
      expect(identityProviderService['track']).toHaveBeenCalledWith({
        entity: 'identity-provider',
        action: 'create',
        user: userMock,
        id: insertResultMock.insertedId,
        name: IIdentityProvider.name,
      });
    });
    it('creates the identity provider with eidas level 1', async () => {
      const IIdentityProvider: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: 'https://issuer.fr/logout',
        statusUrl: 'https://issuer.fr/state',
        jwksUrl: 'https://issuer.fr/discovery',
        discoveryUrl:
          'https://my-discovery-url/.well-known/openid-configuration',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: 'SUPER MESSAGE !!!',
        redirectionTargetWhenInactive: 'https://issuer.fr/promo',
        active: false,
        display: false,
        isBeta: false,
        alt: 'MonFI Image',
        image: 'AliceM.svg',
        imageFocus: 'AliceM.svg',
        trustedIdentity: false,
        eidas: 1,
        order: 1,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText:
          "Veuillez fournir une capture d'écran de votre page de profil !",
        ...additionalFields,
      };

      configMock.get.mockResolvedValue({
        defaultValues: {},
        instanceFor: 'FCA',
      });

      await identityProviderService.create(IIdentityProvider, 'user');

      expect(identityProviderRepository.insertOne).toHaveBeenCalledTimes(1);
    });

    it('creates the identity provider with all informations filled for the FCA version', async () => {
      const IIdentityProvider: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: 'https://issuer.fr/logout',
        statusUrl: 'https://issuer.fr/state',
        jwksUrl: 'https://issuer.fr/discovery',
        discoveryUrl:
          'https://my-discovery-url/.well-known/openid-configuration',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: 'SUPER MESSAGE !!!',
        redirectionTargetWhenInactive: 'https://issuer.fr/promo',
        active: false,
        display: false,
        isBeta: false,
        alt: 'MonFI Image',
        image: 'AliceM.svg',
        imageFocus: 'AliceM.svg',
        trustedIdentity: false,
        eidas: 2,
        order: 1,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText:
          "Veuillez fournir une capture d'écran de votre page de profil !",
        ...additionalFields,
      };
      configMock.get.mockResolvedValue({
        defaultValues: {},
        instanceFor: 'FCA',
      });
      await identityProviderService.create(IIdentityProvider, 'user');

      expect(identityProviderRepository.insertOne).toHaveBeenCalledTimes(1);
    });

    it('creates the identity provider with only mandatory informations filled', async () => {
      const IIdentityProvider: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: '',
        statusUrl: '',
        jwksUrl: '',
        discoveryUrl: '',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: '',
        redirectionTargetWhenInactive: '',
        active: false,
        display: false,
        isBeta: false,
        alt: '',
        image: '',
        imageFocus: '',
        trustedIdentity: false,
        eidas: 1,
        order: 0,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText: '',
        ...additionalFields,
      };
      await identityProviderService.create(IIdentityProvider, 'user');

      expect(identityProviderRepository.insertOne).toHaveBeenCalledTimes(1);
    });

    it('saves the identity provider with all information filled', async () => {
      const IIdentityProvider: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: 'https://issuer.fr/logout',
        statusUrl: 'https://issuer.fr/statusUrl',
        jwksUrl: 'https://issuer.fr/jwksUrl',
        discoveryUrl:
          'https://my-discovery-url/.well-known/openid-configuration',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: 'inactive',
        redirectionTargetWhenInactive: 'https://redirect-inactive',
        active: false,
        display: false,
        isBeta: false,
        alt: 'alt',
        image: 'image.png',
        imageFocus: 'image.svg',
        trustedIdentity: false,
        eidas: 1,
        order: 0,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText: 'specific text',
        ...additionalFields,
      };

      const expected: IIdentityProviderLegacy = {
        uid: 'MonFI',
        url: 'https://issuer.fr',
        userInfoURL: 'https://issuer.fr/userinfo',
        active: false,
        alt: 'alt',
        authzURL: 'https://issuer.fr/auth',
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '**********',
        createdAt: new Date('1970-01-01T00:00:00.000Z'),
        discoveryUrl:
          'https://my-discovery-url/.well-known/openid-configuration',
        discovery: true,
        display: false,
        isBeta: false,
        eidas: 1,
        endSessionURL: 'https://issuer.fr/logout',
        hoverMsg: 'inactive',
        hoverRedirectLink: 'https://redirect-inactive',
        image: 'image.png',
        imageFocus: 'image.svg',
        jwksURL: 'https://issuer.fr/jwksUrl',
        jwtAlgorithm: [],
        mailto: 'sherman@kaliop.com\r\nvbonnard@kaliopmail.com',
        name: 'MonFI',
        order: 0,
        specificText: 'specific text',
        statusURL: 'https://issuer.fr/statusUrl',
        title: 'Mon FI mieux écrit',
        tokenURL: 'https://issuer.fr/token',
        trustedIdentity: false,
        updatedAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedBy: 'user',
        blacklistByIdentityProviderActivated: false,
        WhitelistByServiceProviderActivated: false,
        ...additionalFields,
      };
      await identityProviderService.create(IIdentityProvider, 'user');

      expect(identityProviderRepository.insertOne).toHaveBeenCalledTimes(1);
      expect(identityProviderRepository.insertOne).toHaveBeenCalledWith(
        expected,
      );
    });

    it('convert the identity provider input to legacy format and add the defaults values before saving', async () => {
      const IIdentityProvider: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: '',
        statusUrl: '',
        jwksUrl: '',
        discoveryUrl: '',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: '',
        redirectionTargetWhenInactive: '',
        active: false,
        display: false,
        isBeta: false,
        alt: '',
        image: '',
        imageFocus: '',
        trustedIdentity: false,
        eidas: 1,
        order: 0,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText: '',
        ...additionalFields,
      };

      const expected: IIdentityProviderLegacy = {
        uid: 'MonFI',
        name: 'MonFI',
        url: 'https://issuer.fr',
        hoverMsg: 'Disponible prochainement',
        hoverRedirectLink: '',
        display: false,
        title: 'Mon FI mieux écrit',
        image: '',
        alt: '',
        imageFocus: '',
        eidas: 1,
        mailto: 'sherman@kaliop.com\r\nvbonnard@kaliopmail.com',
        statusURL: '',
        authzURL: 'https://issuer.fr/auth',
        tokenURL: 'https://issuer.fr/token',
        userInfoURL: 'https://issuer.fr/userinfo',
        endSessionURL: '',
        discoveryUrl: '',
        discovery: true,
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '**********',
        order: 0,
        jwksURL: '',
        jwtAlgorithm: [],
        trustedIdentity: false,
        specificText:
          'Une erreur est survenue lors de la transmission de votre identité.',
        active: false,
        isBeta: false,
        createdAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedBy: 'user',
        blacklistByIdentityProviderActivated: false,
        WhitelistByServiceProviderActivated: false,
        ...additionalFields,
      };
      await identityProviderService.create(IIdentityProvider, 'user');

      expect(identityProviderRepository.insertOne).toHaveBeenCalledTimes(1);
      expect(identityProviderRepository.insertOne).toHaveBeenCalledWith(
        expected,
      );
    });

    it('set to "false" the "active" and "display" fields before saving', async () => {
      const IIdentityProvider: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: '',
        statusUrl: '',
        jwksUrl: '',
        discoveryUrl: '',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: '',
        redirectionTargetWhenInactive: '',
        active: true,
        display: true,
        isBeta: false,
        alt: '',
        image: '',
        imageFocus: '',
        trustedIdentity: false,
        eidas: 1,
        order: 0,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText: '',
        ...additionalFields,
      };

      const expected: Partial<IdentityProvider> = {
        uid: 'MonFI',
        name: 'MonFI',
        url: 'https://issuer.fr',
        hoverMsg: 'Disponible prochainement',
        hoverRedirectLink: '',
        display: false,
        title: 'Mon FI mieux écrit',
        image: '',
        alt: '',
        imageFocus: '',
        eidas: 1,
        mailto: 'sherman@kaliop.com\r\nvbonnard@kaliopmail.com',
        statusURL: '',
        authzURL: 'https://issuer.fr/auth',
        tokenURL: 'https://issuer.fr/token',
        userInfoURL: 'https://issuer.fr/userinfo',
        endSessionURL: '',
        discoveryUrl: '',
        discovery: true,
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '**********',
        order: 0,
        jwksURL: '',
        jwtAlgorithm: [],
        trustedIdentity: false,
        specificText:
          'Une erreur est survenue lors de la transmission de votre identité.',
        active: false,
        isBeta: false,
        createdAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedBy: 'user',
        blacklistByIdentityProviderActivated: false,
        WhitelistByServiceProviderActivated: false,
        ...additionalFields,
      };

      await identityProviderService.create(IIdentityProvider, 'user');

      expect(identityProviderRepository.insertOne).toHaveBeenCalledTimes(1);
      expect(identityProviderRepository.insertOne).toHaveBeenCalledWith(
        expected,
      );
    });
  });

  describe('update()', () => {
    const idMock = new ObjectID(objectId);
    beforeEach(() => {
      const identityProviderMock: IdentityProvider = {
        id: idMock,
        uid: 'MonFI',
        name: 'MonFI',
        url: 'https://issuer.fr',
        hoverMsg: 'Disponible prochainement',
        hoverRedirectLink: '',
        display: false,
        title: 'Mon FI mieux écrit',
        image: '',
        alt: '',
        imageFocus: '',
        eidas: 1,
        mailto: 'sherman@kaliop.com\r\nvbonnard@kaliopmail.com',
        statusURL: '',
        authzURL: 'https://issuer.fr/auth',
        tokenURL: 'https://issuer.fr/token',
        userInfoURL: 'https://issuer.fr/userinfo',
        endSessionURL: '',
        discoveryUrl: '',
        discovery: true,
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '**********',
        order: 0,
        jwksURL: '',
        jwtAlgorithm: [],
        trustedIdentity: false,
        isBeta: false,
        specificText:
          'Une erreur est survenue lors de la transmission de votre identité.',
        active: false,
        createdAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedBy: 'user',
        blacklistByIdentityProviderActivated: false,
        WhitelistByServiceProviderActivated: false,
        ...additionalFields,
      };
      identityProviderRepository.findOne.mockResolvedValueOnce(
        identityProviderMock,
      );
    });

    it('updates the identity provider with all informations filled', async () => {
      const updateForm: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: 'https://issuer.fr/logout',
        statusUrl: 'https://issuer.fr/state',
        jwksUrl: 'https://issuer.fr/discovery',
        discoveryUrl:
          'https://my-discovery-url/.well-known/openid-configuration',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: 'SUPER MESSAGE !!!',
        redirectionTargetWhenInactive: 'https://issuer.fr/promo',
        active: false,
        display: false,
        isBeta: false,
        alt: 'MonFI Image',
        image: 'AliceM.svg',
        imageFocus: 'AliceM.svg',
        trustedIdentity: false,
        eidas: 2,
        order: 1,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText:
          "Veuillez fournir une capture d'écran de votre page de profil !",
        ...additionalFields,
      };

      await identityProviderService.update(objectId, updateForm, 'user');

      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledTimes(
        1,
      );
    });

    it('updates the identity provider with level eidas 1', async () => {
      const updateForm: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: 'https://issuer.fr/logout',
        statusUrl: 'https://issuer.fr/state',
        jwksUrl: 'https://issuer.fr/discovery',
        discoveryUrl:
          'https://my-discovery-url/.well-known/openid-configuration',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: 'SUPER MESSAGE !!!',
        redirectionTargetWhenInactive: 'https://issuer.fr/promo',
        active: false,
        display: false,
        isBeta: false,
        alt: 'MonFI Image',
        image: 'AliceM.svg',
        imageFocus: 'AliceM.svg',
        trustedIdentity: false,
        eidas: 1,
        order: 1,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText:
          "Veuillez fournir une capture d'écran de votre page de profil !",
        ...additionalFields,
      };

      configMock.get.mockResolvedValue({
        defaultValues: {},
        instanceFor: 'FCA',
      });

      await identityProviderService.update(objectId, updateForm, 'user');

      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledTimes(
        1,
      );
    });

    it('updates the identity provider with all informations filled for FCA version', async () => {
      const updateForm: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: 'https://issuer.fr/logout',
        statusUrl: 'https://issuer.fr/state',
        jwksUrl: 'https://issuer.fr/discovery',
        discoveryUrl:
          'https://my-discovery-url/.well-known/openid-configuration',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: 'SUPER MESSAGE !!!',
        redirectionTargetWhenInactive: 'https://issuer.fr/promo',
        active: false,
        display: false,
        isBeta: false,
        alt: 'MonFI Image',
        image: 'AliceM.svg',
        imageFocus: 'AliceM.svg',
        trustedIdentity: false,
        eidas: 2,
        order: 1,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText:
          "Veuillez fournir une capture d'écran de votre page de profil !",
        ...additionalFields,
      };

      configMock.get.mockResolvedValue({
        defaultValues: {},
        instanceFor: 'FCA',
      });

      await identityProviderService.update(objectId, updateForm, 'user');

      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledTimes(
        1,
      );
    });

    it('updates the identity provider with only mandatory informations filled', async () => {
      const updateForm: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://issuer.fr',
        authorizationUrl: 'https://issuer.fr/auth',
        tokenUrl: 'https://issuer.fr/token',
        userInfoUrl: 'https://issuer.fr/userinfo',
        logoutUrl: '',
        statusUrl: '',
        jwksUrl: '',
        discoveryUrl: '',
        discovery: true,
        clientId: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: '',
        redirectionTargetWhenInactive: '',
        active: false,
        display: false,
        isBeta: false,
        alt: '',
        image: '',
        imageFocus: '',
        trustedIdentity: false,
        eidas: 1,
        order: 0,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText: '',
        ...additionalFields,
      };

      await identityProviderService.update(objectId, updateForm, 'user');

      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledTimes(
        1,
      );
    });

    it('updates the identity provider if some fields are updated', async () => {
      const updateForm: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://new-issuer.fr',
        logoutUrl: '',
        statusUrl: '',
        discoveryUrl: 'https://discoveryurl.com',
        discovery: true,
        clientId: 'new-09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: '',
        redirectionTargetWhenInactive: '',
        active: true,
        display: true,
        isBeta: false,
        alt: '',
        image: '',
        imageFocus: '',
        trustedIdentity: false,
        eidas: 1,
        order: 0,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText: '',
        ...additionalFields,
      };

      const modifier = JSON.parse(JSON.stringify(modifierMock));
      modifier.$set = {
        name: 'MonFI',
        url: 'https://new-issuer.fr',
        hoverMsg: 'Disponible prochainement',
        hoverRedirectLink: '',
        display: true,
        title: 'Mon FI mieux écrit',
        image: '',
        alt: '',
        imageFocus: '',
        eidas: 1,
        mailto: 'sherman@kaliop.com\r\nvbonnard@kaliopmail.com',
        statusURL: '',
        endSessionURL: '',
        discoveryUrl: 'https://discoveryurl.com',
        discovery: true,
        clientID: 'new-09a1a257648c1742c74d6a3d84b31943',
        client_secret: '**********',
        order: 0,
        jwtAlgorithm: [],
        trustedIdentity: false,
        specificText:
          'Une erreur est survenue lors de la transmission de votre identité.',
        active: true,
        isBeta: false,
        createdAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedBy: 'user',
        blacklistByIdentityProviderActivated: false,
        WhitelistByServiceProviderActivated: false,
        ...additionalFields,
      };
      modifier.$unset = {
        authzURL: '',
        tokenURL: '',
        userInfoURL: '',
        jwksURL: '',
      };

      await identityProviderService.update(objectId, updateForm, 'user');

      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledTimes(
        1,
      );
      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledWith(
        {
          _id: idMock,
        },
        modifier,
      );
    });

    it('calls the tracking method of the service', async () => {
      // Given
      const updateForm: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://new-issuer.fr',
        logoutUrl: '',
        statusUrl: '',
        discoveryUrl: 'https://discoveryurl.com',
        discovery: true,
        clientId: 'new-09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: '',
        redirectionTargetWhenInactive: '',
        active: true,
        display: true,
        isBeta: false,
        alt: '',
        image: '',
        imageFocus: '',
        trustedIdentity: false,
        eidas: 1,
        order: 0,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText: '',
        ...additionalFields,
      };

      const modifier = JSON.parse(JSON.stringify(modifierMock));
      modifier.$set = {
        name: 'MonFI',
        url: 'https://new-issuer.fr',
        hoverMsg: 'Disponible prochainement',
        hoverRedirectLink: '',
        display: true,
        title: 'Mon FI mieux écrit',
        image: '',
        alt: '',
        imageFocus: '',
        eidas: 1,
        mailto: 'sherman@kaliop.com\r\nvbonnard@kaliopmail.com',
        statusURL: '',
        endSessionURL: '',
        discoveryUrl: 'https://discoveryurl.com',
        discovery: true,
        clientID: 'new-09a1a257648c1742c74d6a3d84b31943',
        client_secret: '**********',
        order: 0,
        jwtAlgorithm: [],
        trustedIdentity: false,
        specificText:
          'Une erreur est survenue lors de la transmission de votre identité.',
        active: true,
        createdAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedBy: 'user',
        blacklistByIdentityProviderActivated: false,
        WhitelistByServiceProviderActivated: false,
        ...additionalFields,
      };
      modifier.$unset = {
        authzURL: '',
        tokenURL: '',
        userInfoURL: '',
        jwksURL: '',
      };
      // tslint:disable-next-line:no-string-literal
      identityProviderService['track'] = jest.fn();

      const userMock = 'userMockValue';

      // When
      await identityProviderService.update(objectId, updateForm, userMock);
      // Then
      // tslint:disable-next-line:no-string-literal
      expect(identityProviderService['track']).toHaveBeenCalledTimes(1);
      // tslint:disable-next-line:no-string-literal
      expect(identityProviderService['track']).toHaveBeenCalledWith({
        entity: 'identity-provider',
        action: 'update',
        user: userMock,
        name: 'MonFI',
        id: objectId,
      });
    });

    it('should not update the identity provider technical name', async () => {
      const updateForm: IdentityProviderDTO = {
        uid: 'MonFIButChanged',
        name: 'MonFIButChanged',
        title: 'Mon FI mieux écrit',
        issuer: 'https://new-issuer.fr',
        logoutUrl: '',
        statusUrl: '',
        discoveryUrl: 'https://discoveryurl.com',
        discovery: true,
        clientId: 'new-09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: '',
        redirectionTargetWhenInactive: '',
        active: true,
        display: false,
        isBeta: false,
        alt: '',
        image: '',
        imageFocus: '',
        trustedIdentity: false,
        eidas: 1,
        order: 0,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText: '',
        ...additionalFields,
      };

      const modifier = JSON.parse(JSON.stringify(modifierMock));
      modifier.$set = {
        name: 'MonFIButChanged',
        url: 'https://new-issuer.fr',
        hoverMsg: 'Disponible prochainement',
        hoverRedirectLink: '',
        display: false,
        title: 'Mon FI mieux écrit',
        image: '',
        alt: '',
        imageFocus: '',
        eidas: 1,
        mailto: 'sherman@kaliop.com\r\nvbonnard@kaliopmail.com',
        statusURL: '',
        endSessionURL: '',
        discoveryUrl: 'https://discoveryurl.com',
        discovery: true,
        clientID: 'new-09a1a257648c1742c74d6a3d84b31943',
        client_secret: '**********',
        order: 0,
        jwtAlgorithm: [],
        trustedIdentity: false,
        specificText:
          'Une erreur est survenue lors de la transmission de votre identité.',
        active: true,
        isBeta: false,
        createdAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedBy: 'user',
        blacklistByIdentityProviderActivated: false,
        WhitelistByServiceProviderActivated: false,
        ...additionalFields,
      };
      modifier.$unset = {
        authzURL: '',
        tokenURL: '',
        userInfoURL: '',
        jwksURL: '',
      };

      await identityProviderService.update(objectId, updateForm, 'user');

      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledTimes(
        1,
      );
      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledWith(
        {
          _id: idMock,
        },
        modifier,
      );
    });

    it('saves who updated the identity provider', async () => {
      const updateForm: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://new-issuer.fr',
        logoutUrl: '',
        statusUrl: '',
        discoveryUrl: 'https://discoveryurl.com',
        discovery: true,
        clientId: 'new-09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: '',
        redirectionTargetWhenInactive: '',
        active: true,
        display: false,
        isBeta: false,
        alt: '',
        image: '',
        imageFocus: '',
        trustedIdentity: false,
        eidas: 1,
        order: 0,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText: '',
        ...additionalFields,
      };

      const modifier = JSON.parse(JSON.stringify(modifierMock));
      modifier.$set = {
        name: 'MonFI',
        url: 'https://new-issuer.fr',
        hoverMsg: 'Disponible prochainement',
        hoverRedirectLink: '',
        display: false,
        title: 'Mon FI mieux écrit',
        image: '',
        alt: '',
        imageFocus: '',
        eidas: 1,
        mailto: 'sherman@kaliop.com\r\nvbonnard@kaliopmail.com',
        statusURL: '',
        endSessionURL: '',
        discoveryUrl: 'https://discoveryurl.com',
        discovery: true,
        clientID: 'new-09a1a257648c1742c74d6a3d84b31943',
        client_secret: '**********',
        order: 0,
        jwtAlgorithm: [],
        trustedIdentity: false,
        specificText:
          'Une erreur est survenue lors de la transmission de votre identité.',
        active: true,
        isBeta: false,
        createdAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedBy: 'NoobMaster69',
        blacklistByIdentityProviderActivated: false,
        WhitelistByServiceProviderActivated: false,
        ...additionalFields,
      };
      modifier.$unset = {
        authzURL: '',
        tokenURL: '',
        userInfoURL: '',
        jwksURL: '',
      };

      configMock.get.mockResolvedValue({ instanceFor: 'FCP' });

      await identityProviderService.update(
        objectId,
        updateForm,
        'NoobMaster69',
      );

      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledTimes(
        1,
      );
      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledWith(
        {
          _id: idMock,
        },
        modifier,
      );
    });

    it('saves the updated identity provider if discoveryurl is unset and discovery is false', async () => {
      const updateForm: IdentityProviderDTO = {
        uid: 'MonFI',
        name: 'MonFI',
        title: 'Mon FI mieux écrit',
        issuer: 'https://new-issuer.fr',
        authorizationUrl: 'https://new-issuer.fr/auth',
        tokenUrl: 'https://new-issuer.fr/token',
        userInfoUrl: 'https://new-issuer.fr/userinfo',
        jwksUrl: 'https://new-issuer.fr/jwksUrl',
        logoutUrl: '',
        statusUrl: '',
        discovery: false,
        clientId: 'new-09a1a257648c1742c74d6a3d84b31943',
        client_secret: '1234567890AZERTYUIOP',
        messageToDisplayWhenInactive: '',
        redirectionTargetWhenInactive: '',
        active: true,
        display: false,
        isBeta: false,
        alt: '',
        image: '',
        imageFocus: '',
        trustedIdentity: false,
        eidas: 1,
        order: 0,
        emails: ['sherman@kaliop.com', 'vbonnard@kaliopmail.com'],
        specificText: '',
        ...additionalFields,
      };

      const modifier = JSON.parse(JSON.stringify(modifierMock));
      modifier.$set = {
        name: 'MonFI',
        url: 'https://new-issuer.fr',
        hoverMsg: 'Disponible prochainement',
        hoverRedirectLink: '',
        display: false,
        title: 'Mon FI mieux écrit',
        authzURL: 'https://new-issuer.fr/auth',
        tokenURL: 'https://new-issuer.fr/token',
        userInfoURL: 'https://new-issuer.fr/userinfo',
        jwksURL: 'https://new-issuer.fr/jwksUrl',
        image: '',
        alt: '',
        imageFocus: '',
        eidas: 1,
        mailto: 'sherman@kaliop.com\r\nvbonnard@kaliopmail.com',
        statusURL: '',
        endSessionURL: '',
        discovery: false,
        clientID: 'new-09a1a257648c1742c74d6a3d84b31943',
        client_secret: '**********',
        order: 0,
        jwtAlgorithm: [],
        trustedIdentity: false,
        specificText:
          'Une erreur est survenue lors de la transmission de votre identité.',
        active: true,
        isBeta: false,
        createdAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedBy: 'NoobMaster69',
        blacklistByIdentityProviderActivated: false,
        WhitelistByServiceProviderActivated: false,
        ...additionalFields,
      };
      modifier.$unset = {
        discoveryUrl: '',
      };

      configMock.get.mockResolvedValue({ instanceFor: 'FCP' });

      await identityProviderService.update(
        objectId,
        updateForm,
        'NoobMaster69',
      );

      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledTimes(
        1,
      );
      expect(identityProviderRepository.findOneAndUpdate).toHaveBeenCalledWith(
        {
          _id: idMock,
        },
        modifier,
      );
    });
  });

  describe('track', () => {
    it('should call logger.businessEvent()', () => {
      // Given
      const argsMock = {} as ICrudTrack;
      // When
      // tslint:disable-next-line:no-string-literal
      identityProviderService['track'](argsMock);
      // Then
      expect(loggerMock.businessEvent).toHaveBeenCalledTimes(1);
      expect(loggerMock.businessEvent).toHaveBeenCalledWith(argsMock);
    });
  });

  describe('delete identity provider by id', () => {
    beforeEach(() => {
      const identityProviderMock = ({
        id: 'idMock',
        uid: 'MonFI',
        name: 'MonFI',
      } as unknown) as IdentityProvider;

      identityProviderRepository.findOne.mockResolvedValueOnce(
        identityProviderMock,
      );
    });
    it('calls the delete function of the identityProviderRepository with an ID as argument', async () => {
      // set up
      const id = { id: '123' };
      const expectedRepositoryDeleteArguments = { id: '123' };
      const user = 'mockUsername';
      // action
      await identityProviderService.deleteIdentityProvider(id, user);
      // assertion
      expect(identityProviderRepository.delete).toHaveBeenCalledTimes(1);
      expect(identityProviderRepository.delete).toHaveBeenCalledWith(
        expectedRepositoryDeleteArguments,
      );
    });

    it('calls the tracking method of the service', async () => {
      // Given
      const id = '123';
      const user = 'mockUsername';
      // tslint:disable-next-line:no-string-literal
      identityProviderService['track'] = jest.fn();
      // When
      await identityProviderService.deleteIdentityProvider(id, user);
      // Then
      // tslint:disable-next-line:no-string-literal
      expect(identityProviderService['track']).toHaveBeenCalledTimes(1);
      // tslint:disable-next-line:no-string-literal
      expect(identityProviderService['track']).toHaveBeenCalledWith({
        entity: 'identity-provider',
        action: 'delete',
        name: 'MonFI',
        user,
        id,
      });
    });
  });

  describe('buildModifier', () => {
    let identityProviderMock: IIdentityProviderLegacy;
    beforeEach(() => {
      identityProviderMock = {
        uid: 'MonFI',
        name: 'MonFI',
        url: 'https://issuer.fr',
        hoverMsg: 'Disponible prochainement',
        hoverRedirectLink: '',
        display: true,
        title: 'Mon FI mieux écrit',
        image: '',
        alt: '',
        imageFocus: '',
        eidas: 1,
        mailto: 'sherman@kaliop.com\r\nvbonnard@kaliopmail.com',
        statusURL: '',
        authzURL: 'https://issuer.fr/auth',
        tokenURL: 'https://issuer.fr/token',
        userInfoURL: 'https://issuer.fr/userinfo',
        endSessionURL: '',
        discoveryUrl: 'https://discoveryUrl.com',
        discovery: true,
        clientID: '09a1a257648c1742c74d6a3d84b31943',
        client_secret: '**********',
        order: 0,
        jwksURL: '',
        jwtAlgorithm: [],
        trustedIdentity: false,
        specificText:
          'Une erreur est survenue lors de la transmission de votre identité.',
        active: true,
        isBeta: false,
        createdAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedAt: new Date('1970-01-01T00:00:00.000Z'),
        updatedBy: 'user',
        blacklistByIdentityProviderActivated: false,
        WhitelistByServiceProviderActivated: false,
        ...additionalFields,
      };
    });
    it('Should generate modifier with discovery mode', () => {
      // Given
      const providerToSave = JSON.parse(JSON.stringify(identityProviderMock));
      delete providerToSave.authzURL;
      delete providerToSave.tokenURL;
      delete providerToSave.userInfoURL;
      delete providerToSave.jwksURL;

      // When
      const result = identityProviderService.buildModifier(providerToSave);

      // Then
      expect(result).toStrictEqual({
        $set: {
          ...providerToSave,
        },
        $unset: {
          authzURL: '',
          tokenURL: '',
          userInfoURL: '',
          jwksURL: '',
        },
      });
    });

    it('Should generate modifier without discovery', () => {
      // Given
      const providerToSave = JSON.parse(JSON.stringify(identityProviderMock));
      delete providerToSave.discoveryUrl;
      providerToSave.discovery = false;

      // When
      const result = identityProviderService.buildModifier(providerToSave);

      // Then
      expect(result).toStrictEqual({
        $set: {
          ...providerToSave,
        },
        $unset: {
          discoveryUrl: '',
        },
      });
    });
  });
});
