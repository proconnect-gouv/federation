import { Test } from '@nestjs/testing';
import { getRepositoryToken, TypeOrmModule } from '@nestjs/typeorm';
import { Repository } from 'typeorm';
import { UserRole } from '@fc/shared/user/roles.enum';
import { UserService } from '@fc/shared/user/user.service';
import { User } from '@fc/shared/user/user.entity';
import { CreateUserDto } from './dto/create-user.dto';
import { AccountController } from './account.controller';
import { AccountService } from './account.service';
import { Pagination } from 'nestjs-typeorm-paginate';

describe('AccountController', () => {
  let accountController: AccountController;
  let service: AccountService;

  const serviceMock = {
    paginate: jest.fn(),
  };

  const userService = {
    compareHash: jest.fn(),
    findByUsername: jest.fn(),
    createUser: jest.fn(),
    deleteUserById: jest.fn(),
  };
  const res = {
    redirect: jest.fn(),
    status: jest.fn(),
    locals: {
      APP_ROOT: '/foo/bar',
    },
  };
  const req = {
    flash: jest.fn(),
    user: {
      id: '05e4fadf-fda6-4ad8-ae75-b7f315843827',
    },
    csrfToken: function csrfToken() {
      return 'mygreatcsrftoken';
    },
  };

  const createUserDto = new CreateUserDto(
    'jean_moust',
    'jean@moust.lol',
    'yolo',
    'yolo',
    [UserRole.OPERATOR],
  );
  const userRepository = {
    find: jest.fn(),
  };

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      imports: [TypeOrmModule.forFeature([User])],
      controllers: [AccountController],
      providers: [
        UserService,
        AccountService,
        {
          provide: getRepositoryToken(AccountService),
          useClass: Repository,
        },
      ],
    })
      .overrideProvider(UserService)
      .useValue(userService)
      .overrideProvider(getRepositoryToken(User))
      .useValue(userRepository)
      .overrideProvider(AccountService)
      .useValue(serviceMock)
      .compile();

    accountController = module.get<AccountController>(AccountController);
    service = await module.get<AccountService>(AccountService);

    jest.resetAllMocks();
  });

  describe('list', () => {
    it('returns all the users', async () => {
      // Setup
      const page = '0';
      const limit = '10';

      // Mocking Items
      const itemTest1: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };
      const itemTest2: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };
      const itemTest3: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };
      const itemTest4: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };
      const itemTest5: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };
      const itemTest6: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };
      const itemTest7: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };
      const itemTest8: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };
      const itemTest9: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };
      const itemTest10: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };
      const itemTest11: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };
      const itemTest12: User = {
        id: '5d35b91e70332098440d0f85',
        username: 'kizaru',
        email: 'kizaru@onepiece.com',
        roles: [],
        passwordHash: '54689adfrt',
      };

      // Mocking return value of serviceProviderController.list(page, limit)
      const user = {
        items: [
          itemTest1,
          itemTest2,
          itemTest3,
          itemTest4,
          itemTest5,
          itemTest6,
          itemTest7,
          itemTest8,
          itemTest9,
          itemTest10,
          itemTest11,
          itemTest12,
        ],
        itemCount: 12,
        totalItems: 12,
        totalUsers: 12,
        pageCount: 2,
        next: '/account?page=2&limit=10',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function
      const result: Promise<Pagination<User>> = Promise.resolve(user);

      // Mocking the return of service paginte function
      const spy = jest
        .spyOn(service, 'paginate')
        .mockImplementation(() => Promise.resolve(result));

      // Calling the list function
      const resultat = await accountController.list(req, page, limit);

      // Expected
      expect(spy).toHaveBeenCalled();
      expect(resultat.totalUsers).toEqual(12);
      expect(resultat.pages).toEqual(2);
      expect(resultat.users.length).toEqual(12);
      expect(resultat.next).toEqual('/account?page=2&limit=10');
    });
  });

  describe('createUser', () => {
    it('redirects the user when a valid user is provided', async () => {
      await accountController.createUser(createUserDto, req, res);
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith('/foo/bar/account');
    });

    it('uses the user service to create users', async () => {
      await accountController.createUser(createUserDto, req, res);

      expect(userService.createUser).toHaveBeenCalledTimes(1);
      expect(userService.createUser).toHaveBeenCalledWith(createUserDto);
    });
  });

  describe('delete', () => {
    it('should call deleteUser of the user service with the provided id', async () => {
      // set up
      const id = 'd3d3f8a1-26ea-4a8b-9ed3-336d3777b529';
      // action
      await accountController.deleteUser(id, req, res);
      // assertion
      expect(userService.deleteUserById).toHaveBeenCalledTimes(1);
      expect(userService.deleteUserById).toHaveBeenCalledWith(id);
      expect(res.redirect).toHaveBeenCalledWith('/foo/bar/account');
    });

    it('should not call deleteUser of the user service but redirect the user to the /account page', async () => {
      // set up
      const id = '05e4fadf-fda6-4ad8-ae75-b7f315843827';
      // action
      await accountController.deleteUser(id, req, res);
      // assertion
      expect(res.redirect).toHaveBeenCalledWith('/foo/bar/account');
      expect(userService.deleteUserById).toHaveBeenCalledTimes(0);
    });

    it('should not redirect the user but set the res status to 500 for the error handler', async () => {
      // set up
      userService.deleteUserById = jest.fn(() => {
        throw Error;
      });
      const id = '2d1280f1-1611-42fa-968a-47e450e0aeba';
      // action
      await accountController.deleteUser(id, req, res);
      // assertion
      expect(res.status).toHaveBeenCalledWith(500);
      expect(res.redirect).toHaveBeenCalledTimes(0);
      expect(userService.deleteUserById).toHaveBeenCalledTimes(1);
    });
  });
});
