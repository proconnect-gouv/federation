import { Test } from '@nestjs/testing';
import { getRepositoryToken, TypeOrmModule } from '@nestjs/typeorm';
import { UserRole } from 'shared/user/roles.enum';
import { UserService } from 'shared/user/user.service';
import { User } from 'shared/user/user.entity';
import { CreateUserDto } from './dto/create-user.dto';
import { AccountController } from './account.controller';

describe('AccountController', () => {
  let accountController: AccountController;
  const userService = {
    compareHash: jest.fn(),
    findByUsername: jest.fn(),
    createUser: jest.fn(),
  };
  const res = {
    redirect: jest.fn(),
  };
  const req = {
    flash: jest.fn(),
  };
  const createUserDto = new CreateUserDto(
    'jean_moust',
    'jean@moust.lol',
    'yolo',
    'yolo',
    [UserRole.OPERATOR],
  );
  const userRepository = {
    find: jest.fn(),
  };

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      imports: [TypeOrmModule.forFeature([User])],
      controllers: [AccountController],
      providers: [UserService],
    })
      .overrideProvider(UserService)
      .useValue(userService)
      .overrideProvider(getRepositoryToken(User))
      .useValue(userRepository)
      .compile();

    accountController = module.get<AccountController>(AccountController);

    jest.resetAllMocks();
  });

  describe('createUser', () => {
    it('redirects the user when a valid user is provided', async () => {
      await accountController.createUser(createUserDto, req, res);
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith('/');
    });

    it('uses the user service to create users', async () => {
      await accountController.createUser(createUserDto, req, res);

      expect(userService.createUser).toHaveBeenCalledTimes(1);
      expect(userService.createUser).toHaveBeenCalledWith(createUserDto);
    });

    describe('list', () => {
      it('returns all the users', async () => {
        const mockedUsers = ['toto', 'tata', 'tutu'];
        userRepository.find.mockResolvedValueOnce(mockedUsers);

        const { users } = await accountController.list();

        expect(users).toEqual(mockedUsers);
      });
    });
  });
});
