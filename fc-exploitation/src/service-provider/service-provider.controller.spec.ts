import { Test } from '@nestjs/testing';
import { ServiceProviderController } from './service-provider.controller';
import { getRepositoryToken, TypeOrmModule } from '@nestjs/typeorm';
import { Repository, FindManyOptions } from 'typeorm';
import { ObjectID } from 'mongodb';
import { ServiceProvider } from './service-provider.entity';
import { ServiceProviderService } from './service-provider.service';
import { Pagination } from 'nestjs-typeorm-paginate';

describe('ServiceProviderController', () => {
  let serviceProviderController: ServiceProviderController;
  let service: ServiceProviderService;
  const serviceProviderRepository = {
    count: jest.fn(),
    findAndCount: jest.fn(),
    find: jest.fn(),
  };

  const serviceProviderService = {
    createServiceProvider: jest.fn(),
    paginate: jest.fn(),
  };

  const renderMock = {
    render: jest.fn(),
  };

  const res = {
    redirect: jest.fn(),
    status: jest.fn(),
    locals: {
      APP_ROOT: '/foo/bar',
    },
  };

  const createServiceProviderDto = {
    name: 'monfs',
    redirectUri: { result: ['https://url.com'] },
    redirectUriLogout: { result: ['https://url.com/logout'] },
    site: 'https:/monsite.com',
    emails: { result: ['v@b.com'] },
    ipAddresses: { result: ['192.0.0.0'] },
    active: 'oui',
    clientStatus: 'public',
  };

  const expectedResultAfterTransformation = {
    name: 'monfs',
    redirectUri: ['https://url.com'],
    redirectUriLogout: ['https://url.com/logout'],
    site: 'https:/monsite.com',
    emails: ['v@b.com'],
    ipAddresses: ['192.0.0.0'],
    active: 'oui',
    clientStatus: 'public',
  };

  const req = {
    flash: jest.fn(),
    user: {
      id: '05e4fadf-fda6-4ad8-ae75-b7f315843827',
    },
    csrfToken: function csrfToken() {
      return 'mygreatcsrftoken';
    },
  };

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      imports: [TypeOrmModule.forFeature([ServiceProvider], 'fc-mongo')],
      controllers: [ServiceProviderController],
      providers: [
        ServiceProviderService,
        {
          provide: getRepositoryToken(ServiceProviderService),
          useClass: Repository,
        },
      ],
    })
      .overrideProvider(getRepositoryToken(ServiceProvider, 'fc-mongo'))
      .useValue(serviceProviderRepository)
      .overrideProvider(ServiceProviderService)
      .useValue(serviceProviderService)
      .compile();

    serviceProviderController = await module.get<ServiceProviderController>(
      ServiceProviderController,
    );

    service = await module.get<ServiceProviderService>(ServiceProviderService);

    jest.resetAllMocks();

    renderMock.render.mockReturnValueOnce(true);
    res.status.mockReturnValueOnce(renderMock);
  });

  describe('list method', () => {
    it('returns the list of the available service providers', async () => {
      // Setup
      const page = '0';
      const limit = '10';

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      // Mocking Items
      const itemTest1: ServiceProvider = {
        id: itemId,
        name: 'users',
        title: 'Site Usagers',
        redirectUris: ['https://url.com'],
        postLogoutRedirectUris: [''],
        site: 'https:/monsite.com',
        email: ['v@b.com'],
        ips: ['192.0.0.0'],
        active: 'true',
        status: 'public',
        clientSecretCreatedAt: new Date(),
        secretHash: '76eded44d32b40c0cb1006065',
        clientId:
          '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
      };

      const itemTest2: ServiceProvider = {
        id: itemId,
        name: 'users',
        title: 'Site Usagers',
        redirectUris: ['https://url.com'],
        postLogoutRedirectUris: [''],
        site: 'https:/monsite.com',
        email: ['v@b.com'],
        ips: ['192.0.0.0'],
        active: 'true',
        status: 'public',
        clientSecretCreatedAt: new Date(),
        secretHash: '76eded44d32b40c0cb1006065',
        clientId:
          '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
      };

      const itemTest3: ServiceProvider = {
        id: itemId,
        name: 'users',
        title: 'Site Usagers',
        redirectUris: ['https://url.com'],
        postLogoutRedirectUris: [''],
        site: 'https:/monsite.com',
        email: ['v@b.com'],
        ips: ['192.0.0.0'],
        active: 'true',
        status: 'public',
        clientSecretCreatedAt: new Date(),
        secretHash: '76eded44d32b40c0cb1006065',
        clientId:
          '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
      };

      // Mocking return value of serviceProviderController.list(page, limit)
      const serviceProvidersResult = {
        items: [itemTest1, itemTest2, itemTest3],
        itemCount: 3,
        totalItems: 3,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function
      const result: Promise<Pagination<ServiceProvider>> = Promise.resolve(
        serviceProvidersResult,
      );

      const spy = jest
        .spyOn(service, 'paginate')
        .mockImplementation(() => Promise.resolve(result));

      // Calling the list function
      const resultat = await serviceProviderController.list(req, page, limit);

      // Expected
      expect(resultat.pages).toEqual(0);
      expect(resultat.serviceProviders.length).toEqual(3);
    });

    it('call repository with active true', async () => {
      const mockedCount = 10;
      /// const result = serviceProviderRepository.count.mockResolvedValueOnce(mockedCount);

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      // Mocking Items
      const itemTest1: ServiceProvider = {
        id: itemId,
        name: 'users',
        title: 'Site Usagers',
        redirectUris: ['https://url.com'],
        postLogoutRedirectUris: [''],
        site: 'https:/monsite.com',
        email: ['v@b.com'],
        ips: ['192.0.0.0'],
        active: 'true',
        status: 'public',
        clientSecretCreatedAt: new Date(),
        secretHash: '76eded44d32b40c0cb1006065',
        clientId:
          '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
      };

      const itemTest2: ServiceProvider = {
        id: itemId,
        name: 'users',
        title: 'Site Usagers',
        redirectUris: ['https://url.com'],
        postLogoutRedirectUris: [''],
        site: 'https:/monsite.com',
        email: ['v@b.com'],
        ips: ['192.0.0.0'],
        active: 'true',
        status: 'public',
        clientSecretCreatedAt: new Date(),
        secretHash: '76eded44d32b40c0cb1006065',
        clientId:
          '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
      };

      const itemTest3: ServiceProvider = {
        id: itemId,
        name: 'users',
        title: 'Site Usagers',
        redirectUris: ['https://url.com'],
        postLogoutRedirectUris: [''],
        site: 'https:/monsite.com',
        email: ['v@b.com'],
        ips: ['192.0.0.0'],
        active: 'true',
        status: 'public',
        clientSecretCreatedAt: new Date(),
        secretHash: '76eded44d32b40c0cb1006065',
        clientId:
          '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
      };

      // Mocking return value of serviceProviderController.list(page, limit)
      const serviceProvidersResult = {
        items: [itemTest1, itemTest2, itemTest3],
        itemCount: 3,
        totalItems: 3,
        pageCount: 0,
        next: '',
        previous: '',
      };

      const result: Promise<Pagination<ServiceProvider>> = Promise.resolve(
        serviceProvidersResult,
      );

      const spy = jest
        .spyOn(service, 'paginate')
        .mockImplementation(() => Promise.resolve(result));

      const data = await serviceProviderController.list(req, '0', '10');

      expect(serviceProviderRepository.count).toHaveBeenCalledWith({
        active: 'true',
      });
    });
  });

  describe('createUser', () => {
    it('redirects the user when a valid user is provided', async () => {
      await serviceProviderController.createServiceProvider(
        createServiceProviderDto,
        req,
        res,
      );
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith('/foo/bar/');
    });

    it('uses the user service to create users', async () => {
      await serviceProviderController.createServiceProvider(
        createServiceProviderDto,
        req,
        res,
      );

      expect(
        serviceProviderService.createServiceProvider,
      ).toHaveBeenCalledTimes(1);
      expect(serviceProviderService.createServiceProvider).toHaveBeenCalledWith(
        expectedResultAfterTransformation,
      );
    });
    it('should not redirect the user but set the res status to 422 for the error handler', async () => {
      // set up
      serviceProviderService.createServiceProvider = jest.fn(() => {
        throw Error;
      });
      // action
      await serviceProviderController.createServiceProvider(
        createServiceProviderDto,
        req,
        res,
      );
      // assertion
      expect(res.status).toHaveBeenCalledWith(422);
      expect(renderMock.render).toHaveBeenCalledWith(
        'service-provider/creation',
        {
          values: createServiceProviderDto,
          globalError: Error,
          csrfToken: 'mygreatcsrftoken',
        },
      );
      expect(
        serviceProviderService.createServiceProvider,
      ).toHaveBeenCalledTimes(1);
    });
  });
});
