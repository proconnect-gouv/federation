import { Test } from '@nestjs/testing';
import { ServiceProviderController } from './service-provider.controller';
import { getRepositoryToken, TypeOrmModule } from '@nestjs/typeorm';
import { ObjectID } from 'mongodb';
import { Pagination } from 'nestjs-typeorm-paginate';
import { ServiceProvider } from './service-provider.mongodb.entity';
import { FileStorage } from '../file-storage/file-storage.mongodb.entity';
import { ServiceProviderService } from './service-provider.service';
import { FileStorageService } from '../file-storage/file-storage.service';
import { AlgoName, AlgoValue } from '../enum';

jest.mock('uuid'); // allow to mock all module
import { v4 as uuidv4 } from 'uuid';

const logoFileMock = {
  _id: new ObjectID('5d63959eeaf61f5938153586'),
  fieldname: 'logo',
  originalname: 'name.png',
  encoding: '7bits',
  mimetype: 'image/png',
  buffer: new Buffer('myimagebuffer'),
  size: 1024 * 1024, // 1MB
};

const logoAsDataUri =
  'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAXwAAADI\
BAMAAAAZ5UcuAAAAG1BMVEXMzMyWlpacnJyqqqrFxcWxsbGjo6O3t7e+vr6He3KoAAAACXBIWXMAAA\
7EAAAOxAGVKw4bAAAFJklEQVR4nO2bzW/bRhDFhx8SdeRSsdwjlbi1j1bbADmStuPmKAlp0KMUuHCOk\
hq4Vyltgv7ZnZldShQl20ELSXT7foDJJXcEP63ezg4XIBEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\
AAAAAAAAAAAAAAAAAD+D0Tvk18zbd11v5u4W53JfeGv3yevyIXf0qPhuybsGmO+kdYFN5K53BpzI9s\
e3uAgcy6ta26c0CPhO0dEGzNnFdqQL+JLI90ePpC+jrTkayf0SPjO6Rn335vaSAqJR1ujWxpk+u5nk\
MZD4TuHx/xtODPHRAtzmv3UNRO+lXzkRrYtvGnaf77pmZgoN6dXM/OMHgzfOZHapdvmn0EG/oJ93ZBb\
Cx3YDXK5Hcm3HbDhWjLoD4XvnEDn4ZSld+V7RGwj33oj3RY+ULeP+dt2j9zlQ+E7pymzlgeVSIzATo\
j5IpPGs23hPfX4InH9EvpQ+M7x1bR5UpI/tYnl2AbkZkRilUyv9CeS8Ehv+zxV1sP3TPS7HBcdJ0DMM\
9AR7rlcotYOi8zS1UH2DN8Wswd8XA8/CGLkniw9MnV7OpDTdtGXiMzUXliPeAnfkYU22gzfP6EmQEm\
cr2UBG6tBFh3XO2WhuXFVwV9z7UvcnGmxhSrheye3q65dh45K/rb4PPK9ZO0TvTbf5Y+wqdJq+N5h+f\
b3F/mTwt9LPS1z3LJFUYGsFXbKq/z18L2T28VfKi9jzpb+NkX/OGlqmlky5UvPpiJOVNXwfZNbz+S2n\
MlE0pqe3IzXSoJA6kvXLfIr4Xsn/CKqx7bmGW0MZ2BMOa3wr3RCNRp9klWp31KNAdu6amau6spL6tR0M\
qqR90lKh5FL7Vy8baSSQbkeC+zTSn0yD0l2SX2b2rl420jk3VI9xtY5lXNN8v7nX1SUia0bZEWqLqOR\
S6zKhWlrXE1WXVtw8RR0c49PA1WyKmJ891Co9Nz621ALac1TCd8rC1Wm5smkxR6e6q1VCTkwq4eRqFjA\
IjWUVpyV8L2SGytm5LzPHq4U8FxtBssLvyh+alPv9+3RZZ5xu/r4xB3hMvGvZmg9nrYC3avpmczmfT\
GHVvj50i/S6hXL7mBZ/Mizbrh81s0P9KzbMslHLpjlccWczt+MeRQrWwfjpHjkkoujn5W67DTobpOxmw\
XFhtXaxk1LsmajmLHGUZd9Hqd6Uqr317fNmtrqOs+v5Ndkl033zXQhnbnvsb5pOdVbA5txwpL8euxxy\
pbxaof5rTa+bsu4FjvMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMA/wXN/T5QnId8kP97TU5Ef\
85UnL1vIC1Ix6Zu9dCmvLVybG/JSou5ulW4lDn+4p2eLfD125nTn5IffZn/w4WqYeR8oGu9e7QYxXdD3\
L8jPIm40np+TN4zlFDwfiPzhC2pOuKck/3hEt05+0LeHxrl3R83pYeQ3bq77wSSn3+jd1UvybvT07koG\
0+OuVkovy/Ljs1bq5PuZPYSp588/HWKisHn8LExb58PJKzrhcfYyPZ1QLvK5i275z74nZeXfNSdOvlcc\
Yi8a3R5CPk9dHdT0bJSKRFEjp7jwfkyfAnmZaDX6/ow2R59O04OMvvx/GeLRhxGdWMVyKo2+P6Q1+Y0j2\
vQ+DfoHki/ep+Fk1qe77FI0ymnlfYqO1+XrhR5LmYcOs0iIDM48tMjyjKLumYiQ0yrzUJRukW8NdmmKvH\
8g+V9B82m/Rzc7tIB/hXd2aAUAAPAf52/rXdAObZ4NXQAAAABJRU5ErkJggg==';

const scopeList = [
  'openid',
  'given_name',
  'family_name',
  'bithdate',
  'gender',
  'birthplace',
  'birthcountry',
  'email',
  'dgfip_rfr',
  'dgfip_nbpart',
  'dgfip_sitfam',
  'dgfip_pac',
  'dgfip_aft',
];

describe('ServiceProviderController', () => {
  let serviceProviderController: ServiceProviderController;
  let service: ServiceProviderService;

  const serviceProviderRepository = {
    count: jest.fn(),
    findAndCount: jest.fn(),
    find: jest.fn(),
  };

  const fileStorageRepository = {};

  const serviceProviderServiceMock = {
    createServiceProvider: jest.fn(),
    paginate: jest.fn(),
    find: jest.fn(),
    findById: jest.fn(),
    update: jest.fn(),
    deleteLogo: jest.fn(),
    deleteServiceProviderByKey: jest.fn(),
    generateNewSecret: jest.fn(),
    updateLogo: jest.fn(),
  };

  const fileStorageServiceMock = {
    storeFile: jest.fn(),
    deleteFile: jest.fn(),
    getFileAsDataUri: jest.fn(),
  };

  const renderMock = {
    render: jest.fn(),
  };

  const res = {
    redirect: jest.fn(),
    status: jest.fn(),
    locals: {
      APP_ROOT: '/foo/bar',
    },
  };

  const ServiceProviderDtoMock = {
    name: 'monfs',
    signupId: '123456',
    redirectUri: [
      'https://url.com',
      'fc+app01://openid_redirect_url',
      'FC-app.02://openid_redirect_url',
      'franceconnect://openid_redirect_url',
    ],
    redirectUriLogout: [
      'https://url.com',
      'fc+app01://openid_redirect_url',
      'FC-app.02://openid_redirect_url',
      'franceconnect://openid_redirect_url',
    ],
    site: ['https://monsite.com'],
    emails: ['v@b.com'],
    ipAddresses: ['192.0.0.0'],
    active: true,
    type: 'public',
    logo: logoAsDataUri,
    scopes: [...scopeList],
    identityConsent: false,
    trustedIdentity: false,
    eidas: 1,
  };

  const ServiceProviderDtoNoLogoMock = {
    name: 'monfs',
    signupId: '123456',
    redirectUri: ['https://url.com'],
    redirectUriLogout: ['https://url.com/logout'],
    site: ['https://monsite.com'],
    emails: ['v@b.com'],
    ipAddresses: ['192.0.0.0'],
    active: true,
    type: 'public',
    logo: '',
    scopes: [...scopeList],
    identityConsent: false,
    trustedIdentity: false,
    eidas: 1,
  };

  const idParam = '05e4fadf-fda6-4ad8-ae75-b7f315843827';

  const UpdateServiceProviderLogoInputDto = {
    logo: logoAsDataUri,
    filename: '424242424_logo.png',
  };

  const deleteServiceProviderLogoInputDto = {
    filename: '424242424_logo.png',
  };

  const req = {
    flash: jest.fn(),
    params: { id: idParam },
    session: {},
    user: { id: idParam, username: 'mocker' },
    csrfToken: () => 'mygreatcsrftoken',
  };

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      imports: [
        TypeOrmModule.forFeature([ServiceProvider, FileStorage], 'fc-mongo'),
      ],
      providers: [
        ServiceProviderController,
        ServiceProviderService,
        FileStorageService,
      ],
    })
      .overrideProvider(getRepositoryToken(ServiceProvider, 'fc-mongo'))
      .useValue(serviceProviderRepository)
      .overrideProvider(getRepositoryToken(FileStorage, 'fc-mongo'))
      .useValue(fileStorageRepository)
      .overrideProvider(ServiceProviderService)
      .useValue(serviceProviderServiceMock)
      .overrideProvider(FileStorageService)
      .useValue(fileStorageServiceMock)
      .compile();

    serviceProviderController = await module.get<ServiceProviderController>(
      ServiceProviderController,
    );

    service = await module.get<ServiceProviderService>(ServiceProviderService);

    jest.resetAllMocks();

    renderMock.render.mockReturnValueOnce(true);
    res.status.mockReturnValueOnce(renderMock);
  });

  describe('list method', () => {
    it('returns the list of the available service providers', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const action = '';
      const search = '';

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      // Mocking Items
      const itemTest1: ServiceProvider = {
        id: itemId,
        name: 'Site Usagers',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date(),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date(),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      const itemTest2: ServiceProvider = {
        id: itemId,
        name: 'Site Usagers',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date(),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date(),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      const itemTest3: ServiceProvider = {
        id: itemId,
        name: 'Site Usagers',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date(),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date(),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 2,
        userinfo_encrypted_response_enc: 'ES256',
        userinfo_encrypted_response_alg: 'RSA-OAEP',
        userinfo_signed_response_alg: 'ES256',
        id_token_signed_response_alg: 'ES256',
        id_token_encrypted_response_alg: 'ECDH-ES',
        id_token_encrypted_response_enc: 'ES256',
      };

      // Mocking return value of serviceProviderController.list(page, limit)
      const serviceProvidersResult = {
        items: [itemTest1, itemTest2, itemTest3],
        itemCount: 3,
        total: 3,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions

      // Mocking the return of the paginate function
      const result = Promise.resolve(serviceProvidersResult);

      const spy = jest
        .spyOn(service, 'paginate')
        .mockImplementation(() => Promise.resolve(result));

      // Calling the list function
      const resultat = await serviceProviderController.list(
        req,
        search,
        action,
        page,
        limit,
      );

      // Expected
      expect(resultat.serviceProviders.length).toEqual(3);
    });

    it('call repository with active true', async () => {
      const mockedCount = 10;
      const action = '';
      const search = '';
      /// const result = serviceProviderRepository.count.mockResolvedValueOnce(mockedCount);

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      // Mocking Items
      const itemTest1: ServiceProvider = {
        id: itemId,
        name: 'Site Usagers',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date(),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date(),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      const itemTest2: ServiceProvider = {
        id: itemId,
        name: 'Site Usagers',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date(),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date(),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      const itemTest3: ServiceProvider = {
        id: itemId,
        name: 'Site Usagers',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date(),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date(),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      // Mocking return value of serviceProviderController.list(page, limit)
      const serviceProvidersResult = {
        items: [itemTest1, itemTest2, itemTest3],
        itemCount: 3,
        totalItems: 3,
        pageCount: 0,
        next: '',
        previous: '',
      };

      const result: Promise<Pagination<ServiceProvider>> = Promise.resolve(
        serviceProvidersResult,
      );

      const spy = jest
        .spyOn(service, 'paginate')
        .mockImplementation(() => Promise.resolve(result));

      const data = await serviceProviderController.list(
        req,
        search,
        action,
        '0',
        '10',
      );

      expect(serviceProviderRepository.count).toHaveBeenCalledWith({
        active: true,
      });
    });
  });

  describe('createServiceProvider', () => {
    it('create a user when it validates form with logo', async () => {
      // Setup
      const logoFileNameMock = {
        filename: 'hello.png',
      };

      // uuidv4 is fully mocked by the jest.mock("uuid") on top
      (uuidv4 as jest.Mock).mockReturnValue('mockedfilename.png');
      const logoMock = FileStorageService.fromBase64(
        ServiceProviderDtoMock.logo,
      );

      const databaseMock = {
        ...ServiceProviderDtoMock,
        logo: logoFileNameMock.filename,
      };

      const mock = { ...ServiceProviderDtoMock };

      fileStorageServiceMock.storeFile.mockResolvedValueOnce(logoFileNameMock);

      // Action
      await serviceProviderController.createServiceProvider(mock, req, res);

      // Assert
      expect(fileStorageServiceMock.storeFile).toHaveBeenCalledTimes(1);
      expect(fileStorageServiceMock.storeFile).toHaveBeenCalledWith(logoMock);
      expect(
        serviceProviderServiceMock.createServiceProvider,
      ).toHaveBeenCalledTimes(1);
      expect(
        serviceProviderServiceMock.createServiceProvider,
      ).toHaveBeenCalledWith(databaseMock, req.user.username);
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith(
        'success',
        `Le fournisseur de service ${ServiceProviderDtoMock.name} a été créé avec succès !`,
      );

      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(`${res.locals.APP_ROOT}/`);
    });

    it('create a user when it validates form without logo', async () => {
      // Setup
      const mock = { ...ServiceProviderDtoNoLogoMock };

      // Action
      await serviceProviderController.createServiceProvider(mock, req, res);

      // Assert
      expect(fileStorageServiceMock.storeFile).toHaveBeenCalledTimes(0);
      expect(
        serviceProviderServiceMock.createServiceProvider,
      ).toHaveBeenCalledTimes(1);
      expect(
        serviceProviderServiceMock.createServiceProvider,
      ).toHaveBeenCalledWith(ServiceProviderDtoNoLogoMock, req.user.username);
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith(
        'success',
        `Le fournisseur de service ${ServiceProviderDtoMock.name} a été créé avec succès !`,
      );

      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(`${res.locals.APP_ROOT}/`);
    });

    it('should redirect to the form with flashed error if the creation failed with logo', async () => {
      // Setup
      const logoFileNameMock = {
        filename: 'hello.png',
      };

      const databaseMock = {
        ...ServiceProviderDtoMock,
        logo: logoFileNameMock.filename,
      };

      fileStorageServiceMock.storeFile.mockResolvedValueOnce(logoFileNameMock);

      serviceProviderServiceMock.createServiceProvider = jest.fn(() => {
        throw Error;
      });

      const mock = { ...ServiceProviderDtoMock };

      // Action
      await serviceProviderController.createServiceProvider(mock, req, res);

      // Assert
      expect(
        serviceProviderServiceMock.createServiceProvider,
      ).toHaveBeenCalledTimes(1);
      expect(
        serviceProviderServiceMock.createServiceProvider,
      ).toHaveBeenCalledWith(databaseMock, req.user.username);

      expect(req.flash).toHaveBeenCalledTimes(2);
      expect(req.flash).toHaveBeenNthCalledWith(
        1,
        'globalError',
        "Impossible d'enregistrer le fournisseur de service",
      );
      expect(req.flash).toHaveBeenNthCalledWith(2, 'values', databaseMock);

      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/create`,
      );
    });

    it('should redirect to the form with flashed error if the creation failed without logo', async () => {
      // Setup
      serviceProviderServiceMock.createServiceProvider = jest.fn(() => {
        throw Error;
      });

      const mock = { ...ServiceProviderDtoNoLogoMock };

      // Action
      await serviceProviderController.createServiceProvider(mock, req, res);

      // Assert
      expect(
        serviceProviderServiceMock.createServiceProvider,
      ).toHaveBeenCalledTimes(1);
      expect(
        serviceProviderServiceMock.createServiceProvider,
      ).toHaveBeenCalledWith(ServiceProviderDtoNoLogoMock, req.user.username);

      expect(req.flash).toHaveBeenCalledTimes(2);
      expect(req.flash).toHaveBeenNthCalledWith(
        1,
        'globalError',
        "Impossible d'enregistrer le fournisseur de service",
      );
      expect(req.flash).toHaveBeenNthCalledWith(
        2,
        'values',
        ServiceProviderDtoNoLogoMock,
      );

      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/create`,
      );
    });

    it('should redirect to the form with flashed error if the logo cannot be stored', async () => {
      // Setup
      // uuidv4 is fully mocked by the jest.mock("uuid") on top
      (uuidv4 as jest.Mock).mockReturnValue('mockedfilename.png');
      const logoMock = FileStorageService.fromBase64(
        ServiceProviderDtoMock.logo,
      );

      fileStorageServiceMock.storeFile.mockRejectedValueOnce(
        new Error('Something occured...'),
      );

      const mock = { ...ServiceProviderDtoMock };

      // Action
      await serviceProviderController.createServiceProvider(mock, req, res);

      // Assert
      expect(fileStorageServiceMock.storeFile).toHaveBeenCalledTimes(1);
      expect(fileStorageServiceMock.storeFile).toHaveBeenCalledWith(logoMock);
      expect(
        serviceProviderServiceMock.createServiceProvider,
      ).toHaveBeenCalledTimes(0);

      expect(req.flash).toHaveBeenCalledTimes(2);
      expect(req.flash).toHaveBeenNthCalledWith(
        1,
        'globalError',
        "Impossible d'enregistrer le fournisseur de service",
      );
      expect(req.flash).toHaveBeenNthCalledWith(
        2,
        'values',
        ServiceProviderDtoMock,
      );

      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/create`,
      );
    });

    it('should create a service provider with a mobile URIScheme', async () => {
      // Setup
      const logoFileNameMock = {
        filename: 'hello.png',
      };

      // uuidv4 is fully mocked by the jest.mock("uuid") on top
      (uuidv4 as jest.Mock).mockReturnValue('mockedfilename.png');
      const logoMock = FileStorageService.fromBase64(
        ServiceProviderDtoMock.logo,
      );

      const databaseMock = {
        ...ServiceProviderDtoMock,
        logo: logoFileNameMock.filename,
      };

      const mock = { ...ServiceProviderDtoMock };

      fileStorageServiceMock.storeFile.mockResolvedValueOnce(logoFileNameMock);

      // Action
      await serviceProviderController.createServiceProvider(mock, req, res);

      // Assert
      expect(fileStorageServiceMock.storeFile).toHaveBeenCalledTimes(1);
      expect(fileStorageServiceMock.storeFile).toHaveBeenCalledWith(logoMock);
      expect(
        serviceProviderServiceMock.createServiceProvider,
      ).toHaveBeenCalledTimes(1);
      expect(
        serviceProviderServiceMock.createServiceProvider,
      ).toHaveBeenCalledWith(databaseMock, req.user.username);
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith(
        'success',
        `Le fournisseur de service ${ServiceProviderDtoMock.name} a été créé avec succès !`,
      );

      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(`${res.locals.APP_ROOT}/`);
    });
  });

  describe('get a service provider', () => {
    it('should get a service Provider and render update view', async () => {
      // setup
      const serviceProvider = {
        id: idParam,
        name: 'FranceConnect TEST 9',
        redirect_uris: ['https://FranceConnect.com'],
        post_logout_redirect_uris: ['https://FranceConnect.com'],
        site: ['https://FranceConnect8888.com'],
        status: 'public',
        email: ['v@b.com'],
        active: 'true',
        IPServerAddressesAndRanges: ['1.1.1.1'],
        key: 'cb55015c-7fb5-49b4-9006-e523552bc3e7',
        scopes: [...scopeList],
        trustedIdentity: false,
        eidas: 1,
      };

      serviceProviderServiceMock.findById.mockImplementation(() =>
        Promise.resolve(serviceProvider),
      );

      fileStorageServiceMock.getFileAsDataUri.mockResolvedValueOnce(
        logoAsDataUri,
      );

      // action
      const result = await serviceProviderController.findOne(idParam, req);

      // expect
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith('values', {
        ...serviceProvider,
        redirectUri: 'https://FranceConnect.com',
        ipsRanges: '1.1.1.1',
        postLogoutUri: 'https://FranceConnect.com',
        emails: 'v@b.com',
        currentLogo: logoAsDataUri,
        site: 'https://FranceConnect8888.com',
      });
      expect(result).toEqual({
        id: idParam,
        csrfToken: 'mygreatcsrftoken',
        AlgoName,
        AlgoValue,
      });
    });

    it('should get a service Provider and render update view even without logo', async () => {
      // setup
      const serviceProvider = {
        id: idParam,
        name: 'FranceConnect TEST 9',
        redirect_uris: ['https://FranceConnect.com'],
        post_logout_redirect_uris: ['https://FranceConnect.com'],
        site: ['https://FranceConnect8888.com'],
        status: 'public',
        email: ['v@b.com'],
        active: 'true',
        IPServerAddressesAndRanges: ['1.1.1.1'],
        key: 'cb55015c-7fb5-49b4-9006-e523552bc3e7',
        scopes: [...scopeList],
        trustedIdentity: false,
        eidas: 1,
      };

      serviceProviderServiceMock.findById.mockImplementation(() =>
        Promise.resolve(serviceProvider),
      );

      fileStorageServiceMock.getFileAsDataUri.mockResolvedValueOnce(undefined);

      // action
      const result = await serviceProviderController.findOne(idParam, req);

      // expect
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith('values', {
        ...serviceProvider,
        redirectUri: 'https://FranceConnect.com',
        ipsRanges: '1.1.1.1',
        postLogoutUri: 'https://FranceConnect.com',
        emails: 'v@b.com',
        site: 'https://FranceConnect8888.com',
      });
      expect(result).toEqual({
        id: idParam,
        csrfToken: 'mygreatcsrftoken',
        AlgoName,
        AlgoValue,
      });
    });
  });

  describe('serviceProviderUpdate', () => {
    it('should update a servicerProvider and return to the serviceProvider page', async () => {
      await serviceProviderController.serviceProviderUpdate(
        ServiceProviderDtoMock,
        idParam,
        req,
        res,
      );
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/${idParam}`,
      );
    });
    it("should redirect to the serviceProvider if we can't update the serviceProvider", async () => {
      serviceProviderServiceMock.update = jest.fn(() => {
        throw Error;
      });
      // action
      await serviceProviderController.serviceProviderUpdate(
        ServiceProviderDtoMock,
        idParam,
        req,
        res,
      );
      // assertion
      expect(serviceProviderServiceMock.update).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/${idParam}`,
      );
    });
    it('should update a servicerProvider with URIScheme for redirectUri field and return to the serviceProvider page', async () => {
      (ServiceProviderDtoMock.redirectUri = [
        'https://url.com',
        'fc+app01://openid_redirect_url',
        'FC-app.02://openid_redirect_url',
        'franceconnect://openid_redirect_url',
      ]),
        await serviceProviderController.serviceProviderUpdate(
          ServiceProviderDtoMock,
          idParam,
          req,
          res,
        );
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/${idParam}`,
      );
    });
    it('should update a servicerProvider with URIScheme for redirectUriLogout field and return to the serviceProvider page', async () => {
      (ServiceProviderDtoMock.redirectUriLogout = [
        'https://url.com',
        'fc+app01://openid_redirect_url',
        'FC-app.02://openid_redirect_url',
        'franceconnect://openid_redirect_url',
      ]),
        await serviceProviderController.serviceProviderUpdate(
          ServiceProviderDtoMock,
          idParam,
          req,
          res,
        );
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/${idParam}`,
      );
    });
  });

  describe('serviceProviderUpdateLogo', () => {
    it('should update the logo and redirect the user to the service provider page with success', async () => {
      // arrange
      const logoFileNameMock = {
        filename: '424242424_logo.png',
      };

      fileStorageServiceMock.deleteFile.mockResolvedValueOnce(logoFileMock);

      // uuidv4 is fully mocked by the jest.mock("uuid") on top
      (uuidv4 as jest.Mock).mockReturnValue(logoFileNameMock.filename);

      fileStorageServiceMock.storeFile.mockResolvedValueOnce(logoFileNameMock);

      // action
      await serviceProviderController.serviceProviderUpdateLogo(
        UpdateServiceProviderLogoInputDto,
        idParam,
        req,
        res,
      );

      // assert
      expect(serviceProviderServiceMock.updateLogo).toHaveBeenCalledTimes(1);
      expect(serviceProviderServiceMock.updateLogo).toHaveBeenCalledWith(
        idParam,
        logoFileNameMock.filename,
      );
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith(
        'success',
        'Le logo du fournisseur a été modifié avec succès !',
      );
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/${idParam}`,
      );
    });

    it('should remove the old logo if the update succeed', async () => {
      // arrange
      fileStorageServiceMock.storeFile.mockResolvedValueOnce(logoFileMock);
      serviceProviderServiceMock.updateLogo.mockResolvedValueOnce(logoFileMock);

      // action
      await serviceProviderController.serviceProviderUpdateLogo(
        UpdateServiceProviderLogoInputDto,
        idParam,
        req,
        res,
      );

      // assert
      expect(fileStorageServiceMock.deleteFile).toHaveBeenCalledTimes(1);
      expect(fileStorageServiceMock.deleteFile).toHaveBeenCalledWith(
        UpdateServiceProviderLogoInputDto.filename,
      );
    });

    it('should not update the logo and redirect the user to the service provider page with error', async () => {
      // arrange
      fileStorageServiceMock.deleteFile.mockResolvedValueOnce(logoFileMock);
      fileStorageServiceMock.storeFile.mockRejectedValueOnce(
        new Error('Something occured...'),
      );

      // action
      await serviceProviderController.serviceProviderUpdateLogo(
        UpdateServiceProviderLogoInputDto,
        idParam,
        req,
        res,
      );

      // assert
      expect(serviceProviderServiceMock.updateLogo).toHaveBeenCalledTimes(0);
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith(
        'globalError',
        'Impossible de mettre à jour le logo',
      );
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/${idParam}`,
      );
    });

    it('should not remove the old logo if the update fail for some reason', async () => {
      // arrange
      fileStorageServiceMock.storeFile.mockResolvedValueOnce(logoFileMock);
      serviceProviderServiceMock.updateLogo.mockRejectedValueOnce(
        new Error('Something occured...'),
      );

      // action
      await serviceProviderController.serviceProviderUpdateLogo(
        UpdateServiceProviderLogoInputDto,
        idParam,
        req,
        res,
      );

      // assert
      expect(fileStorageServiceMock.deleteFile).toHaveBeenCalledTimes(0);
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith(
        'globalError',
        'Impossible de mettre à jour le logo',
      );
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/${idParam}`,
      );
    });
  });

  describe('deleteServiceProvider', () => {
    it('should delete the logo and redirect the user to the service provider page with success', async () => {
      // arrange
      fileStorageServiceMock.deleteFile.mockResolvedValueOnce(logoFileMock);

      // action
      await serviceProviderController.serviceProviderDeleteLogo(
        deleteServiceProviderLogoInputDto,
        idParam,
        req,
        res,
      );

      // assert
      expect(serviceProviderServiceMock.deleteLogo).toHaveBeenCalledTimes(1);
      expect(serviceProviderServiceMock.deleteLogo).toHaveBeenCalledWith(
        idParam,
      );
      expect(fileStorageServiceMock.deleteFile).toHaveBeenCalledTimes(1);
      expect(fileStorageServiceMock.deleteFile).toHaveBeenCalledWith(
        deleteServiceProviderLogoInputDto.filename,
      );
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith(
        'success',
        'Le logo du fournisseur a été supprimé avec succès !',
      );
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/${idParam}`,
      );
    });

    it('should not delete the logo and redirect the user to the service provider page with error', async () => {
      // arrange
      serviceProviderServiceMock.deleteLogo.mockRejectedValue(
        new Error('Unknown Error'),
      );

      // action
      await serviceProviderController.serviceProviderDeleteLogo(
        deleteServiceProviderLogoInputDto,
        idParam,
        req,
        res,
      );

      // assert
      expect(serviceProviderServiceMock.deleteLogo).toHaveBeenCalledTimes(1);
      expect(serviceProviderServiceMock.deleteLogo).toHaveBeenCalledWith(
        idParam,
      );
      expect(fileStorageServiceMock.deleteFile).toHaveBeenCalledTimes(0);

      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith(
        'globalError',
        'Impossible de supprimer le logo',
      );
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/${idParam}`,
      );
    });

    it('should delete the logo reference and redirect the user to the service provider page with error', async () => {
      // arrange
      fileStorageServiceMock.deleteFile.mockRejectedValue(
        new Error('Unknown Error'),
      );

      // action
      await serviceProviderController.serviceProviderDeleteLogo(
        deleteServiceProviderLogoInputDto,
        idParam,
        req,
        res,
      );

      // assert
      expect(serviceProviderServiceMock.deleteLogo).toHaveBeenCalledTimes(1);
      expect(serviceProviderServiceMock.deleteLogo).toHaveBeenCalledWith(
        idParam,
      );
      expect(fileStorageServiceMock.deleteFile).toHaveBeenCalledTimes(1);
      expect(fileStorageServiceMock.deleteFile).toHaveBeenCalledWith(
        deleteServiceProviderLogoInputDto.filename,
      );

      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith(
        'globalError',
        'Impossible de supprimer le logo',
      );
      expect(res.redirect).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider/${idParam}`,
      );
    });
  });

  describe('Delete service provider', () => {
    it('Should redirect if service provider is removed', async () => {
      // set up
      const key = 'key';
      const body = { name: 'name' };

      // action
      serviceProviderServiceMock.deleteServiceProviderByKey.mockReturnValueOnce(
        {},
      );
      await serviceProviderController.deleteServiceProvider(
        key,
        req,
        res,
        body,
      );

      // expect
      expect(
        serviceProviderServiceMock.deleteServiceProviderByKey,
      ).toHaveBeenCalledWith({ key });
      expect(
        serviceProviderServiceMock.deleteServiceProviderByKey,
      ).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider`,
      );
    });

    it('Should not redirect the user but set the res status to 500 for the error handler', async () => {
      // set up
      const key = 'key';
      const body = { name: 'name' };

      // action
      serviceProviderServiceMock.deleteServiceProviderByKey.mockRejectedValueOnce(
        new Error('Try again buddy'),
      );
      await serviceProviderController.deleteServiceProvider(
        key,
        req,
        res,
        body,
      );
      // expect
      expect(
        serviceProviderServiceMock.deleteServiceProviderByKey,
      ).toHaveBeenCalledWith({ key });
      expect(
        serviceProviderServiceMock.deleteServiceProviderByKey,
      ).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith('globalError', 'Try again buddy');
      expect(res.status).toHaveBeenCalledWith(500);
      expect(res.redirect).toHaveBeenCalledTimes(0);
    });
  });

  describe('Delete several service provider', () => {
    it('Should redirect after remove several servide provider', async () => {
      // set up
      const deleteServiceProviderDto = {
        deleteItems: ['aaaa', 'bbbb', 'cccc'],
        name: 'aaa, bbb, ccc',
      };

      const expectedResultSentToService = [
        { key: 'aaaa' },
        { key: 'bbbb' },
        { key: 'cccc' },
      ];

      // action
      serviceProviderServiceMock.deleteServiceProviderByKey.mockReturnValueOnce(
        {},
      );
      await serviceProviderController.deleteServiceProviders(
        deleteServiceProviderDto,
        res,
        req,
      );

      // expect
      expect(
        serviceProviderServiceMock.deleteServiceProviderByKey,
      ).toHaveBeenCalledWith(expectedResultSentToService);
      expect(
        serviceProviderServiceMock.deleteServiceProviderByKey,
      ).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider`,
      );
    });

    it('Should not redirect the user but set the res status to 500 for error handler', async () => {
      // set up
      const deleteServiceProviderDto = {
        deleteItems: ['aaaa', 'bbbb'],
        name: 'aaa, bbb',
      };

      const expectedResultSentToService = [{ key: 'aaaa' }, { key: 'bbbb' }];

      // action
      serviceProviderServiceMock.deleteServiceProviderByKey.mockRejectedValueOnce(
        new Error('Try again buddy'),
      );
      await serviceProviderController.deleteServiceProviders(
        deleteServiceProviderDto,
        res,
        req,
      );

      // expect
      expect(
        serviceProviderServiceMock.deleteServiceProviderByKey,
      ).toHaveBeenCalledWith(expectedResultSentToService);
      expect(
        serviceProviderServiceMock.deleteServiceProviderByKey,
      ).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith('globalError', 'Try again buddy');
      expect(res.status).toHaveBeenCalledWith(500);
      expect(res.redirect).toHaveBeenCalledTimes(0);
    });
  });

  describe('GenerateNewSecret View', () => {
    it('should get a service Provider and render generate client secret view', async () => {
      const serviceProvider = {
        IPServerAddressesAndRanges: ['1.1.1.1'],
        active: 'true',
        email: ['v@b.com'],
        emails: 'v@b.com',
        ipsRanges: '1.1.1.1',
        key: 'cb55015c-7fb5-49b4-9006-e523552bc3e7',
        name: 'FranceConnect TEST 9',
        postLogoutUri: 'https://FranceConnect.com',
        post_logout_redirect_uris: ['https://FranceConnect.com'],
        redirectUri: 'https://FranceConnect.com',
        redirect_uris: ['https://FranceConnect.com'],
        site: 'https://FranceConnect8888.com',
        status: 'public',
        scopes: [...scopeList],
        trustedIdentity: false,
        eidas: 1,
      };

      serviceProviderServiceMock.findById.mockResolvedValue(serviceProvider);

      const result = await serviceProviderController.findOne(idParam, req);
      expect(req.flash).toHaveBeenCalledTimes(1);
      expect(req.flash).toHaveBeenCalledWith('values', {
        ...serviceProvider,
      });
      expect(result).toEqual({
        id: idParam,
        csrfToken: 'mygreatcsrftoken',
        AlgoName,
        AlgoValue,
      });
    });
  });

  describe('Generate a new client secret', () => {
    it('Should redirect after generation of a client secret', async () => {
      // set up
      const serviceProvider = {
        IPServerAddressesAndRanges: ['1.1.1.1'],
        active: 'true',
        email: ['v@b.com'],
        emails: 'v@b.com',
        ipsRanges: '1.1.1.1',
        key: 'cb55015c-7fb5-49b4-9006-e523552bc3e7',
        name: 'FranceConnect TEST 9',
        postLogoutUri: 'https://FranceConnect.com',
        post_logout_redirect_uris: ['https://FranceConnect.com'],
        redirectUri: 'https://FranceConnect.com',
        redirect_uris: ['https://FranceConnect.com'],
        site: 'https://FranceConnect8888.com',
        status: 'public',
        client_secret:
          '$2b$10$EO3FnI3YKfnnvUlvr084wegEgEPeRPRMdE2VJwMHpAsNkaMv1n9pG',
        scopes: [...scopeList],
        trustedIdentity: false,
        eidas: 1,
      };
      const generateNewClientSecretDTO = {
        name: 'aaa, bbb, ccc',
        key: 'clientID',
        client_secret: 'ancien secret hash',
      };

      const key = 'key';

      // action
      serviceProviderServiceMock.generateNewSecret.mockReturnValueOnce(
        serviceProvider,
      );
      await serviceProviderController.generateNewClientSecret(
        key,
        generateNewClientSecretDTO,
        req,
        res,
      );

      // expect
      expect(
        serviceProviderServiceMock.generateNewSecret,
      ).toHaveBeenCalledTimes(1);
      expect(res.redirect).toHaveBeenCalledWith(
        `${res.locals.APP_ROOT}/service-provider`,
      );
    });

    it('Should redirect after generation of a client secret', async () => {
      // set up
      const generateNewClientSecretDTO = {
        name: 'aaa, bbb, ccc',
        key: 'clientID',
        client_secret: 'ancien secret hash',
      };

      const key = 'key';

      // action
      serviceProviderServiceMock.generateNewSecret.mockRejectedValueOnce(
        new Error(),
      );

      await serviceProviderController.generateNewClientSecret(
        key,
        generateNewClientSecretDTO,
        req,
        res,
      );

      // expect
      expect(
        serviceProviderServiceMock.generateNewSecret,
      ).toHaveBeenCalledTimes(1);
      expect(res.status).toHaveBeenCalledWith(500);
      expect(res.redirect).toHaveBeenCalledTimes(0);
    });
  });

  describe('GET: paginate[mongodb] serviceProvider (list) ', () => {
    it('should return a list of service providers even with sort/action as undefined values', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const sort = undefined;
      const action = undefined;

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      // Mocking Items
      const itemTest1: ServiceProvider = {
        id: itemId,
        name: 'Site Usagers',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date('2019-11-08T09:52:29.984Z'),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      const itemTest2: ServiceProvider = {
        id: itemId,
        name: 'Site Usagers',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date('2019-11-08T09:52:29.984Z'),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      // Mocking return value of serviceProviderController.list(page, limit)
      const serviceProvidersResult = {
        items: [itemTest1, itemTest2],
        itemCount: 2,
        totalItems: 2,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function

      serviceProviderServiceMock.paginate.mockResolvedValueOnce(
        serviceProvidersResult,
      );
      // Calling the list function
      const resultat = await serviceProviderController.list(
        req,
        sort,
        action,
        page,
        limit,
      );

      // Expected
      expect(resultat.serviceProviders.length).toEqual(2);
      expect(resultat.serviceProviders).toEqual([
        {
          id: itemId,
          name: 'Site Usagers',
          signup_id: '123456',
          redirect_uris: ['https://url.com'],
          post_logout_redirect_uris: [''],
          site: ['https://monsite.com'],
          email: 'v@b.com',
          IPServerAddressesAndRanges: ['192.0.0.0'],
          logo: 'logo.png',
          active: true,
          type: 'public',
          secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
          client_secret: '76eded44d32b40c0cb1006065',
          key:
            '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
          createdAt: new Date('2019-11-08T09:52:29.984Z'),
          scopes: [...scopeList],
          identityConsent: false,
          trustedIdentity: false,
          eidas: 1,
        },
        {
          id: itemId,
          name: 'Site Usagers',
          signup_id: '123456',
          redirect_uris: ['https://url.com'],
          post_logout_redirect_uris: [''],
          site: ['https://monsite.com'],
          email: 'v@b.com',
          IPServerAddressesAndRanges: ['192.0.0.0'],
          logo: 'logo.png',
          active: true,
          type: 'public',
          secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
          client_secret: '76eded44d32b40c0cb1006065',
          key:
            '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
          createdAt: new Date('2019-11-08T09:52:29.984Z'),
          scopes: [...scopeList],
          identityConsent: false,
          trustedIdentity: false,
          eidas: 1,
        },
      ]);
    });

    it('should return a list sort alphabetically of service providers if sort="name" and action="asc"', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const sort = 'name';
      const action = 'asc';

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      // Mocking Items
      const itemTest1: ServiceProvider = {
        id: itemId,
        name: 'Batman',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date('2019-11-08T09:52:29.984Z'),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      const itemTest2: ServiceProvider = {
        id: itemId,
        name: 'joker',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date('2019-11-08T09:52:29.984Z'),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      // Mocking return value of serviceProviderController.list(page, limit)
      const serviceProvidersResult = {
        items: [itemTest1, itemTest2],
        itemCount: 2,
        totalItems: 2,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function

      serviceProviderServiceMock.paginate.mockResolvedValueOnce(
        serviceProvidersResult,
      );
      // Calling the list function
      const resultat = await serviceProviderController.list(
        req,
        sort,
        action,
        page,
        limit,
      );

      // Expected
      expect(resultat.serviceProviders.length).toEqual(2);
      expect(resultat.serviceProviders).toEqual([
        {
          id: itemId,
          name: 'Batman',
          signup_id: '123456',
          redirect_uris: ['https://url.com'],
          post_logout_redirect_uris: [''],
          site: ['https://monsite.com'],
          email: 'v@b.com',
          IPServerAddressesAndRanges: ['192.0.0.0'],
          logo: 'logo.png',
          active: true,
          type: 'public',
          secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
          client_secret: '76eded44d32b40c0cb1006065',
          key:
            '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
          createdAt: new Date('2019-11-08T09:52:29.984Z'),
          scopes: [...scopeList],
          identityConsent: false,
          trustedIdentity: false,
          eidas: 1,
        },
        {
          id: itemId,
          name: 'joker',
          signup_id: '123456',
          redirect_uris: ['https://url.com'],
          post_logout_redirect_uris: [''],
          site: ['https://monsite.com'],
          email: 'v@b.com',
          IPServerAddressesAndRanges: ['192.0.0.0'],
          logo: 'logo.png',
          active: true,
          type: 'public',
          secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
          client_secret: '76eded44d32b40c0cb1006065',
          key:
            '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
          createdAt: new Date('2019-11-08T09:52:29.984Z'),
          scopes: [...scopeList],
          identityConsent: false,
          trustedIdentity: false,
          eidas: 1,
        },
      ]);
    });

    it('should return a list sort alphabetically of service providers if sort="name" and action="desc"', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const sort = 'name';
      const action = 'desc';

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      // Mocking Items
      const itemTest1: ServiceProvider = {
        id: itemId,
        name: 'joker',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date('2019-11-08T09:52:29.984Z'),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      const itemTest2: ServiceProvider = {
        id: itemId,
        name: 'Batman',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date('2019-11-08T09:52:29.984Z'),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      // Mocking return value of serviceProviderController.list(page, limit)
      const serviceProvidersResult = {
        items: [itemTest1, itemTest2],
        itemCount: 2,
        totalItems: 2,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function

      serviceProviderServiceMock.paginate.mockResolvedValueOnce(
        serviceProvidersResult,
      );
      // Calling the list function
      const resultat = await serviceProviderController.list(
        req,
        sort,
        action,
        page,
        limit,
      );

      // Expected
      expect(resultat.serviceProviders.length).toEqual(2);
      expect(resultat.serviceProviders).toEqual([
        {
          id: itemId,
          name: 'joker',
          signup_id: '123456',
          redirect_uris: ['https://url.com'],
          post_logout_redirect_uris: [''],
          site: ['https://monsite.com'],
          email: 'v@b.com',
          IPServerAddressesAndRanges: ['192.0.0.0'],
          logo: 'logo.png',
          active: true,
          type: 'public',
          secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
          client_secret: '76eded44d32b40c0cb1006065',
          key:
            '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
          createdAt: new Date('2019-11-08T09:52:29.984Z'),
          scopes: [...scopeList],
          identityConsent: false,
          trustedIdentity: false,
          eidas: 1,
        },
        {
          id: itemId,
          name: 'Batman',
          signup_id: '123456',
          redirect_uris: ['https://url.com'],
          post_logout_redirect_uris: [''],
          site: ['https://monsite.com'],
          email: 'v@b.com',
          IPServerAddressesAndRanges: ['192.0.0.0'],
          logo: 'logo.png',
          active: true,
          type: 'public',
          secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
          client_secret: '76eded44d32b40c0cb1006065',
          key:
            '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
          createdAt: new Date('2019-11-08T09:52:29.984Z'),
          scopes: [...scopeList],
          identityConsent: false,
          trustedIdentity: false,
          eidas: 1,
        },
      ]);
    });

    it('should return a list sort (active value) of service providers if sort="active" and action="desc"', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const sort = 'name';
      const action = 'desc';

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      // Mocking Items
      const itemTest1: ServiceProvider = {
        id: itemId,
        name: 'joker',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date('2019-11-08T09:52:29.984Z'),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      const itemTest2: ServiceProvider = {
        id: itemId,
        name: 'Batman',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: false,
        type: 'public',
        secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date('2019-11-08T09:52:29.984Z'),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      // Mocking return value of serviceProviderController.list(page, limit)
      const serviceProvidersResult = {
        items: [itemTest1, itemTest2],
        itemCount: 2,
        totalItems: 2,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function

      serviceProviderServiceMock.paginate.mockResolvedValueOnce(
        serviceProvidersResult,
      );
      // Calling the list function
      const resultat = await serviceProviderController.list(
        req,
        sort,
        action,
        page,
        limit,
      );

      // Expected
      expect(resultat.serviceProviders.length).toEqual(2);
      expect(resultat.serviceProviders).toEqual([
        {
          id: itemId,
          name: 'joker',
          signup_id: '123456',
          redirect_uris: ['https://url.com'],
          post_logout_redirect_uris: [''],
          site: ['https://monsite.com'],
          email: 'v@b.com',
          IPServerAddressesAndRanges: ['192.0.0.0'],
          logo: 'logo.png',
          active: true,
          type: 'public',
          secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
          client_secret: '76eded44d32b40c0cb1006065',
          key:
            '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
          createdAt: new Date('2019-11-08T09:52:29.984Z'),
          scopes: [...scopeList],
          identityConsent: false,
          trustedIdentity: false,
          eidas: 1,
        },
        {
          id: itemId,
          name: 'Batman',
          signup_id: '123456',
          redirect_uris: ['https://url.com'],
          post_logout_redirect_uris: [''],
          site: ['https://monsite.com'],
          email: 'v@b.com',
          IPServerAddressesAndRanges: ['192.0.0.0'],
          logo: 'logo.png',
          active: false,
          type: 'public',
          secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
          client_secret: '76eded44d32b40c0cb1006065',
          key:
            '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
          createdAt: new Date('2019-11-08T09:52:29.984Z'),
          scopes: [...scopeList],
          identityConsent: false,
          trustedIdentity: false,
          eidas: 1,
        },
      ]);
    });

    it('should return a list sort (active value) of service providers if sort="active" and action="asc"', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const sort = 'name';
      const action = 'desc';

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      // Mocking Items
      const itemTest1: ServiceProvider = {
        id: itemId,
        name: 'joker',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date('2019-11-08T09:52:29.984Z'),
        scopes: [
          'openid',
          'given_name',
          'family_name',
          'bithdate',
          'gender',
          'birthplace',
          'birthcountry',
          'email',
          'dgfip_rfr',
          'dgfip_nbpart',
          'dgfip_sitfam',
          'dgfip_pac',
          'dgfip_aft',
        ],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      const itemTest2: ServiceProvider = {
        id: itemId,
        name: 'Batman',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: false,
        type: 'public',
        secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date('2019-11-08T09:52:29.984Z'),
        scopes: [
          'openid',
          'given_name',
          'family_name',
          'bithdate',
          'gender',
          'birthplace',
          'birthcountry',
          'email',
          'dgfip_rfr',
          'dgfip_nbpart',
          'dgfip_sitfam',
          'dgfip_pac',
          'dgfip_aft',
        ],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      // Mocking return value of serviceProviderController.list(page, limit)
      const serviceProvidersResult = {
        items: [itemTest1, itemTest2],
        itemCount: 2,
        totalItems: 2,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function

      serviceProviderServiceMock.paginate.mockResolvedValueOnce(
        serviceProvidersResult,
      );
      // Calling the list function
      const resultat = await serviceProviderController.list(
        req,
        sort,
        action,
        page,
        limit,
      );

      // Expected
      expect(resultat.serviceProviders.length).toEqual(2);
      expect(resultat.serviceProviders).toEqual([
        {
          id: itemId,
          name: 'joker',
          signup_id: '123456',
          redirect_uris: ['https://url.com'],
          post_logout_redirect_uris: [''],
          site: ['https://monsite.com'],
          email: 'v@b.com',
          IPServerAddressesAndRanges: ['192.0.0.0'],
          logo: 'logo.png',
          active: true,
          type: 'public',
          secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
          client_secret: '76eded44d32b40c0cb1006065',
          key:
            '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
          createdAt: new Date('2019-11-08T09:52:29.984Z'),
          scopes: [...scopeList],
          identityConsent: false,
          trustedIdentity: false,
          eidas: 1,
        },
        {
          id: itemId,
          name: 'Batman',
          signup_id: '123456',
          redirect_uris: ['https://url.com'],
          post_logout_redirect_uris: [''],
          site: ['https://monsite.com'],
          email: 'v@b.com',
          IPServerAddressesAndRanges: ['192.0.0.0'],
          logo: 'logo.png',
          active: false,
          type: 'public',
          secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
          client_secret: '76eded44d32b40c0cb1006065',
          key:
            '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
          createdAt: new Date('2019-11-08T09:52:29.984Z'),
          scopes: [...scopeList],
          identityConsent: false,
          trustedIdentity: false,
          eidas: 1,
        },
      ]);
    });

    it('should return a list sort (by name) of service providers if search="joker"', async () => {
      // Setup
      const page = '0';
      const limit = '10';
      const sort = 'name';
      const action = 'desc';
      const search = 'joker';

      // Mocking item id
      const itemId: ObjectID = new ObjectID('5d35b91e70332098440d0f85');

      // Mocking Items
      const itemTest1: ServiceProvider = {
        id: itemId,
        name: 'joker',
        signup_id: '123456',
        redirect_uris: ['https://url.com'],
        post_logout_redirect_uris: [''],
        site: ['https://monsite.com'],
        email: 'v@b.com',
        IPServerAddressesAndRanges: ['192.0.0.0'],
        logo: 'logo.png',
        active: true,
        type: 'public',
        secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
        client_secret: '76eded44d32b40c0cb1006065',
        key: '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
        createdAt: new Date('2019-11-08T09:52:29.984Z'),
        scopes: [...scopeList],
        identityConsent: false,
        trustedIdentity: false,
        eidas: 1,
      };

      // Mocking return value of serviceProviderController.list(page, limit)
      const serviceProvidersResult = {
        items: [itemTest1],
        itemCount: 2,
        totalItems: 2,
        pageCount: 0,
        next: '',
        previous: '',
      };

      // Actions
      // Mocking the return of the paginate function

      serviceProviderServiceMock.paginate.mockResolvedValueOnce(
        serviceProvidersResult,
      );
      // Calling the list function
      const resultat = await serviceProviderController.list(
        req,
        search,
        sort,
        action,
        page,
        limit,
      );

      // Expected
      expect(resultat.serviceProviders.length).toEqual(1);
      expect(resultat.serviceProviders).toEqual([
        {
          id: itemId,
          name: 'joker',
          signup_id: '123456',
          redirect_uris: ['https://url.com'],
          post_logout_redirect_uris: [''],
          site: ['https://monsite.com'],
          email: 'v@b.com',
          IPServerAddressesAndRanges: ['192.0.0.0'],
          logo: 'logo.png',
          active: true,
          type: 'public',
          secretCreatedAt: new Date('2019-11-08T09:52:29.984Z'),
          client_secret: '76eded44d32b40c0cb1006065',
          key:
            '6925fb8143c76eded44d32b40c0cb1006065f7f003de52712b78985704f39950',
          createdAt: new Date('2019-11-08T09:52:29.984Z'),
          scopes: [...scopeList],
          identityConsent: false,
          trustedIdentity: false,
          eidas: 1,
        },
      ]);
    });
  });
});
