import { Test } from '@nestjs/testing';
import { ServiceProviderController } from './service-provider.controller';
import { getRepositoryToken, TypeOrmModule } from '@nestjs/typeorm';
import { ServiceProvider } from './service-provider.entity';
import { ServiceProviderService } from './service-provider.service';

describe('ServiceProviderController', () => {
  let serviceProviderController: ServiceProviderController;

  const serviceProviderRepository = {
    count: jest.fn(),
    find: jest.fn(),
  };

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      imports: [TypeOrmModule.forFeature([ServiceProvider], 'fc-mongo')],
      providers: [ServiceProviderController, ServiceProviderService],
    })
      .overrideProvider(getRepositoryToken(ServiceProvider, 'fc-mongo'))
      .useValue(serviceProviderRepository)
      .compile();
    serviceProviderController = await module.get<ServiceProviderController>(
      ServiceProviderController,
    );
    jest.resetAllMocks();
  });

  describe('list method', () => {
    it('returns the list of the available service providers', async () => {
      const mockedServiceProviders = [
        'La barbe',
        'de la femme',
        'Ã  Georges Moustaki',
      ];
      serviceProviderRepository.find.mockResolvedValueOnce(
        mockedServiceProviders,
      );

      const { serviceProviders } = await serviceProviderController.list();

      expect(serviceProviders).toEqual(mockedServiceProviders);
    });

    it('returns the count of active service providers', async () => {
      const mockedCount = 10;
      serviceProviderRepository.count.mockResolvedValueOnce(mockedCount);

      const {
        activeServiceProvidersCount,
      } = await serviceProviderController.list();

      expect(activeServiceProvidersCount).toBe(mockedCount);
      expect(serviceProviderRepository.count).toHaveBeenCalledWith({
        active: true,
      });
    });
  });
});
