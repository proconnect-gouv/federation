import { Repository } from 'typeorm';

import { Controller, Get, Render, Req, Query } from '@nestjs/common';
import { InjectRepository } from '@nestjs/typeorm';
import { UserRole } from '@fc/shared/user/roles.enum';
import { Roles } from '@fc/shared/authentication/decorator/roles.decorator';
import { DataProvider } from './data-provider.mongodb.entity';

import { DataProviderService } from './data-provider.service';
// import { DataProviderDto } from './dto/data-provider-input.dto';
// import { DeleteDataProviderDto } from './dto/delete-data-provider.dto';
// import { GenerateNewClientSecretDTO } from './dto/generate-new-client-secret.dto';

@Controller('data-provider')
export class DataProviderController {
  constructor(
    @InjectRepository(DataProvider, 'fc-mongo')
    private readonly dataProviderRepository: Repository<DataProvider>,
    private readonly dataProviderService: DataProviderService,
  ) {}

  /**
   *
   * @param req
   * @param search
   * @param sort
   * @param action
   * @param pageQuery
   * @param limitQuery
   */
  @Get()
  @Roles(UserRole.OPERATOR, UserRole.SECURITY)
  @Render('data-provider/list')
  async list(
    @Req() req,
    @Query('search') search: string,
    @Query('sort') sort: string,
    @Query('action') action: string,
    @Query('page') pageQuery: string = '1',
    @Query('limit') limitQuery: string = '10',
  ): Promise<{
    dataProviders: DataProvider[];
    total: number;
    activeDataProvidersCount: number;
    csrfToken: string;
    page: number;
    limit: number;
    sort: string;
    action: string;
    userSearch: string;
  }> {
    const activeDataProvidersCount = await this.dataProviderRepository.count({
      active: true,
    });

    const page = parseInt(pageQuery, 10);
    const limit = parseInt(limitQuery, 10);
    const csrfToken = req.csrfToken();
    const userSearch = search;

    const dataProviders = await this.dataProviderService.paginate({
      page,
      limit,
      route: '/data-provider',
      sort,
      action,
      defaultLimit: 10,
      userSearch,
    });
    return {
      dataProviders: dataProviders.items,
      total: dataProviders.total,
      activeDataProvidersCount,
      csrfToken,
      page,
      limit,
      sort,
      action,
      userSearch,
    };
  }

  // /**
  //  * Fournit le formulaire de création d'un fournisseur de données.
  //  *
  //  * @param {ParameterDecorator} req
  //  * @return {string} crsf token
  //  */
  // @Get('create')
  // @Render('data-provider/creation')
  // @Roles(UserRole.OPERATOR)
  // async showCreationForm(@Req() req) {
  //   const csrfToken = req.csrfToken();
  //   const scopesGroupedByFd = await this.scopesService.getScopesGroupedByFd();

  //   const response = {
  //     csrfToken,
  //     scopesGroupedByFd,
  //   };

  //   return response;
  // }

  // /**
  //  * Récupère les données du formulaire de création d'un fournisseur de données
  //  * @param createDataProviderDto
  //  * @param req
  //  * @param res
  //  */
  // @Post('create')
  // @Roles(UserRole.OPERATOR)
  // @UseInterceptors(new FormErrorsInterceptor(`/data-provider/create`))
  // @UsePipes(new ValidationPipe({ transform: true, whitelist: true }))
  // async createDataProvider(
  //   @Body() createDataProviderDto: DataProviderDto,
  //   @Req() req,
  //   @Res() res,
  // ) {
  //   try {
  //     const dataProvider: IDataProvider = createDataProviderDto as IDataProvider;

  //     await this.dataProviderService.createDataProvider(
  //       dataProvider,
  //       req.user.username,
  //     );
  //   } catch (error) {
  //     req.flash(
  //       'globalError',
  //       "Impossible d'enregistrer le fournisseur de données",
  //     );
  //     req.flash('values', createDataProviderDto);

  //     return res.redirect(`${res.locals.APP_ROOT}/data-provider/create`);
  //   }
  //   req.flash(
  //     'success',
  //     `Le fournisseur de données ${createDataProviderDto.name} a été créé avec succès !`,
  //   );

  //   return res.redirect(`${res.locals.APP_ROOT}/`);
  // }

  // /**
  //  *  Permet d'afficher la page d'un data-provider à modifier
  //  * @param id
  //  * @param req
  //  * @param res
  //  */
  // @Get(':id')
  // @Roles(UserRole.OPERATOR)
  // @Render('data-provider/update')
  // async findOne(@Param('id') id, @Req() req) {
  //   const csrfToken = req.csrfToken();

  //   const dataProvider = await this.dataProviderService.findById(id);
  //   const output = {
  //     ...dataProvider,
  //     jwksUri: dataProvider.jwks_uri,
  //     redirectUri: this.AddCarriageReturn(dataProvider.redirect_uris),
  //     site: this.AddCarriageReturn(dataProvider.site),
  //     ipsRanges: this.AddCarriageReturn(
  //       dataProvider.IPServerAddressesAndRanges,
  //     ),
  //     postLogoutUri: this.AddCarriageReturn(
  //       dataProvider.post_logout_redirect_uris,
  //     ),
  //     emails: Array.isArray(dataProvider.email)
  //       ? this.AddCarriageReturn(dataProvider.email)
  //       : this.formatEmailFields(dataProvider.email),
  //   };

  //   /**
  //    * We want to send to the view all the fields that the user
  //    * has updated if there was an error plus all the fields
  //    * that were not updated.
  //    */
  //   if (req.session.flash && req.session.flash.errors) {
  //     Object.assign(req.session.flash.values[0], output);
  //   } else {
  //     req.flash('values', output);
  //   }

  //   const scopesSelected: string[] = dataProvider.scopes || [];
  //   const scopesGroupedByFd = await this.scopesService.getScopesGroupedByFd();

  //   const claimsSelected: string[] = dataProvider.claims || ['amr'];
  //   const claims: Claims[] = await this.claimsService.getAll();

  //   const response = {
  //     csrfToken,
  //     id,
  //     claimsSelected,
  //     claims,
  //     scopesGroupedByFd,
  //     scopesSelected,
  //   };

  //   return response;
  // }

  // /**
  //  *
  //  * @param dataProviderUpdate
  //  * @param id
  //  * @param req
  //  * @param res
  //  */
  // @Patch(':id')
  // @Roles(UserRole.OPERATOR)
  // @UseInterceptors(new FormErrorsInterceptor(`/data-provider/:id`))
  // @UsePipes(new ValidationPipe({ transform: true, whitelist: true }))
  // async dataProviderUpdate(
  //   @Body() dataProviderUpdate: DataProviderDto,
  //   @Param('id') id,
  //   @Req() req,
  //   @Res() res,
  // ) {
  //   try {
  //     await this.dataProviderService.update(
  //       id,
  //       dataProviderUpdate,
  //       req.user.username,
  //     );
  //   } catch (error) {
  //     req.flash('globalError', 'Impossible de mettre à jour le FS');
  //     return res.redirect(`${res.locals.APP_ROOT}/data-provider/${id}`);
  //   }
  //   req.flash(
  //     'success',
  //     `Le fournisseur de données ${dataProviderUpdate.name} a été modifié avec succès !`,
  //   );

  //   return res.redirect(`${res.locals.APP_ROOT}/data-provider/${id}`);
  // }

  // /**
  //  *
  //  * @param key
  //  * @param req
  //  * @param res
  //  * @param body
  //  */
  // @Delete(':id')
  // @Roles(UserRole.OPERATOR)
  // @UseInterceptors(new FormErrorsInterceptor('/data-provider'))
  // async deleteDataProvider(
  //   @Param('id') id: string,
  //   @Req() req,
  //   @Res() res,
  //   @Body() body,
  // ) {
  //   try {
  //     await this.dataProviderService.deleteDataProviderById(
  //       id,
  //       req.user.username,
  //     );
  //   } catch (error) {
  //     req.flash('globalError', error.message);
  //     return res.status(500);
  //   }
  //   req.flash(
  //     'success',
  //     `Le fournisseur de données ${body.name} a été supprimé avec succès !`,
  //   );
  //   return res.redirect(`${res.locals.APP_ROOT}/data-provider`);
  // }

  // /**
  //  *
  //  * @param deleteDataProviderDto
  //  * @param res
  //  * @param req
  //  */
  // @Post('delete')
  // @Roles(UserRole.OPERATOR)
  // @UsePipes(new ValidationPipe({ transform: true }))
  // @UseInterceptors(new FormErrorsInterceptor('/data-provider'))
  // async deleteDataProviders(
  //   @Body() body: DeleteDataProviderDto,
  //   @Res() res,
  //   @Req() req,
  // ) {
  //   const { deleteItems = [], name } = body;
  //   try {
  //     await this.dataProviderService.deleteManyDataProvidersById(
  //       deleteItems,
  //       req.user.username,
  //     );
  //   } catch (error) {
  //     req.flash('globalError', error.message);
  //     return res.status(500);
  //   }
  //   req.flash(
  //     'success',
  //     `Les fournisseurs de données ${name} ont été supprimés avec succès !`,
  //   );
  //   return res.redirect(`${res.locals.APP_ROOT}/data-provider`);
  // }

  // /**
  //  *
  //  * @param id
  //  * @param req
  //  * @param res
  //  */
  // @Get('update/:id/secret')
  // @Roles(UserRole.OPERATOR)
  // @Render('data-provider/generate-new-client-secret')
  // async generateNewSecret(@Param('id') id: string, @Req() req, @Res() res) {
  //   const csrfToken = req.csrfToken();

  //   /**
  //    * If we have an error to flash, we want to render the last user inputs,
  //    * not the data-provider in database.
  //    */
  //   if (req.session.flash && req.session.flash.errors) {
  //     return {
  //       csrfToken,
  //       id,
  //     };
  //   }

  //   const dataProvider = await this.dataProviderService.findById(id);
  //   return {
  //     csrfToken,
  //     id,
  //     messages: {
  //       values: [dataProvider],
  //     },
  //   };
  // }

  // /**
  //  *
  //  * @param id
  //  * @param generateNewClientSecretDTO
  //  * @param req
  //  * @param res
  //  */
  // @Patch('update/:id/secret')
  // @Roles(UserRole.OPERATOR)
  // @UseInterceptors(
  //   new FormErrorsInterceptor('/data-provider/update/:id/secret'),
  // )
  // async generateNewClientSecret(
  //   @Param('id') id: string,
  //   @Body() generateNewClientSecretDTO: GenerateNewClientSecretDTO,
  //   @Req() req,
  //   @Res() res,
  // ) {
  //   try {
  //     await this.dataProviderService.generateNewSecret(
  //       id,
  //       req.user.username,
  //     );
  //   } catch (error) {
  //     req.flash('gobalError', error);
  //     return res.status(500);
  //   }

  //   req.flash(
  //     'success',
  //     `Le nouveau client secret du fournisseur de données ${generateNewClientSecretDTO.name} a été généré avec succés !`,
  //   );

  //   return res.redirect(`${res.locals.APP_ROOT}/data-provider`);
  // }

  // private AddCarriageReturn(input: string[]) {
  //   if (Array.isArray(input)) {
  //     return input.join('\r\n');
  //   }
  //   return input;
  // }

  // private formatEmailFields(emails: string): string {
  //   if (typeof emails !== 'string') {
  //     return '';
  //   }
  //   return emails.replace(/,/g, '\r\n');
  // }
}
