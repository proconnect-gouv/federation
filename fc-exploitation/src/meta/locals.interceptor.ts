import {Injectable, NestInterceptor, ExecutionContext, CallHandler} from "@nestjs/common";
import {Observable} from "rxjs";
import {GitService} from "shared/meta/git.service";
import {ConfigService} from "nestjs-config";

@Injectable()
export class LocalsInterceptor implements NestInterceptor {
    constructor(
        private readonly gitService: GitService,
        private readonly configService: ConfigService,
    ) {}

    async intercept(context: ExecutionContext, next: CallHandler): Promise<Observable<any>> {
        const req = context.switchToHttp().getRequest();
        const res = context.switchToHttp().getResponse();

        const appConfig = this.configService.get('app');

        res.locals.APP_ENVIRONMENT = appConfig.environment;
        res.locals.COMMIT_URL_PREFIX = appConfig.commitUrlPrefix;

        res.locals.GIT_CURRENT_BRANCH = await this.gitService.getCurrentBranch();
        res.locals.GIT_LATEST_COMMIT_SHORT_HASH = await this.gitService.getLatestCommitShortHash();
        res.locals.GIT_LATEST_COMMIT_LONG_HASH = await this.gitService.getLatestCommitLongHash();

        res.locals.CURRENT_USER = req.user;

        return next.handle();
    }
}
