import {
  Injectable,
  NestInterceptor,
  ExecutionContext,
  CallHandler,
} from '@nestjs/common';
import { Observable } from 'rxjs';
import { ConfigService } from 'nestjs-config';
import * as moment from 'moment';
import * as queryString from 'query-string';
import { errorCodeTranslations } from './error-code-translations';
import { UserRole } from '@fc/shared/user/roles.enum';
import { VALID_INPUT_STRING_REGEX } from '@fc/shared/validators/is-valid-input-string';
import { IP_VALIDATOR_REGEX } from '@fc/exploitation/src/utils/ip-validator.constant';

@Injectable()
export class LocalsInterceptor implements NestInterceptor {
  constructor(private readonly configService: ConfigService) {}

  async intercept(
    context: ExecutionContext,
    next: CallHandler,
  ): Promise<Observable<any>> {
    const req = context.switchToHttp().getRequest();
    const res = context.switchToHttp().getResponse();

    const appConfig = this.configService.get('app');

    res.locals.helpers = {};

    res.locals.APP_ROOT = appConfig.app_root;

    res.locals.APP_ENVIRONMENT = appConfig.environment;

    res.locals.IS_PRODUCTION = appConfig.isProduction;

    res.locals.APP_VERSION = appConfig.appVersion;

    res.locals.COMMIT_URL_PREFIX = appConfig.commitUrlPrefix;

    res.locals.GIT_CURRENT_BRANCH = appConfig.currentBranch;
    res.locals.GIT_LATEST_COMMIT_SHORT_HASH = appConfig.latestCommitShortHash;
    res.locals.GIT_LATEST_COMMIT_LONG_HASH = appConfig.latestCommitLongHash;

    res.locals.CURRENT_USER = req.user;

    res.locals.REQ_QUERY = req.query;
    res.locals.queryString = queryString;

    res.locals.moment = moment;
    res.locals.title = appConfig.appName;

    res.locals.ERROR_CODE_TRANSLATIONS = errorCodeTranslations;

    res.locals.USER_ROLES_OPTIONS = [
      { label: 'Administrateur', value: UserRole.ADMIN },
      { label: 'Exploitant', value: UserRole.OPERATOR },
      { label: 'Sécurité', value: UserRole.SECURITY },
      { label: 'Nouvel utilisateur', value: UserRole.NEWUSER },
      { label: 'Administrateur inactif', value: UserRole.INACTIVE_ADMIN },
      { label: 'Exploitant inactif', value: UserRole.INACTIVE_OPERATOR },
      { label: 'Sécurité inactif', value: UserRole.INACTIVE_SECURITY },
    ];

    res.locals.SCOPES_LIST = LocalsInterceptor.getSCOPES;
    res.locals.helpers.isFsHaveScope = LocalsInterceptor.isFsHaveScope;

    res.locals.VALID_INPUT_STRING_REGEX = VALID_INPUT_STRING_REGEX.source;
    res.locals.IP_VALIDATOR_REGEX = IP_VALIDATOR_REGEX.source;
    return next.handle();
  }
  static getSCOPES() {
    return [
      'openid',
      'given_name',
      'family_name',
      'preferred_username',
      'birthdate',
      'gender',
      'birthplace',
      'birthcountry',
      'email',
      'address',
      'phone',
      'dgfip_rfr',
      'dgfip_annee_n_moins_1',
      'dgfip_annee_n_moins_2',
      'dgfip_nbpart',
      'dgfip_sitfam',
      'dgfip_aft',
      'dgfip_nbpac',
      'dgfip_inddeficit',
      'dgfip_pariso',
      'dgfip_decl',
      'dgfip_pac',
      'dgfip_locaux_th',
      'ensagri_releve_notes',
      'droits_assurance_maladie',
      'mi_siv_carte_grise',
      'cnam_beneficiaires',
      'cnam_contrats',
      'cnam_caisse',
      'cnam_exonerations',
      'cnam_medecin_traitant',
      'cnam_presence_medecin_traitant',
    ];
  }

  static isFsHaveScope(scopeList, currentScope) {
    const baseScopes = LocalsInterceptor.getSCOPES();
    return scopeList
      .filter(scope => baseScopes.includes(scope))
      .includes(currentScope);
  }
}
