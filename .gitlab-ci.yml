stages:
  - install
  - test
  - e2e
  - Checkmarx
  - Cache
  - Build
  - Tag

variables:
  FC_ROOT: "$CI_BUILDS_DIR/france-connect"
  PROXY_EXPLOITATION: "http://$EXPLOITATION_PROXY_HOST:$EXPLOITATION_PROXY_PORT"
  CYPRESS_CACHE_FOLDER: '$CI_PROJECT_DIR/cache/Cypress'

global-install:
  image: ${FC_DOCKER_REGISTRY}/nodejs:${NODE_VERSION}-dev
  stage: install
  tags:
    - node
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "staging"'
  cache:
    key: '${CACHE_KEY}'
    policy: pull
    paths:
      - node_modules
      - fc-exploitation/node_modules
      - fc-stats/node_modules
      - fc-support/node_modules
      - fc-workers/node_modules
      - shared/node_modules
  script:
    - yarn install
    - yarn lint
    - yarn test --coverage
    - ./node-scripts/coverage.sh
  coverage: '/Global coverage is: \[([\d\.]+)%\]/'
  interruptible: true

build-cache:
  image: ${FC_DOCKER_REGISTRY}/nodejs:${NODE_VERSION}-dev
  tags:
    - node
  cache:
    key: '${CI_PROJECT_ID}'
    policy: push
    paths:
      - node_modules
      - fc-exploitation/node_modules
      - fc-stats/node_modules
      - fc-support/node_modules
      - fc-workers/node_modules
      - shared/node_modules
      # Cypress cache
      - cache/Cypress
  stage: Cache
  script:
    - yarn install
  dependencies: []
  interruptible: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'

include:
  - '/shared/.gitlab-ci.yml'
  - '/fc-exploitation/.gitlab-ci.yml'
  - '/fc-stats/.gitlab-ci.yml'
  - '/fc-workers/.gitlab-ci.yml'
  - '/fc-support/.gitlab-ci.yml'
  - '/.gitlab-build.yml'
  - '/.gitlab-checkmarx.yml'
