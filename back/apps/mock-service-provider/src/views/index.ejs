<!DOCTYPE html>
<html lang="fr">
  <head>
    <%- include('includes/head') %>
    <title><%= locals.titleFront %></title>
  </head>
  <body>
    <%- include('includes/menu') %>
    <section class="welcome">
      <div class="container text-center">
        <h1>Bienvenue sur le démonstrateur de fournisseur de service FCP</h1>
      </div>
    </section>

    <div class="container">
      <br />
      <div class="text-center text-danger">
        Vous devez vous authentifier afin d'accéder à vos données personnelles.
      </div>

      <form id="scopes">
        <h2>Scopes</h2>
        <% locals.params.scope.split(' ').forEach(elem => { %>
          <div class="scope-input-wrapper">
            <input
              id="scope_<%=elem%>"
              type="checkbox"
              name="selected-scope"
              value="<%=elem%>"
              checked
              onChange="updateScope()"
              <%= (elem === 'openid' ? 'disabled' : '') %>
            />
            <label for="scope_<%=elem%>"><%=elem%></label>
          </div>
        <% }) %>

        <h2>Claims</h2>
        <% ['amr'].forEach(elem => { %>
          <div class="claim-input-wrapper">
            <input
              id="claim_<%=elem%>"
              type="checkbox"
              name="selected-claim"
              value="<%=elem%>"
              checked
              onChange="updateClaim()"
            />
            <label for="claim_<%=elem%>"><%=elem%></label>
          </div>
        <% }) %>

        <h2>ACR</h2>
        <select name="acr" id="acrSelector" onChange="updateAcr()">
          <% ['eidas1', 'eidas2', 'eidas3'].forEach(acr => { %>
            <option value="<%=acr%>" <%= (locals.defaultAcrValue && locals.defaultAcrValue === acr) ? "selected" : "" %>><%=acr%></option>
          <% }) %>
        </select>
      </form>

      <section class="connect bg-light">
        <h2>Connectez-vous via FranceConnect (GET sur authorize)</h2>
        <form id="formGET" action="/redirect-to-idp" method="POST">
          <input type="text" name="scope" value="" />
          <input type="text" name="acr_values" value="" />
          <input type="text" name="claims" value="" />
          <input type="text" name="providerUid" value="<%=locals.params.uid%>" />
          <div class="btn no-pad">
            <button
              id="get-authorize"
              type="submit"
              class="btn no-pad hidden-btn"
              role="button"
            ></button>
          </div>
        </form>
      </section>

      <section class="connect bg-light">
        <h2>Connectez-vous via FranceConnect (POST sur authorize)</h2>
        <form id="formPOST" action="<%=locals.params.authorization_endpoint;%>" method="POST">
          <input type="hidden" name="client_id" value="<%=locals.params.client_id;%>" />
          <input type="hidden" name="response_type" value="code" />
          <input type="hidden" name="redirect_uri" value="<%=locals.params.redirect_uri;%>" />
          <input type="hidden" name="state" value="<%=locals.params.state;%>" />
          <input type="hidden" name="nonce" value="<%=locals.params.nonce;%>" />
          <input type="text" name="acr_values" value="" />
          <input type="text" name="claims" value="" />
          <input type="text" name="scope" value="" />
          <div class="btn no-pad">
            <button
              id="post-authorize"
              type="submit"
              class="btn no-pad hidden-btn"
              role="button"
            ></button>
        </div>
        </form>
      </section>
    </div>

    <%- include('includes/footer') %>
    <script>
      function getScopes() {
        const selectedScopes = [];
        document
          .querySelectorAll('input[name="selected-scope"]:checked')
          .forEach((elem) => selectedScopes.push(elem.value));

        return selectedScopes.join(' ');
      }

      function updateScope() {
        const scope = getScopes();
        document
          .querySelectorAll('input[name=scope]')
          .forEach((elem) => (elem.value = scope));
      }

      function transformClaimsToJsonString (claims) {
        const values = claims.reduce((acc, key) => ({ ...acc, [key]: { essential: true }}), {});
        const json = JSON.stringify({ id_token: values });
        return json;
      }

      function getClaims() {
        const selector = 'input[name="selected-claim"]:checked';
        const elements = [...document.querySelectorAll(selector)];
        return elements.map(elem => elem.value);
      }

      function updateClaim() {
        const claims = getClaims();
        const claimsAreValid = claims && claims.length > 0;
        const json = !claimsAreValid ? '' : transformClaimsToJsonString(claims);
        const selector = 'input[name=claims]';
        const elements = document.querySelectorAll(selector);
        elements.forEach((elem) => {
          elem.value = json;
        });
      }

      function updateAcr() {
        const acr = document.getElementById('acrSelector').value;
        document.querySelectorAll('input[name="acr_values"]').forEach((elem) => {
          elem.value = acr;
        });
      }

      updateAcr();
      updateClaim();
      updateScope();
    </script>
  </body>
</html>
