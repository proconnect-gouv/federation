stages:
  - 'UT/Lint/Coverage'
  - 'End to end'
  - 'Checkmarx'
  - 'Cache'
  - 'Review'
  - 'Post-deploy'

variables:
  FC_ROOT: '$CI_BUILDS_DIR/france-connect'
  PROXY_EXPLOITATION: "http://$EXPLOITATION_PROXY_HOST:$EXPLOITATION_PROXY_PORT"
  CYPRESS_CACHE_FOLDER: '$CI_PROJECT_DIR/cache/Cypress'

global:
  image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
  tags:
    - node
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "staging"'
  cache:
    key: '${CI_PROJECT_ID}'
    policy: pull
    paths:
      - back/node_modules/
  stage: 'UT/Lint/Coverage'
  script:
    - cd back/
    - yarn install
    - yarn lint
    - yarn prettier
    - yarn test --coverage
    - ./scripts/coverage.sh
  coverage: '/Global coverage is: \[([\d\.]+)%\]/'
  interruptible: true

quality:
  image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
  tags:
    - node
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" || $CI_COMMIT_BRANCH == "staging"'
  cache:
    key: '${CI_PROJECT_ID}'
    policy: pull
    paths:
      - quality/node_modules/
  stage: 'UT/Lint/Coverage'
  script:
    - cd quality
    - yarn install
    - yarn lint
    - yarn prettier
    - yarn tsc --noEmit
  interruptible: true

build-cache:
  image: gitlab.dev-franceconnect.fr:5005/france-connect/infra/nodejs:${NODE_VERSION}-dev
  tags:
    - node
  cache:
    key: '${CI_PROJECT_ID}'
    policy: push
    paths:
      - back/node_modules/
      - front/node_modules/
      - quality/node_modules/
      - front/apps/agent-connect/node_modules/
      - $CYPRESS_CACHE_FOLDER
  stage: 'Cache'
  script:
    - cd $CI_PROJECT_DIR/back && yarn install
    - cd $CI_PROJECT_DIR/front && yarn install
    - cd $CI_PROJECT_DIR/quality && yarn install
  interruptible: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'

include:
  - '/back/instances/core-fca-low/.gitlab-ci.yml'
  - '/back/instances/core-fca-low/.gitlab-quality.yml'
  - '/back/instances/core-fca-low/.gitlab-deploy.yml'
  - '/back/instances/core-fca-low/.gitlab-post-deploy.yml'
  - '/back/instances/core-fcp-high/.gitlab-ci.yml'
  - '/back/instances/core-fcp-high/.gitlab-quality.yml'
  - '/back/instances/core-fcp-high/.gitlab-deploy.yml'
  - '/back/instances/core-fcp-high/.gitlab-post-deploy.yml'
  - '/back/instances/core-fcp-low/.gitlab-ci.yml'
  - '/back/instances/core-fcp-low/.gitlab-quality.yml'
  - '/back/instances/core-fcp-low/.gitlab-deploy.yml'
  - '/back/instances/eidas-bridge/.gitlab-ci.yml'
  - '/back/.gitlab-checkmarx.yml'
