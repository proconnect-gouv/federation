<!DOCTYPE html>
<html lang="fr">
<head>
    <% include partials/head.ejs %>
</head>
<body>
<div class="container">
    <% include partials/header.ejs %>
    <div class="row">
        <div class="col-12">
            <p class="h2">Stats</p>
            <p><i>Mesure All the things!</i></p>

            <div>
              <form id="search" action="<%= APP_ROOT %>/stats" method="get">
                <div class="form-inline d-flex justify-content-center">
                    <label class="p-1" for="start">Du</label>
                    <input
                      id="start"
                      name="start"
                      type="text"
                      data-init="datePicker"
                      data-secondField="stop"
                      data-form="search"
                      class="form-control mb-1"
                      value="<%= REQ_QUERY.start %>">
                
                    <label class="p-1" for="stop">Au</label>
                    <input
                      id="stop"
                      name="stop"
                      type="text"
                      value="<%= REQ_QUERY.stop %>"
                      class="form-control mb-1"
                    />
                </div>
                <div class="form-inline d-flex justify-content-center">
                  <% if (locals.meta) { %>
                  <!------------------ List des FS --------------------->
                  <div id="fs-dropdown" class="dropdown m-3">
                    <button class="btn btn-secondary dropdown-toggle" 
                      data-init="dropdown" 
                      type="button" id="dropdownMenuButton" 
                      data-toggle="dropdown" 
                      aria-haspopup="true" 
                      aria-expanded="false">
                      Filter par FS
                    </button>

                    <div class="dropdown-menu p-3" aria-labelledby="dropdownMenuButton">
                      <% locals.meta.fsList.forEach(function(fs){ %>
                        <div class="custom-control custom-checkbox my-1 mr-sm-2">
                          <input 
                            class="custom-control-input" 
                            type="checkbox" 
                            id="<%= fs.key %>" 
                            data-init="filters" 
                            value="fs:<%= fs.key %>" 
                            name="filters[]" 
                            data-form="search">
                          <label 
                            class="custom-control-label" 
                            for="<%= fs.key %>"><%= fs.key %></label>
                          <div class="dropdown-divider"></div>
                        </div>
                      <% }) %>
                    </div>
                  </div>

                  <!------------------ List des FI --------------------->
                  <div id="fi-dropdown" class="dropdown m-3">
                    <button class="btn btn-secondary dropdown-toggle" 
                      type="button" 
                      id="dropdownMenuButton" 
                      data-toggle="dropdown" 
                      aria-haspopup="true" 
                      aria-expanded="false">
                      Filter par FI
                    </button>
                    <div class="dropdown-menu p-3" aria-labelledby="dropdownMenuButton">
                      <% locals.meta.fiList.forEach(function(fi){ %>
                        <div class="custom-control custom-checkbox my-1 mr-sm-2">
                          <input 
                            class="custom-control-input" 
                            type="checkbox" 
                            id="<%= fi.key %>" 
                            data-init="filters" 
                            value="fi:<%= fi.key %>" 
                            name="filters[]" 
                            data-form="search">
                          <label 
                            class="custom-control-label" 
                            for="<%= fi.key %>"><%= fi.key %></label>
                          <div class="dropdown-divider"></div>
                        </div>
                      <% }) %>
                    </div>
                  </div>

                  <!------------------ List des Actions --------------------->
                  <div id="action-dropdown" class="dropdown m-3">
                    <button class="btn btn-secondary dropdown-toggle" 
                      type="button" 
                      id="dropdownMenuButton" 
                      data-toggle="dropdown" 
                      aria-haspopup="true" 
                      aria-expanded="false">
                      Filter par Actions
                    </button>
                    <div class="dropdown-menu p-3" aria-labelledby="dropdownMenuButton">
                      <% locals.meta.typeActionList.forEach(function(action){ %>
                        <div class="custom-control custom-checkbox my-1 mr-sm-2">
                          <input 
                            class="custom-control-input" 
                            type="checkbox" 
                            id="<%= action.key %>" 
                            data-init="filters" 
                            value="action:<%= action.key %>" 
                            name="filters[]" 
                            data-form="search">
                          <label 
                            class="custom-control-label" 
                            for="<%= action.key %>"><%= action.key %></label>
                          <div class="dropdown-divider"></div>
                        </div>
                      <% }) %>
                    </div>
                  </div>

                  <!------------------ List des Type d\'actions --------------------->
                  <div id="type-action-dropdown" class="dropdown m-3">
                    <button class="btn btn-secondary dropdown-toggle" 
                      type="button" 
                      id="dropdownMenuButton" 
                      data-toggle="dropdown" 
                      aria-haspopup="true" 
                      aria-expanded="false">
                      Filter par Type Action
                    </button>
                    <div class="dropdown-menu p-3" aria-labelledby="dropdownMenuButton">
                      <% locals.meta.actionList.forEach(function(typeAction){ %>
                        <div class="custom-control custom-checkbox my-1 mr-sm-2">
                          <input 
                            class="custom-control-input" 
                            type="checkbox" 
                            id="<%= typeAction.key %>" 
                            data-init="filters" 
                            value="typeAction:<%= typeAction.key %>" 
                            name="filters[]" 
                            data-form="search">
                          <label 
                            class="custom-control-label" 
                            for="<%= typeAction.key %>"><%= typeAction.key %></label>
                          <div class="dropdown-divider"></div>
                        </div>
                      <% }) %>
                    </div>
                  </div>

                  <div style="float:right">
                    <button type="submit" id="bouton-filtrer" class="btn btn-primary m-1">Filtrer</button>
                    <a class="btn btn-danger m-1" href="<%= APP_ROOT %>/stats" role="button">RÃ©initialiser</a>
                  </div>
                  <% } %>
                </div>
              </form>
            </div>

            <% if (!REQ_QUERY.start || !REQ_QUERY.stop) { %>
            <div class="d-flex justify-content-center">
              <h2>Choisissez des dates</h2>
            </div>
            <% } else { %>
            
              <table class="table table-hover table-light shadow-sm">
                <thead class="thead-light">
                  <tr>
                    <th scope="col">Date</th>
                    <th scope="col">FI</th>
                    <th scope="col">FS</th>
                    <th scope="col">Type d'action</th>
                    <th scope="col">Action</th>
                    <% if (!REQ_QUERY.filters) { %>
                    <th scope="col">Compteur</th>
                    <% } %>
                  </tr>
                </thead>
                <tbody>
                  <% stats.forEach(function(stat){ %>
                    <tr>
                      <th scope="row"><%= moment(stat.date).format('DD/MM/YYYY') %></th>
                      <td><%= stat.fi %></td>
                      <td><%= stat.fs %></td>
                      <td><%= stat.typeAction %></td>
                      <td><%= stat.action %></td>
                      <% if (!REQ_QUERY.filters) { %>
                      <td><%= stat.count %></td>
                      <% } %>
                    </tr>
                    <% }) %>
                  </tbody>
                </table>
            <% } %>
        </div>
    </div>
</div>
</body>
</html>
