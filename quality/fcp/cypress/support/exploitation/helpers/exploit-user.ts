import * as otplib from 'otplib';

import { ExploitUserData } from '../../common/types/exploit-user';

async function generateTotp(key): Promise<string> {
  return new Promise((resolve) => {
    const ttl = otplib.authenticator.timeRemaining();
    // If TOTP expires in less than 2 seconds
    // we'll wait for the next timeframe
    // in order to be sure to have a valid TOTP
    // at the time the form is submited
    const wait = ttl < 2 ? ttl + 1 : 0;

    setTimeout(() => {
      resolve(otplib.authenticator.generate(key));
    }, wait * 1000);
  });
}

export default class ExploitUser {
  public username: string;
  public password: string;
  private totpSecret: string;
  public role: string;

  constructor(userData: ExploitUserData) {
    this.username = userData.username;
    this.password = userData.password;
    this.totpSecret = userData.secretTotp;
    this.role = userData.role;
  }

  public async getTotp(): Promise<string> {
    return generateTotp(this.totpSecret);
  }
}
