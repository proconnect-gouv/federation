import { Given, Then, When } from 'cypress-cucumber-preprocessor/steps';

import {
  checkFCBasicAuthorization,
  isUsingFCBasicAuthorization,
} from '../../common/helpers';
import { Environment } from '../../common/types';
import { createUserWithType, ExploitUser } from '../helpers';
import ExploitLoginPage from '../pages/exploit-login-page';
import ExploitNavigation from '../pages/exploit-navigation';

let exploitLoginPage: ExploitLoginPage;
const exploitNavigation = new ExploitNavigation();

Given("je navigue sur la page login d'exploitation", function () {
  const env: Environment = this.env;
  exploitLoginPage = new ExploitLoginPage(env.exploitRootUrl);
  /**
   * @todo Use navigateTo instead after ticket FC-548 (integ01)
   * author: Nicolas
   * date: 28/05/2021
   *
   * suggestion: navigateTo({ appId: env.exploitAppId, baseUrl: env.allAppsUrl });
   */
  exploitLoginPage.visit();

  if (isUsingFCBasicAuthorization()) {
    checkFCBasicAuthorization();
  }
});

When('je me connecte à exploitation en tant que {string}', function (userType) {
  const exploitUser: ExploitUser = createUserWithType(userType);
  cy.wrap(exploitUser).as('exploitUser');
  exploitLoginPage.login(exploitUser);
});

When("je me déconnecte d'exploitation", function () {
  exploitNavigation.logout();
});

Then("je suis redirigé vers la page login d'exploitation", function () {
  exploitLoginPage.checkIsVisible();
});
