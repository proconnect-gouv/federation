#language: fr
@exploitation @creationModificationFI @ci @fcpHigh
Fonctionnalité: Création Modification de FI - FCP HIGH
  # En tant qu'exploitant,
  # je veux pouvoir créer et modifier des FI
  # afin que la mire de FranceConnect soit à jour

  Scénario: Création d'un FI sans discovery Url
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs d'identité
    Et que je clique sur le bouton de création de FI
    Et que j'utilise la configuration pour le fournisseur d'identité "default"
    Et que j'entre les valeurs par défaut pour mon fournisseur d'identité
    Et que j'entre "bdd-idp-without-discovery" dans le champ "name" du formulaire de création de FI
    Et que j'entre "eidas3" dans le champ "allowedAcr" du formulaire de création de FI
    Et que j'entre "RSA-OAEP-256" dans le champ "id_token_encrypted_response_alg" du formulaire de création de FI
    Et que j'entre "RSA-OAEP-256" dans le champ "userinfo_encrypted_response_alg" du formulaire de création de FI
    Et que j'entre "A256GCM" dans le champ "id_token_encrypted_response_enc" du formulaire de création de FI
    Et que j'entre "A256GCM" dans le champ "userinfo_encrypted_response_enc" du formulaire de création de FI
    Et que je valide le formulaire de création de FI
    Et que le message de confirmation de création de FI est affiché
    Et que je clique sur le bouton de modification du FI "bdd-idp-without-discovery"
    Et que j'entre "true" dans le champ "active" du formulaire de modification de FI
    Et que j'entre "true" dans le champ "display" du formulaire de modification de FI
    Et que je valide le formulaire de modification de FI
    Et que le message de confirmation de modification du FI "bdd-idp-without-discovery" est affiché
    Et que j'utilise le fournisseur de service "par défaut"
    Et que je navigue sur la page fournisseur de service
    Et que je clique sur le bouton FranceConnect
    Et que je suis redirigé vers la page sélection du fournisseur d'identité
    Et que j'utilise le dernier fournisseur d'identité créé
    Et que le fournisseur d'identité est affiché dans la mire
    Et que je clique sur le fournisseur d'identité
    Et que je suis redirigé vers la page login du fournisseur d'identité
    Et que Le fournisseur d'identité a été appelé avec le niveau de sécurité "eidas3"
    Et que je m'authentifie avec succès
    Et que je suis redirigé vers la page confirmation de connexion
    Et que je continue sur le fournisseur de service
    Alors je suis redirigé vers la page fournisseur de service
    Et je suis connecté au fournisseur de service
    Et la cinématique a utilisé le niveau de sécurité "eidas3"

  Scénario: Modification d'un FI pour rajouter une discovery Url
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs d'identité
    Et que j'utilise la configuration pour le fournisseur d'identité "defaultDiscoveryUrl"
    Et que je clique sur le bouton de modification du FI "bdd-idp-without-discovery"
    Quand j'entre "true" dans le champ "discovery" du formulaire de modification de FI
    Et j'entre "https://discovery.url.com" dans le champ "discoveryUrl" du formulaire de modification de FI
    Et je valide le formulaire de modification de FI
    Alors le message de confirmation de modification du FI "bdd-idp-without-discovery" est affiché
    Et j'utilise le fournisseur de service "par défaut"
    Et je navigue sur la page fournisseur de service
    Et je clique sur le bouton FranceConnect
    Et je suis redirigé vers la page sélection du fournisseur d'identité
    Et j'utilise le dernier fournisseur d'identité modifié
    Et le fournisseur d'identité est affiché dans la mire

  Scénario: Création d'un FI avec discovery Url
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs d'identité
    Et que je clique sur le bouton de création de FI
    Et que j'utilise la configuration pour le fournisseur d'identité "defaultDiscoveryUrl"
    Et que j'entre les valeurs par défaut pour mon fournisseur d'identité
    Et que j'entre "bdd-idp-with-discovery" dans le champ "name" du formulaire de création de FI
    Et que j'entre "true" dans le champ "discovery" du formulaire de création de FI
    Et que j'entre "https://discovery.url.fr" dans le champ "discoveryUrl" du formulaire de création de FI
    Et que j'entre "eidas2" dans le champ "allowedAcr" du formulaire de création de FI
    Et que j'entre "ECDH-ES" dans le champ "id_token_encrypted_response_alg" du formulaire de création de FI
    Et que j'entre "ECDH-ES" dans le champ "userinfo_encrypted_response_alg" du formulaire de création de FI
    Et que j'entre "A256GCM" dans le champ "id_token_encrypted_response_enc" du formulaire de création de FI
    Et que j'entre "A256GCM" dans le champ "userinfo_encrypted_response_enc" du formulaire de création de FI
    Quand je valide le formulaire de création de FI
    Et le message de confirmation de création de FI est affiché
    Et je clique sur le bouton de modification du FI "bdd-idp-with-discovery"
    Et j'entre "true" dans le champ "active" du formulaire de modification de FI
    Et j'entre "true" dans le champ "display" du formulaire de modification de FI
    Et je valide le formulaire de modification de FI
    Alors le message de confirmation de modification du FI "bdd-idp-with-discovery" est affiché
    Et j'utilise le fournisseur de service "par défaut"
    Et je navigue sur la page fournisseur de service
    Et je clique sur le bouton FranceConnect
    Et je suis redirigé vers la page sélection du fournisseur d'identité
    Et j'utilise le dernier fournisseur d'identité créé
    Et le fournisseur d'identité est affiché dans la mire

  Scénario: Modification d'un FI pour enlever une discovery Url
    Etant donné que je navigue sur la page login d'exploitation
    Et que je me connecte à exploitation en tant que "exploitant"
    Et que je navigue vers la page gestion des fournisseurs d'identité
    Et que j'utilise la configuration pour le fournisseur d'identité "defaultDiscoveryUrl"
    Et que je clique sur le bouton de modification du FI "bdd-idp-with-discovery"
    Quand j'entre "false" dans le champ "discovery" du formulaire de modification de FI
    Et j'entre "https://issuer.fr/jwks" dans le champ "jwksUrl" du formulaire de modification de FI
    Et j'entre "https://issuer.fr/auth" dans le champ "authorizationUrl" du formulaire de modification de FI
    Et j'entre "https://issuer.fr/token" dans le champ "tokenUrl" du formulaire de modification de FI
    Et j'entre "https://issuer.fr/me" dans le champ "userInfoUrl" du formulaire de modification de FI
    Et je valide le formulaire de modification de FI
    Alors le message de confirmation de modification du FI "bdd-idp-with-discovery" est affiché
    Et j'utilise le fournisseur de service "par défaut"
    Et je navigue sur la page fournisseur de service
    Et je clique sur le bouton FranceConnect
    Et je suis redirigé vers la page sélection du fournisseur d'identité
    Et j'utilise le dernier fournisseur d'identité modifié
    Et le fournisseur d'identité est affiché dans la mire

  Scénario: Créer, modifier et utiliser un FI avec algorithme de chiffrement RSA-OAEP-256
    Etant donné que je crée le fournisseur d'identité "bdd-idp-rsa-oaep-256" avec la configuration "idpRsaOaep256" sur le site d'exploitation
    Et que j'utilise le dernier fournisseur d'identité créé
    Et que je navigue sur la page fournisseur de service
    Et que je clique sur le bouton FranceConnect
    Et que je suis redirigé vers la page sélection du fournisseur d'identité
    Et que le fournisseur d'identité est affiché dans la mire
    Quand je configure le fournisseur d'identité "bdd-idp-rsa-oaep-256" invisible et actif sur le site d'exploitation
    Et je navigue sur la page fournisseur de service
    Et je clique sur le bouton FranceConnect
    Et je suis redirigé vers la page sélection du fournisseur d'identité
    Et le fournisseur d'identité n'est pas affiché dans la mire
    Et je configure le fournisseur d'identité "bdd-idp-rsa-oaep-256" visible et actif sur le site d'exploitation
    Alors je navigue sur la page fournisseur de service
    Et je clique sur le bouton FranceConnect
    Et je suis redirigé vers la page sélection du fournisseur d'identité
    Et le fournisseur d'identité est affiché dans la mire
    Et je me connecte à FranceConnect
    Et je suis connecté au fournisseur de service

  Scénario: Suppression des FI commençant par "bdd-idp-"
    Etant donné que je navigue sur la page login d'exploitation
    Et je me connecte à exploitation en tant que "exploitant"
    Quand je navigue vers la page gestion des fournisseurs d'identité
    Et je supprime les fournisseurs d'identité commençant par "bdd-idp-"
