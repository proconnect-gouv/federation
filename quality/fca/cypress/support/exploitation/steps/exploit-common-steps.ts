import { Then, When } from '@badeball/cypress-cucumber-preprocessor';

Then(
  'je suis redirigé vers la page gestion des fournisseurs de service',
  function () {
    cy.url().should('include', '/service-provider');
  },
);

When(
  'je navigue vers la page gestion des fournisseurs de service',
  function () {
    cy.get('a[data-prefix="/service-provider"]').click();
  },
);

Then('la liste des fournisseurs de service est affichée', function () {
  cy.get('.h2').contains('Gestion des fournisseurs de service');
});

When(
  "je navigue vers la page gestion des fournisseurs d'identité",
  function () {
    cy.get('a[data-prefix="/identity-provider"]').click();
  },
);

Then("la liste des fournisseurs d'identité est affichée", function () {
  cy.get('.h2').contains("Gestion des fournisseurs d'identité");
});

When(
  'je navigue vers la page gestion des fournisseurs de données',
  function () {
    cy.get('a[data-prefix="/data-provider"]').click();
  },
);

Then('la liste des fournisseurs de données est affichée', function () {
  cy.get('.h2').contains('Gestion des scopes (labels) et claims');
});

Then(
  /^je peux faire une requête authorize avec une redirect_uri "([^"]*)"$/,
  function (redirectUri: string) {
    const testEnv: string = Cypress.env('TEST_ENV');
    const url =
      testEnv === 'docker'
        ? 'https://core-fca-low.docker.dev-franceconnect.fr/api/v2/authorize'
        : 'https://fca.integ01.dev-agentconnect.fr/api/v2/authorize';

    // extract client id
    cy.get('table tbody tr')
      .first()
      .invoke('text')
      .then((text) => {
        const uuidMatch = text.match(/[0-9a-fA-F-]{36}/);

        if (!uuidMatch) {
          throw new Error('No valid client ID found in the table row');
        }

        const clientId = uuidMatch[0]; // Extracted UUID
        cy.log(`Extracted client ID: ${clientId}`);

        // Perform the authorize request using extracted clientId and given redirectUri
        cy.request({
          method: 'GET',
          qs: {
            acr_values: 'eidas1',
            claims: '{"id_token":{"amr":{"essential":true}}}',
            client_id: clientId,
            login_hint: 'test@fia1.fr',
            nonce:
              'f23f6cebd994466d1de0975d21471294fd729a2a6e5b16dbf0d6f6247a2f6917',
            redirect_uri: redirectUri,
            response_type: 'code',
            scope: 'openid given_name usual_name email',
            state:
              '00919d38c2f28fd6aa362042ee987200b8e8fee50a1a04bd34d192e40fe1186b',
          },
          url,
        }).then((response) => {
          // Log and assert response status
          cy.log(`Authorize request response: ${response.status}`);
          expect(response.status).to.eq(200);
        });
      });
  },
);
