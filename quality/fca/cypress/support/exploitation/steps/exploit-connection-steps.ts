import { Given, Then, When } from '@badeball/cypress-cucumber-preprocessor';

import { ChainableElement } from '../../common/types';
import { getOperatorUserByType, OperatorUser } from '../helpers';

function getTotpInput(): ChainableElement {
  return cy.get('input[name="_totp"]');
}

function login(user: OperatorUser): void {
  cy.get('input[name="username"]').clearThenType(user.username);
  cy.get('input[name="password"]').clearThenType(user.password, { log: false });
  getTotpInput()
    .then(() => user.wrapTotp())
    .then((totp: string) => getTotpInput().clearThenType(totp));
  cy.get('button[type="submit"]').click();
}

Given("je navigue sur la page login d'exploitation", function () {
  const { adminRootUrl } = this.env;
  cy.visit(adminRootUrl);
  cy.url().should('include', adminRootUrl);
});

When(
  'je me connecte à exploitation en tant que {string}',
  function (userType: string) {
    this.operatorUser = getOperatorUserByType(userType);
    login(this.operatorUser);
  },
);

When("je me déconnecte d'exploitation", function () {
  cy.get('.navbar-collapse > div.dropdown:nth-child(3)').click();
  cy.contains('Déconnexion').click();
});

Then("je suis redirigé vers la page login d'exploitation", function () {
  const { adminRootUrl } = this.env;

  cy.url().should('includes', `${adminRootUrl}/login`);
});
